@model IEnumerable<Project_65133141.Models.BanAn>

@{
    ViewBag.Title = "Tr·∫°ng th√°i b√†n";
    Layout = "~/Areas/Admin_65133141/Views/Shared/_Layout.cshtml";
    var groupedTables = ViewBag.GroupedTables as IEnumerable<IGrouping<string, Project_65133141.Models.BanAn>>;
    var statusFilter = ViewBag.StatusFilter as string ?? "all";
}

<div class="container-fluid px-4 py-6">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Tr·∫°ng th√°i b√†n nh√† h√†ng</h1>
            <p class="text-gray-600">Xem tr·∫°ng th√°i c√°c b√†n v√† ph√≤ng hi·ªán t·∫°i</p>
        </div>
        <div>
            <button type="button" onclick="openCreateTableModal()"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Th√™m b√†n m·ªõi
            </button>
        </div>
    </div>

    <div id="alertContainer" class="fixed top-16 right-4 z-[10000] space-y-2 max-w-md"></div>
    @Html.AntiForgeryToken()

    <!-- Status Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "Tr·ªëng" })" class="block">
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Tr·ªëng</p>
                    <p class="text-3xl font-bold text-green-600">@ViewBag.TrongCount</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        </a>

        <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "ƒê√£ ƒë·∫∑t" })" class="block">
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">ƒê√£ ƒë·∫∑t</p>
                    <p class="text-3xl font-bold text-yellow-600">@ViewBag.DaDatCount</p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        </a>

        <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "ƒêang ph·ª•c v·ª•" })" class="block">
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">ƒêang ph·ª•c v·ª•</p>
                    <p class="text-3xl font-bold text-red-600">@ViewBag.DangPhucVuCount</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        </a>

        <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "all" })" class="block">
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">T·ªïng s·ªë</p>
                    <p class="text-3xl font-bold text-blue-600">@ViewBag.TotalCount</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                </div>
            </div>
        </div>
        </a>
    </div>

    <!-- Filter -->
    <div class="mb-6">
        <div class="flex flex-wrap gap-3">
            <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "all" })" 
               class="px-4 py-2 rounded-lg transition-colors @(statusFilter == "all" ? "bg-red-600 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300")">
                T·∫•t c·∫£
            </a>
            <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "Tr·ªëng" })" 
               class="px-4 py-2 rounded-lg transition-colors @(statusFilter == "Tr·ªëng" ? "bg-green-600 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300")">
                Tr·ªëng
            </a>
            <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "ƒê√£ ƒë·∫∑t" })" 
               class="px-4 py-2 rounded-lg transition-colors @(statusFilter == "ƒê√£ ƒë·∫∑t" ? "bg-yellow-600 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300")">
                ƒê√£ ƒë·∫∑t
            </a>
            <a href="@Url.Action("Index", "BanAn", new { area = "Admin_65133141", statusFilter = "ƒêang ph·ª•c v·ª•" })" 
               class="px-4 py-2 rounded-lg transition-colors @(statusFilter == "ƒêang ph·ª•c v·ª•" ? "bg-red-600 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300")">
                ƒêang ph·ª•c v·ª•
            </a>
        </div>
    </div>

    <!-- Tables by Group -->
    @if (groupedTables != null && groupedTables.Any())
    {
        foreach (var group in groupedTables)
        {
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <span class="mr-2">üìç</span>
                    @group.Key
                    <span class="ml-3 text-lg font-normal text-gray-500">(@group.Count() b√†n/ph√≤ng)</span>
                </h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    @foreach (var table in group)
                    {
                        string statusClass = "";
                        string statusIcon = "";
                        string statusBg = "";
                        
                        switch (table.TrangThai)
                        {
                            case "Tr·ªëng":
                                statusClass = "border-green-500 bg-green-50";
                                statusIcon = "‚úì";
                                statusBg = "bg-green-500";
                                break;
                            case "ƒê√£ ƒë·∫∑t":
                                statusClass = "border-yellow-500 bg-yellow-50";
                                statusIcon = "‚è∞";
                                statusBg = "bg-yellow-500";
                                break;
                            case "ƒêang ph·ª•c v·ª•":
                                statusClass = "border-red-500 bg-red-50";
                                statusIcon = "üî¥";
                                statusBg = "bg-red-500";
                                break;
                            default:
                                statusClass = "border-gray-500 bg-gray-50";
                                statusIcon = "?";
                                statusBg = "bg-gray-500";
                                break;
                        }
                        
                        <div class="bg-white rounded-lg shadow-md border-2 @statusClass p-4 hover:shadow-lg transition-shadow cursor-pointer" onclick="openTableDetails(@table.BanID)">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg text-gray-900">@table.TenBan</h3>
                                <span class="text-2xl">@statusIcon</span>
                            </div>
                            
                            <div class="space-y-1 text-sm">
                                <div class="flex items-center text-gray-600">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span>S·ª©c ch·ª©a: @(table.SucChua ?? 0) ng∆∞·ªùi</span>
                                </div>
                            </div>
                            
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="flex items-center">
                                    <span class="w-3 h-3 rounded-full @statusBg mr-2"></span>
                                    <span class="text-sm font-semibold text-gray-700">@table.TrangThai</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center py-12 bg-white rounded-lg shadow-md">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-gray-600 text-lg">Ch∆∞a c√≥ d·ªØ li·ªáu b√†n</p>
            <p class="text-gray-500 mt-2">Vui l√≤ng t·∫°o d·ªØ li·ªáu m·∫´u t·ª´ trang qu·∫£n tr·ªã</p>
        </div>
    }
</div>

<!-- Modal th√™m b√†n m·ªõi - style gi·ªëng modal th√™m m√≥n ƒÉn -->
<div id="createTableModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 500px;">
        <button type="button" class="auth-close-btn" onclick="closeCreateTableModal()">&times;</button>

        <div class="auth-modal-header">
            <div class="auth-logo">
                <svg class="w-full h-full p-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
            </div>
            <h2 class="auth-modal-title">Th√™m b√†n m·ªõi</h2>
            <p class="auth-modal-subtitle">Th√™m b√†n ho·∫∑c ph√≤ng m·ªõi v√†o h·ªá th·ªëng</p>
        </div>

        <div class="auth-modal-body">
            @using (Html.BeginForm("Create", "BanAn", new { area = "Admin_65133141" }, FormMethod.Post, new { id = "createTableForm" }))
            {
                @Html.AntiForgeryToken()

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        T√™n b√†n <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <input type="text" name="TenBan" class="auth-form-control" placeholder="V√≠ d·ª•: B√†n 1, Ph√≤ng VIP 1" />
                    </div>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        V·ªã tr√≠
                    </label>
                    <div class="auth-input-wrapper">
                        <input type="text" name="ViTri" class="auth-form-control" placeholder="V√≠ d·ª•: T·∫ßng tr·ªát, T·∫ßng 1, Ph√≤ng VIP, Ph√≤ng ƒë√¥i" />
                    </div>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        S·ª©c ch·ª©a
                    </label>
                    <div class="auth-input-wrapper">
                        <input type="number" name="SucChua" min="1" class="auth-form-control" placeholder="S·ªë l∆∞·ª£ng ng∆∞·ªùi" />
                    </div>
                </div>

                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeCreateTableModal()">H·ªßy</button>
                    <button type="submit" class="auth-btn auth-btn-submit">Th√™m b√†n</button>
                </div>
            }
        </div>
    </div>
</div>

<!-- BanAn Details Modal -->
<div id="banAnDetailsModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 800px; padding: 0;">
        <button type="button" class="auth-close-btn" onclick="closeBanAnDetailsModal()" style="top: 15px; right: 15px; background: white; border-radius: 50%; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">&times;</button>
        
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Info Card -->
            <div class="w-full md:w-1/2 bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-6" style="min-height: 400px;">
                <div class="w-full max-w-sm">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="text-center mb-4">
                            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900" id="detailBanAnId">#000000</h3>
                            <p class="text-sm text-gray-500 mt-1">M√£ b√†n</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Tr·∫°ng th√°i</span>
                                <span id="detailBanAnStatus" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase">-</span>
                            </div>
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">S·ª©c ch·ª©a</span>
                                <span class="text-sm font-semibold text-gray-800" id="detailBanAnSucChua">-</span>
                            </div>
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Lo·∫°i b√†n</span>
                                <span class="text-sm font-semibold text-gray-800" id="detailBanAnLoaiBan">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Details -->
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-between">
                <div>
                   <!-- Header -> Title & Badges -->
                   <div class="flex items-start justify-between mb-4">
                       <div>
                           <h2 class="text-2xl font-bold text-gray-900 mb-2 leading-tight" id="detailBanAnTenBan">-</h2>
                           <div class="flex gap-2">
                               <span id="detailBanAnStatusBadge" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-bold uppercase tracking-wide">-</span>
                           </div>
                       </div>
                   </div>

                   <!-- Details Grid -->
                   <div class="grid grid-cols-1 gap-y-6 mb-8">
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">V·ªã tr√≠</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailBanAnViTri">-</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">S·ª©c ch·ª©a</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailBanAnSucChuaFull">-</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Lo·∫°i b√†n</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailBanAnLoaiBanFull">-</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Tr·∫°ng th√°i</span>
                           <select id="detailBanAnTrangThaiSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm">
                               <option value="Tr·ªëng">Tr·ªëng</option>
                               <option value="ƒê√£ ƒë·∫∑t">ƒê√£ ƒë·∫∑t</option>
                               <option value="ƒêang ph·ª•c v·ª•">ƒêang ph·ª•c v·ª•</option>
                           </select>
                       </div>
                   </div>
                </div>

                <!-- Footer Buttons -->
                <div class="flex items-center gap-3 mt-auto">
                    <button type="button" onclick="openConfirmDeleteTableModal()" class="px-4 py-2.5 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white rounded-xl font-bold text-sm transition-all shadow-md hover:shadow-lg active:shadow-md transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        X√≥a b√†n
                    </button>
                    <button type="button" id="btn-save-status" class="flex-1 px-4 py-2.5 bg-[#f97316] hover:bg-[#ea580c] active:bg-[#c2410c] text-white rounded-xl font-bold text-sm transition-all shadow-md hover:shadow-lg active:shadow-md transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        L∆∞u tr·∫°ng th√°i
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal x√°c nh·∫≠n x√≥a b√†n -->
<div id="confirmDeleteTableModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[9999] p-4" style="display: none;">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl max-w-md w-full mx-auto transform transition-all">
        <div class="p-4 sm:p-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-red-100 flex items-center justify-center">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-3 sm:ml-4 flex-1 min-w-0">
                    <h3 id="confirmDeleteTableTitle" class="text-base sm:text-lg font-bold text-gray-900">X√≥a b√†n</h3>
                    <p id="confirmDeleteTableMessage" class="mt-2 text-sm text-gray-600 break-words">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†n n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 rounded-b-xl sm:rounded-b-2xl flex flex-col-reverse sm:flex-row justify-end gap-2 sm:gap-3">
            <button type="button" id="cancelDeleteTableBtn" class="px-4 sm:px-5 py-2 sm:py-2.5 bg-white hover:bg-gray-100 active:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm border border-gray-300 shadow-sm hover:shadow-md active:shadow-sm transition-all transform hover:scale-105 active:scale-95 w-full sm:w-auto">H·ªßy</button>
            <button type="button" id="confirmDeleteTableBtn" class="px-4 sm:px-5 py-2 sm:py-2.5 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white rounded-lg font-semibold text-sm shadow-md hover:shadow-lg active:shadow-md transition-all transform hover:scale-105 active:scale-95 w-full sm:w-auto">X√≥a</button>
        </div>
    </div>
</div>

<script>
    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

    function openCreateTableModal() {
        var modal = document.getElementById('createTableModal');
        if (!modal) return;

        var form = document.getElementById('createTableForm');
        if (form) {
            form.reset();
        }

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeCreateTableModal() {
        var modal = document.getElementById('createTableModal');
        if (!modal) return;

        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function showAlert(type, message) {
        var container = document.getElementById('alertContainer');
        if (!container) return;

        var alertId = 'alert-' + Date.now();

        var config = {
            success: {
                bg: 'bg-green-100 border border-green-200 text-green-900',
                iconBg: 'bg-green-500 text-white',
                title: 'Th√†nh c√¥ng!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
            },
            error: {
                bg: 'bg-red-100 border border-red-200 text-red-900',
                iconBg: 'bg-red-500 text-white',
                title: 'L·ªói!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14"></path><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
            },
            warning: {
                bg: 'bg-amber-100 border border-amber-200 text-amber-900',
                iconBg: 'bg-amber-500 text-white',
                title: 'C·∫£nh b√°o!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 3h.01M10.29 4.21l-6.6 11.45A1 1 0 004.53 18h14.94a1 1 0 00.86-1.5l-6.6-11.45a1 1 0 00-1.74 0z"/></svg>'
            },
            info: {
                bg: 'bg-sky-100 border border-sky-200 text-sky-900',
                iconBg: 'bg-sky-500 text-white',
                title: 'Th√¥ng tin',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01" /><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
            }
        };

        var cfg = config[type] || config.info;

        var html = `
        <div id="${alertId}" class="${cfg.bg} px-3 py-2 rounded-lg shadow-md flex items-center gap-2 max-w-md transition-all duration-300 translate-x-full bg-opacity-95 border border-white/60">
            <div class="w-7 h-7 rounded-full ${cfg.iconBg} flex items-center justify-center flex-shrink-0">
                ${cfg.icon}
            </div>
            <div class="flex-1">
                <div class="font-semibold text-sm mb-0.5">${cfg.title}</div>
                <div class="text-sm leading-snug">${message}</div>
            </div>
            <button type="button" class="ml-2 text-current/70 hover:text-current" aria-label="ƒê√≥ng th√¥ng b√°o"
                    onclick="(function(){ var el = document.getElementById('${alertId}'); if(el){ el.classList.add('translate-x-full'); setTimeout(function(){ el.remove(); }, 250); } })()">
                &#10005;
            </button>
        </div>`;

        container.insertAdjacentHTML('beforeend', html);

        setTimeout(function () {
            var el = document.getElementById(alertId);
            if (el) el.classList.remove('translate-x-full');
        }, 10);

        setTimeout(function () {
            var el = document.getElementById(alertId);
            if (el) {
                el.classList.add('translate-x-full');
                setTimeout(function () { el.remove(); }, 250);
            }
        }, 4000);
    }

    var currentTableId = null;

    function openTableDetails(id) {
        currentTableId = id;
        const modal = document.getElementById('banAnDetailsModal');
        
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Reset and Load
        document.getElementById('detailBanAnTenBan').textContent = 'ƒêang t·∫£i...';

        fetch('@Url.Action("GetTable", "BanAn", new { area = "Admin_65133141" })' + '?id=' + encodeURIComponent(id), {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        })
            .then(function (res) {
                if (!res.ok) {
                    throw new Error('Server error: ' + res.status);
                }
                return res.json();
            })
            .then(function (data) {
                if (!data || !data.success) {
                    if (typeof showAlert === 'function') {
                        showAlert('error', (data && data.message) || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin b√†n.');
                    }
                    closeBanAnDetailsModal();
                    return;
                }

                populateBanAnDetails(data.data || {});
            })
            .catch(function (err) {
                console.error('Get table error', err);
                if (typeof showAlert === 'function') {
                    showAlert('error', 'L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
                }
                closeBanAnDetailsModal();
            });
    }

    function populateBanAnDetails(table) {
        // ID Formatting (#000000)
        document.getElementById('detailBanAnId').textContent = '#' + (table.BanID || 0).toString().padStart(6, '0');
        
        document.getElementById('detailBanAnTenBan').textContent = table.TenBan || 'N/A';
        document.getElementById('detailBanAnViTri').textContent = table.ViTri || 'N/A';
        document.getElementById('detailBanAnSucChua').textContent = (table.SucChua || 0) + ' ng∆∞·ªùi';
        document.getElementById('detailBanAnSucChuaFull').textContent = (table.SucChua || 0) + ' ng∆∞·ªùi';
        document.getElementById('detailBanAnLoaiBan').textContent = table.LoaiBan || 'N/A';
        document.getElementById('detailBanAnLoaiBanFull').textContent = table.LoaiBan || 'N/A';
        
        // Status Logic
        const statusEl = document.getElementById('detailBanAnStatus');
        const statusBadge = document.getElementById('detailBanAnStatusBadge');
        const statusSelect = document.getElementById('detailBanAnTrangThaiSelect');
        let statusText = table.TrangThai || 'Tr·ªëng';
        
        statusEl.textContent = statusText;
        statusBadge.textContent = statusText;
        if (statusSelect) {
            statusSelect.value = statusText;
        }
        
        // Status classes
        let statusClasses = 'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ';
        if (statusText === 'Tr·ªëng') {
            statusClasses += 'bg-green-100 text-green-700';
        } else if (statusText === 'ƒê√£ ƒë·∫∑t') {
            statusClasses += 'bg-yellow-100 text-yellow-700';
        } else if (statusText === 'ƒêang ph·ª•c v·ª•') {
            statusClasses += 'bg-red-100 text-red-700';
        } else {
            statusClasses += 'bg-gray-100 text-gray-700';
        }
        statusEl.className = statusClasses;
        statusBadge.className = statusClasses;
    }

    function closeBanAnDetailsModal() {
        const modal = document.getElementById('banAnDetailsModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Close on ESC
    document.addEventListener('keydown', function(e) {
        if(e.key === 'Escape') {
            const modal = document.getElementById('banAnDetailsModal');
            if(modal && modal.style.display === 'flex') {
                closeBanAnDetailsModal();
            }
        }
    });

    document.addEventListener('click', function(e) {
        const modal = document.getElementById('banAnDetailsModal');
        if(modal && e.target === modal) {
            closeBanAnDetailsModal();
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        var saveBtn = document.getElementById('btn-save-status');
        if (!saveBtn) return;

        saveBtn.addEventListener('click', function () {
            if (!currentTableId) {
                if (typeof showAlert === 'function') {
                    showAlert('error', 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†n c·∫ßn c·∫≠p nh·∫≠t.');
                }
                return;
            }

            var statusSelect = document.getElementById('detailBanAnTrangThaiSelect');
            var newStatus = statusSelect ? statusSelect.value : '';

            var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            var token = tokenInput ? tokenInput.value : '';

            fetch('@Url.Action("UpdateStatus", "BanAn", new { area = "Admin_65133141" })', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: '__RequestVerificationToken=' + encodeURIComponent(token)
                    + '&id=' + encodeURIComponent(currentTableId)
                    + '&trangThai=' + encodeURIComponent(newStatus)
            })
                .then(function (res) { return res.json(); })
                .then(function (data) {
                    if (!data || !data.success) {
                        if (typeof showAlert === 'function') {
                            showAlert('error', (data && data.message) || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i b√†n.');
                        }
                        return;
                    }

                    if (typeof showAlert === 'function') {
                        showAlert('success', data.message || 'C·∫≠p nh·∫≠t tr·∫°ng th√°i b√†n th√†nh c√¥ng.');
                    }
                    closeBanAnDetailsModal();

                    // Refresh page to c·∫≠p nh·∫≠t s·ªë li·ªáu v√† m√†u th·∫ª
                    setTimeout(function () { window.location.reload(); }, 600);
                })
                .catch(function (err) {
                    console.error('Update status error', err);
                    if (typeof showAlert === 'function') {
                        showAlert('error', 'L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
                    }
                });
        });

        var cancelDeleteTableBtn = document.getElementById('cancelDeleteTableBtn');
        var confirmDeleteTableBtn = document.getElementById('confirmDeleteTableBtn');

        if (cancelDeleteTableBtn) {
            cancelDeleteTableBtn.onclick = closeConfirmDeleteTableModal;
        }

        if (confirmDeleteTableBtn) {
            confirmDeleteTableBtn.onclick = function () {
                if (currentTableId) {
                    performDeleteTable(currentTableId);
                } else {
                    closeConfirmDeleteTableModal();
                }
            };
        }
    });

    (function () {
        var success = '@(TempData["SuccessMessage"] as string ?? "")';
        if (success && success.length > 0) {
            setTimeout(function () {
                showAlert('success', success);
            }, 200);
        }
    })();

    function openConfirmDeleteTableModal() {
        if (!currentTableId) {
            if (typeof showAlert === 'function') {
                showAlert('error', 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†n c·∫ßn x√≥a.');
            }
            return;
        }

        var modal = document.getElementById('confirmDeleteTableModal');
        var titleEl = document.getElementById('confirmDeleteTableTitle');
        var msgEl = document.getElementById('confirmDeleteTableMessage');
        // L·∫•y t√™n b√†n t·ª´ modal details
        var nameText = document.getElementById('detailBanAnTenBan') ? document.getElementById('detailBanAnTenBan').textContent : '';

        if (titleEl) titleEl.textContent = 'X√≥a b√†n';
        if (msgEl) {
            var displayName = (nameText && nameText.trim() && nameText.trim() !== '-') ? nameText.trim() : ('b√†n #' + currentTableId);
            msgEl.textContent = 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a "' + displayName + '" kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.';
        }

        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeConfirmDeleteTableModal() {
        var modal = document.getElementById('confirmDeleteTableModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function performDeleteTable(id) {
        var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        var token = tokenInput ? tokenInput.value : '';

        fetch('@Url.Action("Delete", "BanAn", new { area = "Admin_65133141" })', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: '__RequestVerificationToken=' + encodeURIComponent(token) + '&id=' + encodeURIComponent(id),
            credentials: 'same-origin'
        })
            .then(function (res) {
                var contentType = res.headers.get('content-type') || '';
                if (!res.ok) {
                    return res.text().then(function () { throw new Error('Server error ' + res.status); });
                }
                if (contentType.indexOf('application/json') !== -1) {
                    return res.json();
                }
                return res.text().then(function () { throw new Error('Invalid response format'); });
            })
            .then(function (data) {
                if (data && data.success) {
                    showAlert('success', data.message || 'X√≥a b√†n th√†nh c√¥ng!');
                    setTimeout(function () { window.location.reload(); }, 800);
                } else {
                    showAlert('error', (data && data.message) || 'Kh√¥ng th·ªÉ x√≥a b√†n.');
                }
            })
            .catch(function (err) {
                console.error('Delete table error', err);
                showAlert('error', 'L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
            })
            .finally(function () {
                closeConfirmDeleteTableModal();
                closeBanAnDetailsModal();
            });
    }
</script>
