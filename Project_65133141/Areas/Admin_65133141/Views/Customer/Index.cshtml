@model IEnumerable<Project_65133141.Models.User>

@{
    ViewBag.Title = "Quản lý khách hàng";
    Layout = "~/Areas/Admin_65133141/Views/Shared/_Layout.cshtml";

    var viewType = ViewBag.ViewType ?? "table";
    var searchString = ViewBag.SearchString as string;
    var statusFilter = ViewBag.StatusFilter as string;
    var sortBy = ViewBag.SortBy as string;
}

<div class="container mx-auto px-4 py-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Quản lý tài khoản khách hàng</h1>
    </div>

    <div class="mb-4 text-gray-600">
        <p>Tổng số: <span class="font-semibold text-gray-900">@ViewBag.TotalAccounts</span> khách hàng</p>
    </div>

    <div class="mb-6 flex justify-end">
        @using (Html.BeginForm("Index", "Customer", FormMethod.Get, new { id = "customerFilterForm", @class = "flex flex-wrap items-end gap-3 justify-end w-full" }))
        {
            <input type="hidden" name="viewType" value="@viewType" />
            <input type="hidden" id="statusFilterInput" name="statusFilter" value="@statusFilter" />
            <input type="hidden" id="sortByInput" name="sortBy" value="@sortBy" />

            <div class="flex items-end gap-2 mr-2">
                <div class="relative">
                    <button type="button" id="filterToggleBtn" onclick="toggleFilterPanel()" class="inline-flex items-center justify-center w-10 h-10 bg-white border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all" title="Lọc">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                    </button>
                    <div id="filterPanel" class="hidden absolute right-0 mt-2 w-52 bg-white border border-gray-200 rounded-lg shadow-xl z-20">
                        <div class="py-2">
                            <p class="px-4 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wide">Trạng thái</p>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm @(string.IsNullOrEmpty(statusFilter) ? "bg-gray-100 font-semibold" : "hover:bg-gray-50")" onclick="applyStatusFilter('')">Tất cả</button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm @(statusFilter == "Hoạt động" ? "bg-gray-100 font-semibold" : "hover:bg-gray-50")" onclick="applyStatusFilter('Hoạt động')">Hoạt động</button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm @(statusFilter == "Vô hiệu hóa" ? "bg-gray-100 font-semibold" : "hover:bg-gray-50")" onclick="applyStatusFilter('Vô hiệu hóa')">Vô hiệu hóa</button>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <button type="button" id="sortToggleBtn" onclick="toggleSortPanel()" class="inline-flex items-center justify-center w-10 h-10 bg-white border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all" title="Sắp xếp">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                        </svg>
                    </button>
                    <div id="sortPanel" class="hidden absolute right-0 mt-2 w-52 bg-white border border-gray-200 rounded-lg shadow-xl z-20">
                        <div class="py-2">
                            <p class="px-4 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wide">Sắp xếp theo</p>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm @(sortBy == "code" ? "bg-gray-100 font-semibold" : "hover:bg-gray-50")" onclick="applySort('code')">Mã khách hàng</button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm @(sortBy == "name" ? "bg-gray-100 font-semibold" : "hover:bg-gray-50")" onclick="applySort('name')">Tên khách hàng</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-auto md:min-w-[300px] max-w-md relative" style="position: relative;">
                <div class="flex items-stretch relative" style="width: 100% !important; box-sizing: border-box !important;">
                    <input type="text" id="searchInput" name="searchString" value="@searchString"
                           placeholder="Nhập tên, email hoặc SĐT..." autocomplete="off"
                           class="flex-1 pl-10 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none" style="border-radius: 0.5rem; width: 100% !important; box-sizing: border-box !important;" />
                    <!-- Search Icon -->
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <!-- Loading Indicator -->
                    <div id="searchLoading" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2">
                        <svg class="animate-spin h-4 w-4 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <!-- Suggestions Dropdown -->
                <div id="searchSuggestions" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-20 max-h-60 overflow-y-auto" style="width: 100% !important; box-sizing: border-box !important;"></div>
            </div>
        }
    </div>

    <div class="flex justify-end mb-4">
        <div class="flex bg-gray-100 rounded-lg p-1">
            <a href="@Url.Action("Index", "Customer", new { area = "Admin_65133141", viewType = "table", searchString = searchString, statusFilter = statusFilter, sortBy = ViewBag.SortBy, page = 1 })"
               class="px-4 py-2 rounded-md transition-all @(viewType == "table" ? "bg-white shadow-sm text-red-600" : "text-gray-600 hover:text-gray-900")"
               title="Xem dạng bảng">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
            </a>
            <a href="@Url.Action("Index", "Customer", new { area = "Admin_65133141", viewType = "card", searchString = searchString, statusFilter = statusFilter, sortBy = ViewBag.SortBy, page = 1 })"
               class="px-4 py-2 rounded-md transition-all @(viewType == "card" ? "bg-white shadow-sm text-red-600" : "text-gray-600 hover:text-gray-900")"
               title="Xem dạng thẻ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                </svg>
            </a>
        </div>
    </div>

    <!-- Customer List Container (Updates via AJAX) -->
    <div id="customer-list-container">
        @Html.Partial("_CustomerList", Model)
    </div>
</div>

@Html.AntiForgeryToken()

@* Modal xác nhận *@
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[9999]" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all" id="modalContent">
        <div class="p-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div id="modalIconWrapper" class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                        <svg id="modalIconSvg" class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-4 flex-1">
                    <h3 id="modalTitle" class="text-lg font-bold text-gray-900">Thông báo</h3>
                    <p id="modalMessage" class="mt-2 text-sm text-gray-600">Xác nhận thao tác?</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex justify-end gap-3">
            <button type="button" id="cancelBtn" class="px-5 py-2.5 bg-white hover:bg-gray-100 text-gray-700 rounded-lg font-semibold text-sm border border-gray-300">Hủy</button>
            <button type="button" id="confirmBtn" class="px-5 py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold text-sm">Xác nhận</button>
        </div>
    </div>
</div>

@* Include Customer Details Modal Component *@
@Html.Partial("~/Areas/Admin_65133141/Views/Components/_CustomerDetailsModal.cshtml")

<div id="alertContainer" class="fixed top-4 right-4 z-[60] space-y-2"></div>

<script>
    var currentCustomerId = null;
    var currentStatus = null;
    var currentButton = null;

    // --- Search & Autocomplete ---
    const searchInput = document.getElementById('searchInput');
    const suggestionsBox = document.getElementById('searchSuggestions');
    const searchLoading = document.getElementById('searchLoading');
    const filterForm = document.getElementById('customerFilterForm');
    const customerListContainer = document.getElementById('customer-list-container');
    let searchDebounceTimer;
    let suggestionsDebounceTimer;

    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const term = e.target.value.trim();

            // Clear existing timers
            clearTimeout(searchDebounceTimer);
            clearTimeout(suggestionsDebounceTimer);

            // 1. Live Search (Update Table)
            if (searchLoading) searchLoading.classList.remove('hidden');
            searchDebounceTimer = setTimeout(() => {
                performLiveSearch(term);
            }, 300);

            // 2. Suggestions (Autocomplete)
            if (term.length >= 1) {
                suggestionsDebounceTimer = setTimeout(() => {
                    fetchSuggestions(term);
                }, 200);
            } else {
                if (suggestionsBox) suggestionsBox.classList.add('hidden');
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (suggestionsBox && !suggestionsBox.contains(e.target) && e.target !== searchInput) {
                suggestionsBox.classList.add('hidden');
            }
        });
        
        // Focus on input shows suggestions if term exists
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 1 && suggestionsBox && suggestionsBox.children.length > 0) {
                suggestionsBox.classList.remove('hidden');
            }
        });
    }

    function performLiveSearch(term) {
        // Collect form data (including viewType, sortBy etc.)
        const formData = new FormData(filterForm);
        // Ensure searchString is updated from input (if form wasn't updated yet)
        formData.set('searchString', term);
        
        const params = new URLSearchParams(formData);

        fetch('@Url.Action("Index", "Customer", new { area = "Admin_65133141" })?' + params.toString(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            if (customerListContainer) {
                customerListContainer.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error updating customer list:', error);
        })
        .finally(() => {
                if (searchLoading) searchLoading.classList.add('hidden');
        });
    }

    function fetchSuggestions(term) {
        fetch('@Url.Action("GetSearchSuggestions", "Customer", new { area = "Admin_65133141" })?term=' + encodeURIComponent(term))
            .then(res => res.json())
            .then(data => {
                if (!suggestionsBox) return;
                
                if (data.length === 0) {
                    suggestionsBox.classList.add('hidden');
                    return;
                }

                let html = '';
                data.forEach(item => {
                    html += `
                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 transition-colors" onclick="selectSuggestion('${item.value}')">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">
                                ${item.avatar || '?'}
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-gray-900">${item.label}</div>
                                <div class="text-xs text-gray-500">${item.desc || ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                suggestionsBox.innerHTML = html;
                suggestionsBox.classList.remove('hidden');
            })
            .catch(err => console.error('Error fetching suggestions:', err));
    }

    function selectSuggestion(value) {
        if (searchInput) {
            searchInput.value = value;
            suggestionsBox.classList.add('hidden');
            // Trigger search immediately
            performLiveSearch(value);
        }
    }

    function toggleFilterPanel() {
        var panel = document.getElementById('filterPanel');
        if (!panel) return;
        panel.classList.toggle('hidden');
    }
    
    function toggleSortPanel() {
        var panel = document.getElementById('sortPanel');
        if (!panel) return;
        panel.classList.toggle('hidden');
    }

    document.addEventListener('click', function (e) {
        var filterPanel = document.getElementById('filterPanel');
        var filterToggleBtn = document.getElementById('filterToggleBtn');
        var sortPanel = document.getElementById('sortPanel');
        var sortToggleBtn = document.getElementById('sortToggleBtn');

        // Đóng panel lọc nếu click ra ngoài
        if (filterPanel && filterToggleBtn && !filterPanel.classList.contains('hidden')) {
            if (!filterPanel.contains(e.target) && !filterToggleBtn.contains(e.target)) {
                filterPanel.classList.add('hidden');
            }
        }

        // Đóng panel sắp xếp nếu click ra ngoài
        if (sortPanel && sortToggleBtn && !sortPanel.classList.contains('hidden')) {
            if (!sortPanel.contains(e.target) && !sortToggleBtn.contains(e.target)) {
                sortPanel.classList.add('hidden');
            }
        }
    });

    function applyStatusFilter(value) {
        var form = document.getElementById('customerFilterForm');
        var input = document.getElementById('statusFilterInput');
        if (!form || !input) return;
        input.value = value;
        // Also trigger live search instead of full submit if desired, but form.submit() is safer for filters that might reset paging
        form.submit();
    }

    function applySort(value) {
        var form = document.getElementById('customerFilterForm');
        var input = document.getElementById('sortByInput');
        if (!form || !input) return;
        input.value = value;
        form.submit();
    }

    function toggleStatus(button, customerId, customerName) {
        var status = button.getAttribute('data-status') || 'Hoạt động';
        var isActive = (status === 'Hoạt động');

        currentCustomerId = customerId;
        currentStatus = status;
        currentButton = button;

        var titleEl = document.getElementById('modalTitle');
        var messageEl = document.getElementById('modalMessage');
        var iconWrapper = document.getElementById('modalIconWrapper');
        var iconSvg = document.getElementById('modalIconSvg');
        var confirmBtn = document.getElementById('confirmBtn');

        // Cập nhật tiêu đề & nội dung
        titleEl.textContent = isActive ? 'Vô hiệu hóa tài khoản' : 'Kích hoạt tài khoản';
        messageEl.textContent = 'Bạn có chắc muốn ' + (isActive ? 'vô hiệu hóa' : 'kích hoạt') + ' tài khoản của ' + customerName + '?';

        if (isActive) {
            // Vô hiệu hóa: nền vàng nhạt, icon cảnh báo giống thiết kế
            iconWrapper.className = 'w-12 h-12 rounded-full flex items-center justify-center';
            iconWrapper.style.background = '#FEF3C7'; // vàng nhạt
            iconSvg.setAttribute('viewBox', '0 0 24 24');
            iconSvg.setAttribute('fill', 'none');
            iconSvg.removeAttribute('class');
            iconSvg.setAttribute('stroke', '#FBBF24'); // vàng đậm cho icon
            iconSvg.setAttribute('stroke-width', '2');
            iconSvg.setAttribute('width', '20');
            iconSvg.setAttribute('height', '20');
            // Tam giác cảnh báo với dấu chấm than bên trong
            iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 3h.01M10.29 4.21l-6.6 11.45A1 1 0 004.53 18h14.94a1 1 0 00.86-1.5l-6.6-11.45a1 1 0 00-1.74 0z" />';

            confirmBtn.className = 'px-5 py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold text-sm';
        } else {
            // Kích hoạt: nền xanh nhạt hơn một chút, icon tick trắng
            iconWrapper.className = 'w-12 h-12 rounded-full flex items-center justify-center';
            iconWrapper.style.background = '#A7F3D0'; // xanh lá nhạt hơn nhưng rõ hơn
            iconSvg.setAttribute('viewBox', '0 0 24 24');
            iconSvg.setAttribute('fill', 'none');
            // Cưỡng chế stroke trắng, không phụ thuộc vào currentColor
            iconSvg.removeAttribute('class');
            iconSvg.setAttribute('stroke', '#FFFFFF');
            iconSvg.setAttribute('stroke-width', '2');
            iconSvg.setAttribute('width', '20');
            iconSvg.setAttribute('height', '20');
            iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />';

            confirmBtn.className = 'px-5 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold text-sm';
        }

        document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    document.getElementById('cancelBtn').onclick = closeModal;
    document.getElementById('confirmModal').onclick = function(e) {
        if (e.target === this) closeModal();
    };

    document.getElementById('confirmBtn').onclick = function () {
        if (!currentCustomerId || !currentButton) {
            closeModal();
            return;
        }

        var btn = this;
        btn.disabled = true;
        var originalText = btn.textContent;
        btn.textContent = 'Đang xử lý...';

        var url = '/Admin_65133141/Customer/DisableUser/' + currentCustomerId;
        var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        var token = tokenInput ? tokenInput.value : '';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: '__RequestVerificationToken=' + encodeURIComponent(token)
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (!data) {
                    throw new Error('Không nhận được phản hồi từ máy chủ');
                }

                if (data.success) {
                    closeModal();
                    updateStatusUI(currentButton, data.newStatus);
                    showAlert('success', data.message || 'Cập nhật trạng thái thành công');
                } else {
                    showAlert('error', data.message || 'Không thể cập nhật trạng thái');
                }
            })
            .catch(function (error) {
                console.error('Lỗi khi gọi DisableUser:', error);
                showAlert('error', 'Đã xảy ra lỗi khi cập nhật trạng thái. Vui lòng thử lại.');
            })
            .finally(function () {
                btn.disabled = false;
                btn.textContent = originalText;
            });
    };

    function updateStatusUI(button, newStatus) {
        if (!button) return;

        var isActive = (newStatus === 'Hoạt động');
        button.setAttribute('data-status', newStatus);
        button.title = isActive ? 'Vô hiệu hóa' : 'Kích hoạt';

        // Cập nhật màu nút
        button.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
        if (isActive) {
            button.classList.add('bg-red-600', 'hover:bg-red-700');
        } else {
            button.classList.add('bg-green-600', 'hover:bg-green-700');
        }

        // Cập nhật icon trong nút
        if (isActive) {
            button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"></circle><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.93 4.93l14.14 14.14"></path></svg>';
        } else {
            button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        }

        // Tìm badge trạng thái gần nhất
        var row = button.closest('tr');
        if (row) {
            var badge = row.querySelector('span.rounded-full');
            if (badge) {
                badge.textContent = newStatus;
                badge.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                if (isActive) {
                    badge.classList.add('bg-green-100', 'text-green-800');
                } else {
                    badge.classList.add('bg-red-100', 'text-red-800');
                }
            }
            return;
        }

        // Card view: tìm card bao quanh và badge bên trong
        var card = button.closest('.bg-white.rounded-2xl.shadow-md');
        if (card) {
            var cardBadge = card.querySelector('span.rounded-full');
            if (cardBadge) {
                cardBadge.textContent = newStatus;
                cardBadge.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                if (isActive) {
                    cardBadge.classList.add('bg-green-100', 'text-green-800');
                } else {
                    cardBadge.classList.add('bg-red-100', 'text-red-800');
                }
            }
        }
    }

    function showAlert(type, message) {
        var container = document.getElementById('alertContainer');
        if (!container) return;

        var alertId = 'alert-' + Date.now();

        // Kiểu màu theo mẫu: success, error, warning, info
        var config = {
            success: {
                bg: 'bg-green-100 border border-green-200 text-green-900',
                iconBg: 'bg-green-500 text-white',
                title: 'Thành công!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
            },
            error: {
                bg: 'bg-red-100 border border-red-200 text-red-900',
                iconBg: 'bg-red-500 text-white',
                title: 'Lỗi!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14"></path><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
            },
            warning: {
                bg: 'bg-amber-100 border border-amber-200 text-amber-900',
                iconBg: 'bg-amber-500 text-white',
                title: 'Cảnh báo!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 3h.01M10.29 4.21l-6.6 11.45A1 1 0 004.53 18h14.94a1 1 0 00.86-1.5l-6.6-11.45a1 1 0 00-1.74 0z"/></svg>'
            },
            info: {
                bg: 'bg-sky-100 border border-sky-200 text-sky-900',
                iconBg: 'bg-sky-500 text-white',
                title: 'Thông tin',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01" /><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
            }
        };

        var cfg = config[type] || config.info;

        var html = `
        <div id="${alertId}" class="${cfg.bg} px-4 py-2.5 rounded-xl shadow-md flex items-center gap-3 min-w-[300px] max-w-md transition-all duration-300 translate-x-full bg-opacity-95 border border-white/60">
            <div class="w-7 h-7 rounded-full ${cfg.iconBg} flex items-center justify-center flex-shrink-0">
                ${cfg.icon}
            </div>
            <div class="flex-1">
                <div class="font-semibold text-sm mb-0.5">${cfg.title}</div>
                <div class="text-sm leading-snug">${message}</div>
            </div>
            <button type="button" class="ml-2 text-current/70 hover:text-current" aria-label="Đóng thông báo"
                    onclick="(function(){ var el = document.getElementById('${alertId}'); if(el){ el.classList.add('translate-x-full'); setTimeout(function(){ el.remove(); }, 250); } })()">
                &#10005;
            </button>
        </div>`;

        container.insertAdjacentHTML('beforeend', html);

        // Hiệu ứng trượt vào
        setTimeout(function () {
            var el = document.getElementById(alertId);
            if (el) el.classList.remove('translate-x-full');
        }, 10);

        // Tự ẩn sau 4 giây
        setTimeout(function () {
            var el = document.getElementById(alertId);
            if (el) {
                el.classList.add('translate-x-full');
                setTimeout(function () { el.remove(); }, 250);
            }
        }, 4000);
    }
    
    @if (TempData["SuccessMessage"] != null) { <text>showAlert('success', '@TempData["SuccessMessage"]');</text> }
    @if (TempData["ErrorMessage"] != null) { <text>showAlert('error', '@TempData["ErrorMessage"]');</text> }
</script>
