@model IEnumerable<Project_65133141.Models.TinTuc>
@{
    ViewBag.Title = "Quản lý Tin tức & Ưu đãi";
    Layout = "~/Areas/Admin_65133141/Views/Shared/_Layout.cshtml";
}

<style>
    .news-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
    }
    .news-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    .news-image {
        width: 100%;
        height: 160px;
        object-fit: cover;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    }
    .news-content {
        padding: 1rem;
    }
    .news-title {
        font-weight: 600;
        font-size: 1rem;
        color: #1f2937;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .news-desc {
        font-size: 0.85rem;
        color: #6b7280;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 0.75rem;
    }
    .news-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #9ca3af;
    }
    .badge-featured {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    .badge-hidden {
        background: #ef4444;
        color: white;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    .badge-active {
        background: #10b981;
        color: white;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    .action-btn {
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }
    .action-btn-edit {
        background: #f59e0b;
        color: white;
    }
    .action-btn-edit:hover {
        background: #d97706;
    }
    .action-btn-delete {
        background: #ef4444;
        color: white;
    }
    .action-btn-delete:hover {
        background: #dc2626;
    }
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: all 0.3s;
    }
    .modal-overlay.active .modal-content {
        transform: scale(1);
    }
    .modal-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #fee2e2;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fef2f2;
        border-radius: 16px 16px 0 0;
    }
    .modal-body {
        padding: 1.5rem;
    }
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #fee2e2;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        background: #fefabb;
        border-radius: 0 0 16px 16px;
        background: white;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    .form-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid #fb7185;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .form-input:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
    }
    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }
    .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        background: #d1d5db;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .toggle-switch.active {
        background: #10b981;
    }
    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s;
    }
    .toggle-switch.active::after {
        left: 22px;
    }
    .image-preview {
        width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-top: 0.5rem;
        display: none;
    }
    .image-preview.active {
        display: block;
    }
    .search-box {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    .search-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.9rem;
    }
    .search-input:focus {
        outline: none;
        border-color: #e11d48;
    }
    .btn-primary {
        background: linear-gradient(135deg, #ef4444, #be123c);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
    }
    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        border: none;
        cursor: pointer;
    }
    .btn-success {
        background: linear-gradient(135deg, #ef4444, #be123c);
        color: white;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        border: none;
        cursor: pointer;
    }
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #9ca3af;
    }
    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 1rem;
        opacity: 0.5;
        color: #fb7185;
    
    }
</style>

<div class="p-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Quản lý Tin tức & Ưu đãi</h1>
            <p class="text-gray-500 mt-1">Tổng cộng: @ViewBag.TotalItems tin tức</p>
        </div>
        <a href="@Url.Action("Create", "TinTuc", new { area = "Admin_65133141" })" class="btn-primary flex items-center gap-2 mt-4 md:mt-0">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Thêm tin tức mới
        </a>
    </div>

    <!-- Search -->
    <form method="get" class="search-box">
        <input type="text" name="search" value="@ViewBag.Search" class="search-input" placeholder="Tìm kiếm theo tiêu đề...">
        <button type="submit" class="btn-primary">Tìm kiếm</button>
    </form>

    @if (Model != null && Model.Any())
    {
        <div class="overflow-x-auto mt-4 bg-white rounded-xl shadow-sm border border-gray-100">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ảnh</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiêu đề</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mô tả ngắn</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đăng</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hiển thị</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nổi bật</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var item in Model)
                    {
                        var imagePath = !string.IsNullOrWhiteSpace(item.HinhAnh)
                            ? Url.Content("~/Images/TinTuc/" + item.HinhAnh)
                            : Url.Content("~/Images/slide09.jpg");

                        <tr>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <img src="@imagePath" alt="@item.TieuDe" class="w-16 h-10 object-cover rounded-md border border-gray-200" onerror="this.src='@Url.Content("~/Images/slide09.jpg")'" />
                            </td>
                            <td class="px-4 py-3 text-sm font-semibold text-gray-900 max-w-xs">
                                @item.TieuDe
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500 max-w-md">
                                @(string.IsNullOrWhiteSpace(item.MoTaNgan) ? "Chưa có mô tả" : item.MoTaNgan)
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap">
                                @(item.NgayDang?.ToString("dd/MM/yyyy") ?? "N/A")
                            </td>
                            <td class="px-4 py-3 text-sm">
                                @if (item.IsHienThi == true)
                                {
                                    <span class="badge-active">Hiển thị</span>
                                }
                                else
                                {
                                    <span class="badge-hidden">Ẩn</span>
                                }
                            </td>
                            <td class="px-4 py-3 text-sm">
                                @if (item.IsNoiBat == true)
                                {
                                    <span class="badge-featured">⭐ Nổi bật</span>
                                }
                            </td>
                            <td class="px-4 py-3 text-sm text-right whitespace-nowrap">
                                <a href="@Url.Action("Details", "TinTuc", new { area = "Admin_65133141", id = item.TinTucID })" class="action-btn bg-gray-100 text-gray-700 hover:bg-gray-200 mr-1">Chi tiết</a>
                                <a href="@Url.Action("Edit", "TinTuc", new { area = "Admin_65133141", id = item.TinTucID })" class="action-btn action-btn-edit mr-1">Sửa</a>
                                <a href="@Url.Action("Delete", "TinTuc", new { area = "Admin_65133141", id = item.TinTucID })" class="action-btn action-btn-delete" onclick="return confirm('Bạn có chắc muốn xóa tin tức này?');">Xóa</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        if (ViewBag.TotalPages > 1)
        {
            <div class="flex justify-center mt-8 gap-2">
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    var isActive = i == ViewBag.CurrentPage;
                    <a href="@Url.Action("Index", new { page = i, search = ViewBag.Search })"
                       class="px-4 py-2 rounded-lg @(isActive ? "bg-rose-600 text-white" : "bg-gray-100 text-gray-700 hover:bg-gray-200") transition-all">
                        @i
                    </a>
                }
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mx-auto">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Chưa có tin tức nào</h3>
            <p>Bấm nút "Thêm tin tức mới" để bắt đầu</p>
        </div>
    }
</div>
        
        // Reset toggles
        document.getElementById('toggleHienThi').classList.add('active');
        document.getElementById('hienThiLabel').textContent = 'Có';
        document.getElementById('isHienThi').value = 'true';
        
        document.getElementById('toggleNoiBat').classList.remove('active');
        document.getElementById('noiBatLabel').textContent = 'Không';
        document.getElementById('isNoiBat').value = 'false';
        
        document.getElementById('newsModal').classList.add('active');
    }

    function openEditModal(id) {
        isEditMode = true;
        document.getElementById('modalTitle').textContent = 'Chỉnh sửa tin tức';
        document.getElementById('submitBtn').textContent = 'Cập nhật';
        
        fetch('@Url.Action("GetDetails")' + '?id=' + id)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const item = data.data;
                    document.getElementById('tinTucId').value = item.TinTucID;
                    document.getElementById('tieuDe').value = item.TieuDe || '';
                    document.getElementById('moTaNgan').value = item.MoTaNgan || '';
                    document.getElementById('noiDung').value = item.NoiDung || '';
                    
                    // Set image preview
                    if (item.HinhAnh) {
                        document.getElementById('imagePreview').src = '/Images/TinTuc/' + item.HinhAnh;
                        document.getElementById('imagePreview').classList.add('active');
                    } else {
                        document.getElementById('imagePreview').classList.remove('active');
                    }
                    
                    // Set toggles
                    const toggleHienThi = document.getElementById('toggleHienThi');
                    const toggleNoiBat = document.getElementById('toggleNoiBat');
                    
                    if (item.IsHienThi) {
                        toggleHienThi.classList.add('active');
                        document.getElementById('hienThiLabel').textContent = 'Có';
                        document.getElementById('isHienThi').value = 'true';
                    } else {
                        toggleHienThi.classList.remove('active');
                        document.getElementById('hienThiLabel').textContent = 'Không';
                        document.getElementById('isHienThi').value = 'false';
                    }
                    
                    if (item.IsNoiBat) {
                        toggleNoiBat.classList.add('active');
                        document.getElementById('noiBatLabel').textContent = 'Có';
                        document.getElementById('isNoiBat').value = 'true';
                    } else {
                        toggleNoiBat.classList.remove('active');
                        document.getElementById('noiBatLabel').textContent = 'Không';
                        document.getElementById('isNoiBat').value = 'false';
                    }
                    
                    document.getElementById('newsModal').classList.add('active');
                } else {
                    alert(data.message);
                }
            });
    }

    function closeNewsModal() {
        document.getElementById('newsModal').classList.remove('active');
    }

    function closeModal(e) {
        if (e.target.classList.contains('modal-overlay')) {
            closeNewsModal();
        }
    }

    function toggleSwitch(element, inputId) {
        element.classList.toggle('active');
        const isActive = element.classList.contains('active');
        document.getElementById(inputId).value = isActive ? 'true' : 'false';
        
        // Update label
        const labelId = inputId === 'isHienThi' ? 'hienThiLabel' : 'noiBatLabel';
        document.getElementById(labelId).textContent = isActive ? 'Có' : 'Không';
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.add('active');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Form submit
    document.getElementById('newsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const url = isEditMode ? '@Url.Action("Edit")' : '@Url.Action("Create")';
        
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        });
    });

    // Delete functions
    function confirmDelete(id, title) {
        deleteId = id;
        document.getElementById('deleteTitle').textContent = title;
        document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
    }

    function executeDelete() {
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        fetch('@Url.Action("Delete")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'id=' + deleteId + '&__RequestVerificationToken=' + encodeURIComponent(token)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }
</script>
