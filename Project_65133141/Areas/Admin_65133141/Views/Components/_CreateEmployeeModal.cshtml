@* Create Employee Modal Component *@
@using Project_65133141.Models

<!-- Create Employee Modal -->
<div id="createEmployeeModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 700px;">
        <button type="button" class="auth-close-btn" onclick="closeCreateEmployeeModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <svg class="w-full h-full p-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </div>
            <h2 class="auth-modal-title">Thêm nhân viên mới</h2>
            <p class="auth-modal-subtitle">Điền thông tin để tạo nhân viên mới</p>
        </div>

        <div class="auth-modal-body">
            <form id="createEmployeeForm" novalidate>
                @Html.AntiForgeryToken()
                
                <!-- Row 1: FullName and Email -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Họ tên <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="text" name="FullName" id="createFullName" class="auth-form-control" autocomplete="name" />
                        </div>
                        <span class="auth-error-message" id="error-create-FullName"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Email <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="email" name="Email" id="createEmail" class="auth-form-control" autocomplete="email" />
                        </div>
                        <span class="auth-error-message" id="error-create-Email"></span>
                    </div>
                </div>

                <!-- Row 2: PhoneNumber and Address -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Số điện thoại <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="tel" name="PhoneNumber" id="createPhoneNumber" class="auth-form-control" autocomplete="tel" />
                        </div>
                        <span class="auth-error-message" id="error-create-PhoneNumber"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Địa chỉ
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="text" name="Address" id="createAddress" class="auth-form-control" autocomplete="street-address" />
                        </div>
                        <span class="auth-error-message" id="error-create-Address"></span>
                    </div>
                </div>

                <!-- Row 3: DateOfBirth and StartDate -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Ngày sinh <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="date" name="DateOfBirth" id="createDateOfBirth" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-create-DateOfBirth"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Ngày vào làm <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="date" name="StartDate" id="createStartDate" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-create-StartDate"></span>
                    </div>
                </div>

                <!-- Row 4: Password and ConfirmPassword -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="password" name="Password" id="createPassword" class="auth-form-control" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" id="error-create-Password"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Xác nhận mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="password" name="ConfirmPassword" id="createConfirmPassword" class="auth-form-control" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" id="error-create-ConfirmPassword"></span>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeCreateEmployeeModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit" id="createEmployeeSubmitBtn">Tạo nhân viên</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Expose functions globally
    window.openCreateEmployeeModal = function() {
        const modal = document.getElementById('createEmployeeModal');
        if (!modal) {
            console.error('Create employee modal not found');
            return;
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Reset form
        const form = document.getElementById('createEmployeeForm');
        if (form) {
            form.reset();
            document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');
        }
    };

    window.closeCreateEmployeeModal = function() {
        const modal = document.getElementById('createEmployeeModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    };

    // Validation functions
    function validateFullName(value) {
        if (!value || value.trim() === '') {
            return 'Vui lòng nhập họ tên';
        }
        // Only Vietnamese letters and spaces (no numbers or special characters)
        const nameRegex = /^[a-zA-ZÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s]+$/;
        if (!nameRegex.test(value.trim())) {
            return 'Họ tên chỉ được chứa chữ cái';
        }
        return null;
    }

    function validatePhoneNumber(value) {
        if (!value || value.trim() === '') {
            return 'Vui lòng nhập số điện thoại';
        }
        // Exactly 10 digits
        const phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test(value.trim())) {
            return 'Số điện thoại phải có đúng 10 chữ số';
        }
        return null;
    }

    function validateEmail(value) {
        if (!value || value.trim() === '') {
            return 'Vui lòng nhập email';
        }
        // Standard email format - only alphanumeric, dot, hyphen, underscore before @@, and standard domain after
        const emailRegex = /^[a-zA-Z0-9._-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(value.trim())) {
            return 'Email không hợp lệ (chỉ cho phép chữ, số, dấu chấm, gạch ngang, gạch dưới và @@)';
        }
        return null;
    }

    function validateAddress(value) {
        // Address is optional
        if (!value || value.trim() === '') {
            return null;
        }
        // Letters, numbers, and only allowed special characters: , . / -
        const addressRegex = /^[a-zA-Z0-9ÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s,.\/-]+$/;
        if (!addressRegex.test(value.trim())) {
            return 'Địa chỉ chỉ được chứa chữ, số và các ký tự: , . / -';
        }
        return null;
    }

    // Handle form submission
    (function initCreateEmployeeForm() {
        const form = document.getElementById('createEmployeeForm');
        if (!form) {
            // Retry if form not found yet
            setTimeout(initCreateEmployeeForm, 100);
            return;
        }

        // Real-time validation
        const fullNameInput = document.getElementById('createFullName');
        const phoneNumberInput = document.getElementById('createPhoneNumber');
        const emailInput = document.getElementById('createEmail');
        const addressInput = document.getElementById('createAddress');

        if (fullNameInput) {
            fullNameInput.addEventListener('input', function(e) {
                const error = validateFullName(e.target.value);
                const errorEl = document.getElementById('error-create-FullName');
                if (errorEl) {
                    errorEl.textContent = error || '';
                    errorEl.style.display = error ? 'block' : 'none';
                }
            });

            // Prevent non-letter characters from being typed
            fullNameInput.addEventListener('keypress', function(e) {
                // Use e.key to check the character directly
                const nameRegex = /^[a-zA-ZÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s]$/;
                if (!nameRegex.test(e.key)) {
                    e.preventDefault();
                }
            });
        }

        if (phoneNumberInput) {
            phoneNumberInput.addEventListener('input', function(e) {
                const error = validatePhoneNumber(e.target.value);
                const errorEl = document.getElementById('error-create-PhoneNumber');
                if (errorEl) {
                    errorEl.textContent = error || '';
                    errorEl.style.display = error ? 'block' : 'none';
                }
            });

            // Prevent non-digit characters and limit to 10 digits
            // Prevent non-digit characters and limit to 10 digits
            phoneNumberInput.addEventListener('keypress', function(e) {
                if (!/^[0-9]$/.test(e.key)) {
                    e.preventDefault();
                }
            });

            phoneNumberInput.addEventListener('input', function(e) {
                if (e.target.value.length > 10) {
                    e.target.value = e.target.value.slice(0, 10);
                }
            });
        }

        if (emailInput) {
            // Prevent invalid characters in email
            // Prevent invalid characters in email
            emailInput.addEventListener('keypress', function(e) {
                // Allow letters, numbers, dot, underscore, hyphen, and at sign
                const emailAllowedRegex = /^[a-zA-Z0-9.\-_\x40]$/;
                if (!emailAllowedRegex.test(e.key)) {
                    e.preventDefault();
                }
            });

            emailInput.addEventListener('blur', function(e) {
                const error = validateEmail(e.target.value);
                const errorEl = document.getElementById('error-create-Email');
                if (errorEl) {
                    errorEl.textContent = error || '';
                    errorEl.style.display = error ? 'block' : 'none';
                }
            });
        }

        // Helper to enforce year limit on date inputs
        function enforceYearLimit(inputElement) {
            inputElement.setAttribute('max', '9999-12-31');
            inputElement.addEventListener('input', function(e) {
                const value = e.target.value;
                if (value) {
                    const dateParts = value.split('-');
                    if (dateParts.length > 0 && dateParts[0].length > 4) {
                        // If year is more than 4 digits, slice it
                        dateParts[0] = dateParts[0].slice(0, 4);
                        e.target.value = dateParts.join('-');
                    }
                }
            });
        }

        const dobInput = document.getElementById('createDateOfBirth');
        const startInput = document.getElementById('createStartDate');
        if (dobInput) enforceYearLimit(dobInput);
        if (startInput) enforceYearLimit(startInput);

        if (addressInput) {
            addressInput.addEventListener('input', function(e) {
                const error = validateAddress(e.target.value);
                const errorEl = document.getElementById('error-create-Address');
                if (errorEl) {
                    errorEl.textContent = error || '';
                    errorEl.style.display = error ? 'block' : 'none';
                }
            });

            // Prevent invalid characters
            // Prevent invalid characters
            addressInput.addEventListener('keypress', function(e) {
                const addressRegex = /^[a-zA-Z0-9ÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s,.\/-]$/;
                if (!addressRegex.test(e.key)) {
                    e.preventDefault();
                }
            });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('createEmployeeSubmitBtn');
            if (!submitBtn) return;
            
            // Clear errors
            document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');

            // Validation
            let hasErrors = false;
            const errors = {};
            
            const fullName = document.getElementById('createFullName')?.value.trim() || '';
            const email = document.getElementById('createEmail')?.value.trim() || '';
            const phoneNumber = document.getElementById('createPhoneNumber')?.value.trim() || '';
            const address = document.getElementById('createAddress')?.value.trim() || '';
            const dateOfBirth = document.getElementById('createDateOfBirth')?.value || '';
            const startDate = document.getElementById('createStartDate')?.value || '';
            const password = document.getElementById('createPassword')?.value || '';
            const confirmPassword = document.getElementById('createConfirmPassword')?.value || '';

            // Validate with new validation functions
            const fullNameError = validateFullName(fullName);
            if (fullNameError) { errors['create-FullName'] = fullNameError; hasErrors = true; }

            const emailError = validateEmail(email);
            if (emailError) { errors['create-Email'] = emailError; hasErrors = true; }

            const phoneError = validatePhoneNumber(phoneNumber);
            if (phoneError) { errors['create-PhoneNumber'] = phoneError; hasErrors = true; }

            const addressError = validateAddress(address);
            if (addressError) { errors['create-Address'] = addressError; hasErrors = true; }

            // Validate Year ranges specially
            if (dateOfBirth) {
                const year = new Date(dateOfBirth).getFullYear();
                if (year > 9999 || year < 1900) {
                     errors['create-DateOfBirth'] = 'Năm sinh không hợp lệ (phải có 4 số)';
                     hasErrors = true;
                }
            } else {
                 errors['create-DateOfBirth'] = 'Vui lòng chọn ngày sinh';
                 hasErrors = true;
            }

            if (startDate) {
                const year = new Date(startDate).getFullYear();
                if (year > 9999 || year < 1900) {
                     errors['create-StartDate'] = 'Năm vào làm không hợp lệ (phải có 4 số)';
                     hasErrors = true;
                }
            } else {
                 errors['create-StartDate'] = 'Vui lòng chọn ngày vào làm';
                 hasErrors = true;
            }

            if (!password) { errors['create-Password'] = 'Vui lòng nhập mật khẩu'; hasErrors = true; }
            if (!confirmPassword) { errors['create-ConfirmPassword'] = 'Vui lòng xác nhận mật khẩu'; hasErrors = true; }
            if (password && confirmPassword && password !== confirmPassword) {
                errors['create-ConfirmPassword'] = 'Mật khẩu xác nhận không khớp';
                hasErrors = true;
            }

            if (hasErrors) {
                Object.keys(errors).forEach(key => {
                    const errorEl = document.getElementById('error-' + key);
                    if (errorEl) {
                        errorEl.textContent = errors[key];
                        errorEl.style.display = 'block';
                    }
                });
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Đang xử lý...';

            // Prepare form data - FormData automatically includes all form fields including the anti-forgery token
            const formData = new FormData(form);
            
            // Verify token exists
            const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
            if (!tokenInput || !tokenInput.value) {
                console.error('Anti-forgery token not found in form');
                if (typeof showAlert === 'function') {
                    showAlert('error', 'Lỗi bảo mật. Vui lòng tải lại trang.');
                } else {
                    alert('Lỗi bảo mật. Vui lòng tải lại trang.');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            // Submit via AJAX
            fetch('@Url.Action("CreateEmployeeAjax", "Employee", new { area = "Admin_65133141" })', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error('Server error: ' + response.status + ' - ' + text.substring(0, 100));
                    });
                }
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error('Invalid response format. Expected JSON but got: ' + text.substring(0, 100));
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    if (typeof showAlert === 'function') {
                        showAlert('success', data.message || 'Tạo nhân viên thành công!');
                    } else {
                        alert(data.message || 'Tạo nhân viên thành công!');
                    }
                    closeCreateEmployeeModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Show errors
                    if (data.errors) {
                        Object.keys(data.errors).forEach(key => {
                            const errorEl = document.getElementById('error-create-' + key);
                            if (errorEl) {
                                errorEl.textContent = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                errorEl.style.display = 'block';
                            }
                        });
                    } else {
                        if (typeof showAlert === 'function') {
                            showAlert('error', data.message || 'Có lỗi xảy ra khi tạo nhân viên');
                        } else {
                            alert(data.message || 'Có lỗi xảy ra khi tạo nhân viên');
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof showAlert === 'function') {
                    showAlert('error', error.message || 'Lỗi kết nối server. Vui lòng thử lại.');
                } else {
                    alert('Lỗi: ' + (error.message || 'Lỗi kết nối server'));
                }
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    })();
</script>

