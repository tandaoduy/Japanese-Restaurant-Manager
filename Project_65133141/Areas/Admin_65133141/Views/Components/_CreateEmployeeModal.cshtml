@* Create Employee Modal Component *@
@using Project_65133141.Models

<!-- Create Employee Modal -->
<div id="createEmployeeModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 700px;">
        <button type="button" class="auth-close-btn" onclick="closeCreateEmployeeModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <svg class="w-full h-full p-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </div>
            <h2 class="auth-modal-title">Thêm nhân viên mới</h2>
            <p class="auth-modal-subtitle">Điền thông tin để tạo nhân viên mới</p>
        </div>

        <div class="auth-modal-body">
            <form id="createEmployeeForm" novalidate>
                @Html.AntiForgeryToken()
                
                <!-- Row 1: FullName and Email -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Họ tên <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="text" name="FullName" id="createFullName" class="auth-form-control" autocomplete="name" />
                        </div>
                        <span class="auth-error-message" id="error-create-FullName"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Email <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="email" name="Email" id="createEmail" class="auth-form-control" autocomplete="email" />
                        </div>
                        <span class="auth-error-message" id="error-create-Email"></span>
                    </div>
                </div>

                <!-- Row 2: PhoneNumber and Address -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Số điện thoại <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="tel" name="PhoneNumber" id="createPhoneNumber" class="auth-form-control" autocomplete="tel" />
                        </div>
                        <span class="auth-error-message" id="error-create-PhoneNumber"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Địa chỉ
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="text" name="Address" id="createAddress" class="auth-form-control" autocomplete="street-address" />
                        </div>
                        <span class="auth-error-message" id="error-create-Address"></span>
                    </div>
                </div>

                <!-- Row 3: DateOfBirth and StartDate -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Ngày sinh <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="date" name="DateOfBirth" id="createDateOfBirth" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-create-DateOfBirth"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Ngày vào làm <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="date" name="StartDate" id="createStartDate" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-create-StartDate"></span>
                    </div>
                </div>

                <!-- Row 4: Password and ConfirmPassword -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="password" name="Password" id="createPassword" class="auth-form-control" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" id="error-create-Password"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Xác nhận mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="password" name="ConfirmPassword" id="createConfirmPassword" class="auth-form-control" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" id="error-create-ConfirmPassword"></span>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeCreateEmployeeModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit" id="createEmployeeSubmitBtn">Tạo nhân viên</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Expose functions globally
    window.openCreateEmployeeModal = function() {
        const modal = document.getElementById('createEmployeeModal');
        if (!modal) {
            console.error('Create employee modal not found');
            return;
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Reset form
        const form = document.getElementById('createEmployeeForm');
        if (form) {
            form.reset();
            document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');
        }
    };

    window.closeCreateEmployeeModal = function() {
        const modal = document.getElementById('createEmployeeModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    };

    // Handle form submission
    (function initCreateEmployeeForm() {
        const form = document.getElementById('createEmployeeForm');
        if (!form) {
            // Retry if form not found yet
            setTimeout(initCreateEmployeeForm, 100);
            return;
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('createEmployeeSubmitBtn');
            if (!submitBtn) return;
            
            // Clear errors
            document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');

            // Validation
            let hasErrors = false;
            const errors = {};
            
            const fullName = document.getElementById('createFullName')?.value.trim() || '';
            const email = document.getElementById('createEmail')?.value.trim() || '';
            const phoneNumber = document.getElementById('createPhoneNumber')?.value.trim() || '';
            const dateOfBirth = document.getElementById('createDateOfBirth')?.value || '';
            const startDate = document.getElementById('createStartDate')?.value || '';
            const password = document.getElementById('createPassword')?.value || '';
            const confirmPassword = document.getElementById('createConfirmPassword')?.value || '';

            if (!fullName) { errors['create-FullName'] = 'Vui lòng nhập họ tên'; hasErrors = true; }
            if (!email) { errors['create-Email'] = 'Vui lòng nhập email'; hasErrors = true; }
            if (!phoneNumber) { errors['create-PhoneNumber'] = 'Vui lòng nhập số điện thoại'; hasErrors = true; }
            if (!dateOfBirth) { errors['create-DateOfBirth'] = 'Vui lòng chọn ngày sinh'; hasErrors = true; }
            if (!startDate) { errors['create-StartDate'] = 'Vui lòng chọn ngày vào làm'; hasErrors = true; }
            if (!password) { errors['create-Password'] = 'Vui lòng nhập mật khẩu'; hasErrors = true; }
            if (!confirmPassword) { errors['create-ConfirmPassword'] = 'Vui lòng xác nhận mật khẩu'; hasErrors = true; }
            if (password && confirmPassword && password !== confirmPassword) {
                errors['create-ConfirmPassword'] = 'Mật khẩu xác nhận không khớp';
                hasErrors = true;
            }

            if (hasErrors) {
                Object.keys(errors).forEach(key => {
                    const errorEl = document.getElementById('error-' + key);
                    if (errorEl) {
                        errorEl.textContent = errors[key];
                        errorEl.style.display = 'block';
                    }
                });
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Đang xử lý...';

            // Prepare form data - FormData automatically includes all form fields including the anti-forgery token
            const formData = new FormData(form);
            
            // Verify token exists
            const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
            if (!tokenInput || !tokenInput.value) {
                console.error('Anti-forgery token not found in form');
                if (typeof showAlert === 'function') {
                    showAlert('error', 'Lỗi bảo mật. Vui lòng tải lại trang.');
                } else {
                    alert('Lỗi bảo mật. Vui lòng tải lại trang.');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            // Submit via AJAX
            fetch('@Url.Action("CreateEmployeeAjax", "Employee", new { area = "Admin_65133141" })', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error('Server error: ' + response.status + ' - ' + text.substring(0, 100));
                    });
                }
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error('Invalid response format. Expected JSON but got: ' + text.substring(0, 100));
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    if (typeof showAlert === 'function') {
                        showAlert('success', data.message || 'Tạo nhân viên thành công!');
                    } else {
                        alert(data.message || 'Tạo nhân viên thành công!');
                    }
                    closeCreateEmployeeModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Show errors
                    if (data.errors) {
                        Object.keys(data.errors).forEach(key => {
                            const errorEl = document.getElementById('error-create-' + key);
                            if (errorEl) {
                                errorEl.textContent = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                errorEl.style.display = 'block';
                            }
                        });
                    } else {
                        if (typeof showAlert === 'function') {
                            showAlert('error', data.message || 'Có lỗi xảy ra khi tạo nhân viên');
                        } else {
                            alert(data.message || 'Có lỗi xảy ra khi tạo nhân viên');
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof showAlert === 'function') {
                    showAlert('error', error.message || 'Lỗi kết nối server. Vui lòng thử lại.');
                } else {
                    alert('Lỗi: ' + (error.message || 'Lỗi kết nối server'));
                }
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    })();
</script>

