@* DatBan Details Modal Component *@

<!-- DatBan Details Modal -->
<div id="datBanDetailsModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 800px; padding: 0;">
        <button type="button" class="auth-close-btn" onclick="closeDatBanDetailsModal()" style="top: 15px; right: 15px; background: white; border-radius: 50%; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">&times;</button>
        
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Info Card -->
            <div class="w-full md:w-1/2 bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-6" style="min-height: 400px;">
                <div class="w-full max-w-sm">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="text-center mb-4">
                            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900" id="detailDatBanId">#000000</h3>
                            <p class="text-sm text-gray-500 mt-1">Mã đặt bàn</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Trạng thái</span>
                                <span id="detailDatBanStatus" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase">-</span>
                            </div>
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Số người</span>
                                <span class="text-sm font-semibold text-gray-800" id="detailDatBanSoNguoi">-</span>
                            </div>
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Thời gian đến</span>
                                <span class="text-sm font-semibold text-gray-800" id="detailDatBanThoiGian">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Details -->
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-between">
                <div>
                   <!-- Header -> Title & Badges -->
                   <div class="flex items-start justify-between mb-4">
                       <div>
                           <h2 class="text-2xl font-bold text-gray-900 mb-2 leading-tight" id="detailDatBanKhachHang">-</h2>
                           <div class="flex gap-2">
                               <span id="detailDatBanStatusBadge" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-bold uppercase tracking-wide">-</span>
                           </div>
                       </div>
                   </div>

                   <!-- Details Grid -->
                   <div class="grid grid-cols-1 gap-y-6 mb-8">
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Số điện thoại</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailDatBanSDT">-</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Bàn</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailDatBanBan">-</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Ngày tạo</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailDatBanNgayTao">-</span>
                       </div>
                       <div id="detailDatBanGhiChuContainer" class="hidden">
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Ghi chú</span>
                           <p class="text-sm text-gray-600 leading-relaxed" id="detailDatBanGhiChu">-</p>
                       </div>
                       <div id="detailDatBanUserContainer" class="hidden">
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Tài khoản đặt</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailDatBanUser">-</span>
                       </div>
                   </div>
                </div>

                <!-- Footer Buttons -->
                <div class="flex items-center gap-3 mt-auto">
                    <button type="button" onclick="openEditFromDetails()" class="flex-1 px-4 py-2.5 bg-[#f97316] hover:bg-[#ea580c] text-white rounded-xl font-bold text-sm transition-all shadow-md hover:shadow-lg transform active:scale-95 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        Sửa đặt bàn
                    </button>
                    <button type="button" onclick="closeDatBanDetailsModal()" class="px-6 py-2.5 bg-gray-50 border border-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-100 transition-all active:scale-95">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentDetailDatBanId = 0;

    function openDatBanDetailsModal(datBanId) {
        currentDetailDatBanId = datBanId;
        const modal = document.getElementById('datBanDetailsModal');
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Reset and Load
        document.getElementById('detailDatBanKhachHang').textContent = 'Đang tải...';
        
        fetch(`@Url.Action("GetDatBanDetails", "DatBan", new { area = "Admin_65133141" })/${datBanId}`)
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error('Server error: ' + res.status);
                    });
                }
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return res.json();
                } else {
                    return res.text().then(text => {
                        throw new Error('Invalid response format');
                    });
                }
            })
            .then(data => {
                if(data.success) {
                    populateDatBanDetails(data.data);
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert('error', data.message || 'Không thể tải thông tin đặt bàn');
                    } else {
                        alert(data.message || 'Không thể tải thông tin đặt bàn');
                    }
                    closeDatBanDetailsModal();
                }
            })
            .catch(err => {
                console.error('Error loading DatBan details:', err);
                if (typeof showAlert === 'function') {
                    showAlert('error', 'Lỗi kết nối server. Vui lòng thử lại.');
                } else {
                    alert('Lỗi kết nối server');
                }
                closeDatBanDetailsModal();
            });
    }

    function populateDatBanDetails(d) {
        // ID Formatting (#000000)
        document.getElementById('detailDatBanId').textContent = '#' + d.DatBanID.toString().padStart(6, '0');
        
        document.getElementById('detailDatBanKhachHang').textContent = d.HoTenKhach || 'N/A';
        document.getElementById('detailDatBanSDT').textContent = d.SDTKhach || 'N/A';
        document.getElementById('detailDatBanSoNguoi').textContent = (d.SoNguoi || 0) + ' người';
        
        // Date Formatting
        let thoiGianStr = '-';
        if (d.ThoiGianDen) {
            const d1 = new Date(d.ThoiGianDen);
            if (!isNaN(d1.getTime())) {
                thoiGianStr = d1.toLocaleDateString('vi-VN') + ' ' + 
                             d1.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            }
        }
        document.getElementById('detailDatBanThoiGian').textContent = thoiGianStr;
        
        let ngayTaoStr = '-';
        if (d.NgayTao) {
            const d2 = new Date(d.NgayTao);
            if (!isNaN(d2.getTime())) {
                ngayTaoStr = d2.toLocaleDateString('vi-VN') + ' ' + 
                            d2.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            }
        }
        document.getElementById('detailDatBanNgayTao').textContent = ngayTaoStr;
        
        // Bàn
        const banText = d.TenBan ? (d.TenBan + (d.ViTri ? ' (' + d.ViTri + ')' : '') + (d.SucChua ? ' - ' + d.SucChua + ' người' : '')) : 'Chưa chọn';
        document.getElementById('detailDatBanBan').textContent = banText;
        
        // Status Logic
        const statusEl = document.getElementById('detailDatBanStatus');
        const statusBadge = document.getElementById('detailDatBanStatusBadge');
        let statusText = d.TrangThai || 'Chờ xác nhận';
        
        statusEl.textContent = statusText;
        statusBadge.textContent = statusText;
        
        // Status classes
        let statusClasses = 'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ';
        if (statusText === 'Đã xác nhận') {
            statusClasses += 'bg-green-100 text-green-700';
        } else if (statusText === 'Đang phục vụ') {
            statusClasses += 'bg-blue-100 text-blue-700';
        } else if (statusText === 'Hoàn thành') {
            statusClasses += 'bg-purple-100 text-purple-700';
        } else if (statusText === 'Đã hủy') {
            statusClasses += 'bg-red-100 text-red-700';
        } else {
            statusClasses += 'bg-gray-100 text-gray-700';
        }
        statusEl.className = statusClasses;
        statusBadge.className = statusClasses;
        
        // Ghi chú
        const ghiChuContainer = document.getElementById('detailDatBanGhiChuContainer');
        if (d.GhiChu && d.GhiChu.trim()) {
            document.getElementById('detailDatBanGhiChu').textContent = d.GhiChu;
            ghiChuContainer.classList.remove('hidden');
        } else {
            ghiChuContainer.classList.add('hidden');
        }
        
        // User
        const userContainer = document.getElementById('detailDatBanUserContainer');
        if (d.UserHoTen && d.UserEmail) {
            document.getElementById('detailDatBanUser').textContent = d.UserHoTen + ' (' + d.UserEmail + ')';
            userContainer.classList.remove('hidden');
        } else {
            userContainer.classList.add('hidden');
        }
    }

    function openEditFromDetails() {
        closeDatBanDetailsModal();
        setTimeout(() => {
            if (typeof openEditDatBanModal === 'function') {
                openEditDatBanModal(currentDetailDatBanId);
            }
        }, 100);
    }

    function closeDatBanDetailsModal() {
        document.getElementById('datBanDetailsModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // Close on ESC
    document.addEventListener('keydown', e => {
        if(e.key === 'Escape') {
             if(document.getElementById('datBanDetailsModal').style.display === 'flex') closeDatBanDetailsModal();
        }
    });

    document.addEventListener('click', e => {
        const m = document.getElementById('datBanDetailsModal');
        if(e.target === m) closeDatBanDetailsModal();
    });
</script>

