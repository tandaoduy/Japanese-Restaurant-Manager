@* Edit DatBan Modal Component *@

<!-- Edit DatBan Modal -->
<div id="editDatBanModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 700px;">
        <button type="button" class="auth-close-btn" onclick="closeEditDatBanModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <svg class="w-full h-full p-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            <h2 class="auth-modal-title">Cập nhật đặt bàn</h2>
            <p class="auth-modal-subtitle">Chỉnh sửa thông tin đặt bàn</p>
        </div>

        <div class="auth-modal-body">
            <form id="editDatBanForm" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="DatBanID" id="editDatBanID" />
                
                <!-- Row 1: HoTenKhach and SDTKhach -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Họ tên khách hàng <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="text" name="HoTenKhach" id="editHoTenKhach" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-HoTenKhach"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Số điện thoại <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="tel" name="SDTKhach" id="editSDTKhach" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-SDTKhach"></span>
                    </div>
                </div>

                <!-- Row 2: BanID and SoNguoi -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Bàn
                        </label>
                        <div class="auth-input-wrapper">
                            <select name="BanID" id="editBanID" class="auth-form-control">
                                <option value="">-- Chọn bàn --</option>
                            </select>
                        </div>
                        <span class="auth-error-message" id="error-edit-BanID"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Số người
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="number" name="SoNguoi" id="editSoNguoi" class="auth-form-control" min="1" />
                        </div>
                        <span class="auth-error-message" id="error-edit-SoNguoi"></span>
                    </div>
                </div>

                <!-- Row 3: ThoiGianDen and TrangThai -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Thời gian đến <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="datetime-local" name="ThoiGianDen" id="editThoiGianDen" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-ThoiGianDen"></span>
                    </div>

                    <div class="auth-form-group">
                         <label class="auth-form-label">Trạng thái <span class="auth-required">*</span></label>
                         <div class="auth-input-wrapper">
                             <select name="TrangThai" id="editTrangThai" class="auth-form-control">
                                 <option value="Chờ xác nhận">Chờ xác nhận</option>
                                 <option value="Đã xác nhận">Đã xác nhận</option>
                                 <option value="Đang phục vụ">Đang phục vụ</option>
                                 <option value="Hoàn thành">Hoàn thành</option>
                                 <option value="Đã hủy">Đã hủy</option>
                             </select>
                         </div>
                         <span class="auth-error-message" id="error-edit-TrangThai"></span>
                    </div>
                </div>

                <!-- Row 4: GhiChu -->
                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Ghi chú
                    </label>
                    <div class="auth-input-wrapper">
                        <textarea name="GhiChu" id="editGhiChu" class="auth-form-control" rows="3"></textarea>
                    </div>
                    <span class="auth-error-message" id="error-edit-GhiChu"></span>
                </div>

                <!-- Buttons -->
                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeEditDatBanModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit" id="editDatBanSubmitBtn">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditDatBanModal(datBanId) {
        const modal = document.getElementById('editDatBanModal');
        const modalBody = modal.querySelector('.auth-modal-body');
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        if (modalBody) modalBody.classList.add('loading');
        
        // Reset form
        document.getElementById('editDatBanForm').reset();
        document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');

        // Fetch datBan data
        fetch(`@Url.Action("GetDatBanDetails", "DatBan", new { area = "Admin_65133141" })/${datBanId}`)
             .then(response => {
                 if (!response.ok) {
                     return response.text().then(text => {
                         throw new Error('Server error: ' + response.status);
                     });
                 }
                 const contentType = response.headers.get('content-type');
                 if (contentType && contentType.includes('application/json')) {
                     return response.json();
                 } else {
                     return response.text().then(text => {
                         throw new Error('Invalid response format');
                     });
                 }
             })
             .then(data => {
                 if (data.success) {
                     populateEditDatBanForm(data.data);
                     loadAvailableTables(datBanId);
                 } else {
                     if (typeof showAlert === 'function') {
                         showAlert('error', data.message || 'Không thể tải thông tin đặt bàn');
                     } else {
                         alert(data.message || 'Không thể tải thông tin đặt bàn');
                     }
                     closeEditDatBanModal();
                 }
             })
             .catch(error => {
                 console.error('Error loading DatBan:', error);
                 if (typeof showAlert === 'function') {
                     showAlert('error', 'Lỗi kết nối server. Vui lòng thử lại.');
                 } else {
                     alert('Lỗi kết nối server');
                 }
                 closeEditDatBanModal();
             })
             .finally(() => {
                 if (modalBody) modalBody.classList.remove('loading');
             });
    }

    function loadAvailableTables(currentDatBanId) {
        // Load available tables for dropdown
        fetch('@Url.Action("GetAvailableTables", "DatBan", new { area = "Admin_65133141" })?currentDatBanId=' + currentDatBanId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error('Invalid response format');
                    });
                }
            })
            .then(data => {
                if (data.success && data.tables) {
                    const select = document.getElementById('editBanID');
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Chọn bàn --</option>';
                    data.tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table.BanID;
                        option.textContent = table.DisplayText;
                        select.appendChild(option);
                    });
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading tables:', error);
                // Don't show alert for table loading errors, just log
            });
    }

    function populateEditDatBanForm(d) {
        document.getElementById('editDatBanID').value = d.DatBanID;
        document.getElementById('editHoTenKhach').value = d.HoTenKhach || '';
        document.getElementById('editSDTKhach').value = d.SDTKhach || '';
        document.getElementById('editSoNguoi').value = d.SoNguoi || '';
        document.getElementById('editTrangThai').value = d.TrangThai || 'Chờ xác nhận';
        document.getElementById('editGhiChu').value = d.GhiChu || '';
        
        // Format datetime-local
        if (d.ThoiGianDen) {
            const date = new Date(d.ThoiGianDen);
            if (!isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                document.getElementById('editThoiGianDen').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        }
        
        // Set BanID after tables are loaded
        if (d.BanID) {
            setTimeout(() => {
                document.getElementById('editBanID').value = d.BanID;
            }, 300);
        }
    }

    function closeEditDatBanModal() {
        document.getElementById('editDatBanModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('editDatBanForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('editDatBanSubmitBtn');
                if (!submitBtn) return;
                
                // Clear errors
                document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');

                // Validation
                let hasErrors = false;
                const errors = {};
                
                const hoTenKhach = document.getElementById('editHoTenKhach').value.trim();
                const sdtKhach = document.getElementById('editSDTKhach').value.trim();
                const thoiGianDen = document.getElementById('editThoiGianDen').value;
                const trangThai = document.getElementById('editTrangThai').value;

                if (!hoTenKhach) { errors['edit-HoTenKhach'] = 'Vui lòng nhập họ tên khách hàng'; hasErrors = true; }
                if (!sdtKhach) { errors['edit-SDTKhach'] = 'Vui lòng nhập số điện thoại'; hasErrors = true; }
                if (!thoiGianDen) { errors['edit-ThoiGianDen'] = 'Vui lòng chọn thời gian đến'; hasErrors = true; }
                if (!trangThai) { errors['edit-TrangThai'] = 'Vui lòng chọn trạng thái'; hasErrors = true; }

                if (hasErrors) {
                     Object.keys(errors).forEach(key => {
                        const errorEl = document.getElementById('error-' + key);
                        if (errorEl) {
                            errorEl.textContent = errors[key];
                            errorEl.style.display = 'block';
                        }
                    });
                    return;
                }

                // Disable submit button
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Đang xử lý...';

                // Prepare form data - FormData automatically includes all form fields including the token
                const formData = new FormData(form);
                
                // Verify token exists (FormData should already have it)
                const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                if (!tokenInput || !tokenInput.value) {
                    console.error('Anti-forgery token not found in form');
                    if (typeof showAlert === 'function') {
                        showAlert('error', 'Lỗi bảo mật. Vui lòng tải lại trang.');
                    } else {
                        alert('Lỗi bảo mật. Vui lòng tải lại trang.');
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                // Submit via AJAX
                fetch('@Url.Action("EditDatBanAjax", "DatBan", new { area = "Admin_65133141" })', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('Server error: ' + response.status + ' - ' + text.substring(0, 100));
                        });
                    }
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        return response.text().then(text => {
                            throw new Error('Invalid response format. Expected JSON but got: ' + text.substring(0, 100));
                        });
                    }
                })
                .then(data => {
                    if (data.success) {
                        if (typeof showAlert === 'function') {
                            showAlert('success', data.message || 'Cập nhật đặt bàn thành công!');
                        } else {
                            alert(data.message || 'Cập nhật đặt bàn thành công!');
                        }
                        closeEditDatBanModal();
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // Show errors
                        if (data.errors) {
                            Object.keys(data.errors).forEach(key => {
                                const errorEl = document.getElementById('error-edit-' + key);
                                if (errorEl) {
                                    errorEl.textContent = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                    errorEl.style.display = 'block';
                                }
                            });
                        } else {
                            if (typeof showAlert === 'function') {
                                showAlert('error', data.message || 'Có lỗi xảy ra khi cập nhật');
                            } else {
                                alert(data.message || 'Có lỗi xảy ra khi cập nhật');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (typeof showAlert === 'function') {
                        showAlert('error', error.message || 'Lỗi kết nối server. Vui lòng thử lại.');
                    } else {
                        alert('Lỗi: ' + (error.message || 'Lỗi kết nối server'));
                    }
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });
        }
    });
</script>

