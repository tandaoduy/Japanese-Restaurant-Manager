@* Edit Employee Modal Component *@
@using Project_65133141.Models

<!-- Edit Employee Modal -->
<div id="editEmployeeModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 700px;">
        <button type="button" class="auth-close-btn" onclick="closeEditEmployeeModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <svg class="w-full h-full p-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            <h2 class="auth-modal-title">Cập nhật nhân viên</h2>
            <p class="auth-modal-subtitle">Chỉnh sửa thông tin nhân viên</p>
        </div>

        <div class="auth-modal-body">
            <form id="editEmployeeForm" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="editEmployeeID" />
                
                <!-- Row 1: FullName and Email -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Họ tên <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="text" name="FullName" id="editFullName" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-FullName"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Email <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="email" name="Email" id="editEmail" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-Email"></span>
                    </div>
                </div>

                <!-- Row 2: PhoneNumber and Address -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Số điện thoại
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="tel" name="PhoneNumber" id="editPhoneNumber" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-PhoneNumber"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Địa chỉ
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="text" name="Address" id="editAddress" class="auth-form-control" autocomplete="street-address" />
                        </div>
                        <span class="auth-error-message" id="error-edit-Address"></span>
                    </div>
                </div>

                <!-- Row 3: DateOfBirth and StartDate -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Ngày sinh
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="date" name="DateOfBirth" id="editDateOfBirth" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-DateOfBirth"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Ngày vào làm
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="date" name="StartDate" id="editStartDate" class="auth-form-control" />
                        </div>
                        <span class="auth-error-message" id="error-edit-StartDate"></span>
                    </div>
                </div>

                <!-- Row 5: Password and ConfirmPassword -->
                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Mật khẩu mới
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="password" name="Password" id="editPassword" class="auth-form-control" placeholder="Để trống nếu không muốn thay đổi" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" id="error-edit-Password"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Xác nhận mật khẩu
                        </label>
                        <div class="auth-input-wrapper">
                            <input type="password" name="ConfirmPassword" id="editConfirmPassword" class="auth-form-control" placeholder="Xác nhận mật khẩu mới" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" id="error-edit-ConfirmPassword"></span>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeEditEmployeeModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit" id="editEmployeeSubmitBtn">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditEmployeeModal(employeeId) {
        const modal = document.getElementById('editEmployeeModal');
        const modalBody = modal.querySelector('.auth-modal-body');
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        if (modalBody) modalBody.classList.add('loading');
        
        // Reset form
        document.getElementById('editEmployeeForm').reset();
        document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');

        // Fetch employee data
        fetch(`@Url.Action("GetEmployeeDetails", "Employee", new { area = "Admin_65133141" })/${employeeId}`)
             .then(response => {
                 if (!response.ok) {
                     return response.text().then(text => {
                         throw new Error('Server error: ' + response.status);
                     });
                 }
                 const contentType = response.headers.get('content-type');
                 if (contentType && contentType.includes('application/json')) {
                     return response.json();
                 } else {
                     return response.text().then(text => {
                         throw new Error('Invalid response format');
                     });
                 }
             })
             .then(data => {
                 if (data.success) {
                     populateEditEmployeeForm(data.data);
                 } else {
                     if (typeof showAlert === 'function') {
                         showAlert('error', data.message || 'Không thể tải thông tin nhân viên');
                     } else {
                         alert(data.message || 'Không thể tải thông tin nhân viên');
                     }
                     closeEditEmployeeModal();
                 }
             })
             .catch(error => {
                 console.error('Error:', error);
                 if (typeof showAlert === 'function') {
                     showAlert('error', 'Lỗi kết nối server');
                 } else {
                     alert('Lỗi kết nối server');
                 }
                 closeEditEmployeeModal();
             })
             .finally(() => {
                 if (modalBody) modalBody.classList.remove('loading');
             });
    }

    function populateEditEmployeeForm(e) {
        document.getElementById('editEmployeeID').value = e.Id;
        document.getElementById('editFullName').value = e.FullName || '';
        document.getElementById('editEmail').value = e.Email || '';
        document.getElementById('editPhoneNumber').value = e.PhoneNumber || '';
        document.getElementById('editAddress').value = e.Address || '';
        
        // Format dates
        if (e.DateOfBirth) {
            const date1 = new Date(e.DateOfBirth);
            if (!isNaN(date1.getTime())) {
                const year = date1.getFullYear();
                const month = String(date1.getMonth() + 1).padStart(2, '0');
                const day = String(date1.getDate()).padStart(2, '0');
                document.getElementById('editDateOfBirth').value = `${year}-${month}-${day}`;
            }
        }
        
        if (e.StartDate) {
            const date2 = new Date(e.StartDate);
            if (!isNaN(date2.getTime())) {
                const year = date2.getFullYear();
                const month = String(date2.getMonth() + 1).padStart(2, '0');
                const day = String(date2.getDate()).padStart(2, '0');
                document.getElementById('editStartDate').value = `${year}-${month}-${day}`;
            }
        }
    }

    function closeEditEmployeeModal() {
        document.getElementById('editEmployeeModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Validation functions (matching create modal)
    function validateFullName(value) {
        if (!value || value.trim() === '') {
            return 'Vui lòng nhập họ tên';
        }
        const nameRegex = /^[a-zA-ZÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s]+$/;
        if (!nameRegex.test(value.trim())) {
            return 'Họ tên chỉ được chứa chữ cái';
        }
        return null;
    }

    function validatePhoneNumber(value) {
        if (!value || value.trim() === '') {
            return 'Vui lòng nhập số điện thoại';
        }
        const phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test(value.trim())) {
            return 'Số điện thoại phải có đúng 10 chữ số';
        }
        return null;
    }

    function validateEmail(value) {
        if (!value || value.trim() === '') {
            return 'Vui lòng nhập email';
        }
        const emailRegex = /^[a-zA-Z0-9._-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(value.trim())) {
            return 'Email không hợp lệ (chỉ cho phép chữ, số, dấu chấm, gạch ngang, gạch dưới và @@)';
        }
        return null;
    }

    function validateAddress(value) {
        if (!value || value.trim() === '') {
            return null; // Address is optional
        }
        const addressRegex = /^[a-zA-Z0-9ÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s,.\/-]+$/;
        if (!addressRegex.test(value.trim())) {
            return 'Địa chỉ chỉ được chứa chữ, số và các ký tự: , . / -';
        }
        return null;
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('editEmployeeForm');
        if (form) {
            // Real-time validation
            const fullNameInput = document.getElementById('editFullName');
            const phoneNumberInput = document.getElementById('editPhoneNumber');
            const emailInput = document.getElementById('editEmail');
            const addressInput = document.getElementById('editAddress');

            if (fullNameInput) {
                fullNameInput.addEventListener('input', function(e) {
                    const error = validateFullName(e.target.value);
                    const errorEl = document.getElementById('error-edit-FullName');
                    if (errorEl) {
                        errorEl.textContent = error || '';
                        errorEl.style.display = error ? 'block' : 'none';
                    }
                });

                fullNameInput.addEventListener('keypress', function(e) {
                    // Use e.key to check the character directly
                    const nameRegex = /^[a-zA-ZÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s]$/;
                    if (!nameRegex.test(e.key)) {
                        e.preventDefault();
                    }
                });
            }

            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('input', function(e) {
                    const error = validatePhoneNumber(e.target.value);
                    const errorEl = document.getElementById('error-edit-PhoneNumber');
                    if (errorEl) {
                        errorEl.textContent = error || '';
                        errorEl.style.display = error ? 'block' : 'none';
                    }
                });

                phoneNumberInput.addEventListener('keypress', function(e) {
                    if (!/^[0-9]$/.test(e.key)) {
                        e.preventDefault();
                    }
                });

                phoneNumberInput.addEventListener('input', function(e) {
                    if (e.target.value.length > 10) {
                        e.target.value = e.target.value.slice(0, 10);
                    }
                });
            }

            if (emailInput) {
                // Prevent invalid characters in email
                // Prevent invalid characters in email
                emailInput.addEventListener('keypress', function(e) {
                    // Allow letters, numbers, dot, underscore, hyphen, and at sign
                    const emailAllowedRegex = /^[a-zA-Z0-9.\-_\x40]$/;
                    if (!emailAllowedRegex.test(e.key)) {
                        e.preventDefault();
                    }
                });

                emailInput.addEventListener('blur', function(e) {
                    const error = validateEmail(e.target.value);
                    const errorEl = document.getElementById('error-edit-Email');
                    if (errorEl) {
                        errorEl.textContent = error || '';
                        errorEl.style.display = error ? 'block' : 'none';
                    }
                });
            }

            // Helper to enforce year limit on date inputs
            function enforceYearLimit(inputElement) {
                inputElement.setAttribute('max', '9999-12-31');
                inputElement.addEventListener('input', function(e) {
                    const value = e.target.value;
                    if (value) {
                        const dateParts = value.split('-');
                        if (dateParts.length > 0 && dateParts[0].length > 4) {
                            // If year is more than 4 digits, slice it
                            dateParts[0] = dateParts[0].slice(0, 4);
                            e.target.value = dateParts.join('-');
                        }
                    }
                });
            }

            const editDobInput = document.getElementById('editDateOfBirth');
            const editStartInput = document.getElementById('editStartDate');
            if (editDobInput) enforceYearLimit(editDobInput);
            if (editStartInput) enforceYearLimit(editStartInput);

            if (addressInput) {
                addressInput.addEventListener('input', function(e) {
                    const error = validateAddress(e.target.value);
                    const errorEl = document.getElementById('error-edit-Address');
                    if (errorEl) {
                        errorEl.textContent = error || '';
                        errorEl.style.display = error ? 'block' : 'none';
                    }
                });

                addressInput.addEventListener('keypress', function(e) {
                    const addressRegex = /^[a-zA-Z0-9ÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ\s,.\/-]$/;
                    if (!addressRegex.test(e.key)) {
                        e.preventDefault();
                    }
                });
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('editEmployeeSubmitBtn');
                if (!submitBtn) return;
                
                // Clear errors
                document.querySelectorAll('.auth-error-message').forEach(el => el.textContent = '');

                // Validation
                let hasErrors = false;
                const errors = {};
                
                const fullName = document.getElementById('editFullName').value.trim();
                const email = document.getElementById('editEmail').value.trim();
                const phoneNumber = document.getElementById('editPhoneNumber').value.trim();
                const address = document.getElementById('editAddress').value.trim();
                const dateOfBirth = document.getElementById('editDateOfBirth').value;
                const startDate = document.getElementById('editStartDate').value;
                const password = document.getElementById('editPassword').value;
                const confirmPassword = document.getElementById('editConfirmPassword').value;

                // Validate with validation functions
                const fullNameError = validateFullName(fullName);
                if (fullNameError) { errors['edit-FullName'] = fullNameError; hasErrors = true; }

                const emailError = validateEmail(email);
                if (emailError) { errors['edit-Email'] = emailError; hasErrors = true; }

                const phoneError = validatePhoneNumber(phoneNumber);
                if (phoneError) { errors['edit-PhoneNumber'] = phoneError; hasErrors = true; }

                const addressError = validateAddress(address);
                if (addressError) { errors['edit-Address'] = addressError; hasErrors = true; }

                // Validate Year ranges specially
                if (dateOfBirth) {
                    const year = new Date(dateOfBirth).getFullYear();
                    if (year > 9999 || year < 1900) {
                         errors['edit-DateOfBirth'] = 'Năm sinh không hợp lệ (phải có 4 số)';
                         hasErrors = true;
                    }
                }

                if (startDate) {
                    const year = new Date(startDate).getFullYear();
                    if (year > 9999 || year < 1900) {
                         errors['edit-StartDate'] = 'Năm vào làm không hợp lệ (phải có 4 số)';
                         hasErrors = true;
                    }
                }

                if (password && password !== confirmPassword) {
                    errors['edit-ConfirmPassword'] = 'Mật khẩu xác nhận không khớp';
                    hasErrors = true;
                }

                if (hasErrors) {
                     Object.keys(errors).forEach(key => {
                        const errorEl = document.getElementById('error-' + key);
                        if (errorEl) {
                            errorEl.textContent = errors[key];
                            errorEl.style.display = 'block';
                        }
                    });
                    return;
                }

                // Disable submit button
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Đang xử lý...';

                // Prepare form data
                // Prepare form data
                const formData = new FormData(form);
                // Token is already included in FormData from the form input
                

                // Submit via AJAX
                fetch('@Url.Action("EditEmployeeAjax", "Employee", new { area = "Admin_65133141" })', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('Server error: ' + response.status + ' - ' + text.substring(0, 100));
                        });
                    }
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        return response.text().then(text => {
                            throw new Error('Invalid response format. Expected JSON but got: ' + text.substring(0, 100));
                        });
                    }
                })
                .then(data => {
                    if (data.success) {
                        if (typeof showAlert === 'function') {
                            showAlert('success', data.message || 'Cập nhật nhân viên thành công!');
                        } else {
                            alert(data.message || 'Cập nhật nhân viên thành công!');
                        }
                        closeEditEmployeeModal();
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // Show errors
                        if (data.errors) {
                            Object.keys(data.errors).forEach(key => {
                                const errorEl = document.getElementById('error-edit-' + key);
                                if (errorEl) {
                                    errorEl.textContent = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                    errorEl.style.display = 'block';
                                }
                            });
                        } else {
                            if (typeof showAlert === 'function') {
                                showAlert('error', data.message || 'Có lỗi xảy ra khi cập nhật');
                            } else {
                                alert(data.message || 'Có lỗi xảy ra khi cập nhật');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (typeof showAlert === 'function') {
                        showAlert('error', error.message || 'Lỗi kết nối server. Vui lòng thử lại.');
                    } else {
                        alert('Lỗi: ' + (error.message || 'Lỗi kết nối server'));
                    }
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });
        }
    });
</script>

