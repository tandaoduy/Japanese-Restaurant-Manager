@model Project_65133141.Models.User

@{
    ViewBag.Title = "Hồ sơ của tôi";
}

<div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 font-display">Hồ sơ cá nhân</h1>
            <p class="text-gray-500 mt-1">Quản lý thông tin và bảo mật tài khoản</p>
        </div>
        <div class="hidden md:block">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                <i class="fas fa-check-circle mr-2"></i> Tài khoản hoạt động
            </span>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Avatar & Overview -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Avatar Card -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-24"></div>
                <div class="px-6 pb-6 text-center relative">
                    <div class="relative -mt-12 mb-4 inline-block">
                        <img id="avatarPreview" 
                             src="@(string.IsNullOrEmpty(Model.Avatar) ? Url.Content("~/Images/default-avatar.png") : Url.Content(Model.Avatar))" 
                             alt="Avatar" 
                             class="w-24 h-24 rounded-full border-4 border-white shadow-md object-cover bg-white">
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">@Model.HoTen</h2>
                    <p class="text-gray-500 text-sm mb-4">@Model.Email</p>
                    <button type="button" onclick="document.getElementById('avatarInput').click()" 
                            class="px-4 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg text-sm font-medium transition-colors shadow-sm">
                        <i class="fas fa-camera mr-2"></i> Đổi ảnh đại diện
                    </button>
                </div>
            </div>


        </div>

        <!-- Right Column: Forms -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Personal Info Form -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Thông tin chung</h2>
                    <span class="text-xs text-gray-400 font-normal">* Các trường bắt buộc</span>
                </div>

                <form id="profileForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <!-- Hidden Avatar Input -->
                    <input type="file" id="avatarInput" name="avatar" accept="image/*" class="hidden" />

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Full Name -->
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Họ và tên <span class="text-red-500">*</span></label>
                            <input type="text" name="tenKhachHang" value="@Model.HoTen" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" required placeholder="Nhập họ tên của bạn" />
                        </div>

                        <!-- Phone -->
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại <span class="text-red-500">*</span></label>
                            <input type="tel" name="sdt" value="@Model.SDT" pattern="[0-9]{10}" maxlength="10" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" required placeholder="09xxxxxxx" />
                        </div>

                        <!-- Email (Readonly) -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-4 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <input type="email" value="@Model.Email" disabled class="w-full px-4 py-2.5 rounded-r-lg border border-gray-300 bg-gray-50 text-gray-500 cursor-not-allowed text-sm" />
                            </div>
                            <p class="mt-1 text-xs text-gray-400">Email không thể thay đổi vì lý do bảo mật.</p>
                        </div>

                        <!-- Address -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Địa chỉ</label>
                            <textarea name="diaChi" rows="3" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" placeholder="Nhập địa chỉ giao hàng của bạn">@Model.DiaChi</textarea>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4 border-t border-gray-100">
                        <button type="submit" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm hover:shadow transition-all flex items-center">
                            <i class="fas fa-save mr-2"></i> Lưu thay đổi
                        </button>
                    </div>
                </form>
            </div>

            <!-- Change Password Form -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8">
                <div class="flex items-center mb-6">
                    <div class="bg-yellow-100 p-2 rounded-lg mr-3 text-yellow-600">
                        <i class="fas fa-key"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Đổi mật khẩu</h2>
                </div>

                <form id="passwordForm">
                    @Html.AntiForgeryToken()
                    <div class="grid grid-cols-1 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu hiện tại</label>
                            <input type="password" name="currentPassword" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all text-sm" required placeholder="********" />
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu mới</label>
                                <input type="password" id="newPassword" name="newPassword" minlength="6" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all text-sm" required placeholder="Tối thiểu 6 ký tự" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Xác nhận mật khẩu mới</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" minlength="6" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all text-sm" required placeholder="Nhập lại mật khẩu mới" />
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4 border-t border-gray-100">
                        <button type="submit" class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium rounded-lg transition-all flex items-center">
                            <i class="fas fa-lock mr-2"></i> Cập nhật mật khẩu
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- Alert Container (Top-right toast notifications) -->
<div id="alertContainer" class="fixed top-20 right-4 z-[10000] space-y-2 max-w-md"></div>

<!-- Confirm Save Profile Modal -->
<div id="confirmSaveProfileModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[9999] p-4" style="display: none;">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl max-w-md w-full mx-auto transform transition-all">
        <div class="p-4 sm:p-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-blue-100 flex items-center justify-center">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-3 sm:ml-4 flex-1 min-w-0">
                    <h3 class="text-base sm:text-lg font-bold text-gray-900">Lưu thay đổi?</h3>
                    <p class="mt-2 text-sm text-gray-600 break-words">Bạn có chắc chắn muốn cập nhật thông tin hồ sơ?</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 rounded-b-xl sm:rounded-b-2xl flex flex-col-reverse sm:flex-row justify-end gap-2 sm:gap-3">
            <button type="button" id="cancelSaveProfileBtn" class="px-4 sm:px-5 py-2 sm:py-2.5 bg-white hover:bg-gray-100 active:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm border border-gray-300 shadow-sm hover:shadow-md active:shadow-sm transition-all transform hover:scale-105 active:scale-95 w-full sm:w-auto">Hủy</button>
            <button type="button" id="confirmSaveProfileBtn" class="px-4 sm:px-5 py-2 sm:py-2.5 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white rounded-lg font-semibold text-sm shadow-md hover:shadow-lg active:shadow-md transition-all transform hover:scale-105 active:scale-95 w-full sm:w-auto">Đồng ý, lưu lại</button>
        </div>
    </div>
</div>

<!-- Confirm Change Password Modal -->
<div id="confirmChangePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[9999] p-4" style="display: none;">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl max-w-md w-full mx-auto transform transition-all">
        <div class="p-4 sm:p-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-3 sm:ml-4 flex-1 min-w-0">
                    <h3 class="text-base sm:text-lg font-bold text-gray-900">Xác nhận đổi mật khẩu?</h3>
                    <p class="mt-2 text-sm text-gray-600 break-words">Bạn sẽ cần sử dụng mật khẩu mới cho lần đăng nhập sau. Hành động này sẽ cập nhật bảo mật tài khoản.</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 rounded-b-xl sm:rounded-b-2xl flex flex-col-reverse sm:flex-row justify-end gap-2 sm:gap-3">
            <button type="button" id="cancelChangePasswordBtn" class="px-4 sm:px-5 py-2 sm:py-2.5 bg-white hover:bg-gray-100 active:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm border border-gray-300 shadow-sm hover:shadow-md active:shadow-sm transition-all transform hover:scale-105 active:scale-95 w-full sm:w-auto">Hủy</button>
            <button type="button" id="confirmChangePasswordBtn" class="px-4 sm:px-5 py-2 sm:py-2.5 bg-yellow-500 hover:bg-yellow-600 active:bg-yellow-700 text-white rounded-lg font-semibold text-sm shadow-md hover:shadow-lg active:shadow-md transition-all transform hover:scale-105 active:scale-95 w-full sm:w-auto">Đổi mật khẩu</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toast Alert System (Matching Admin)
        function showAlert(type, message) {
            var container = document.getElementById('alertContainer');
            if (!container) return;

            var alertId = 'alert-' + Date.now();

            var config = {
                success: {
                    bg: 'bg-green-100 border border-green-200 text-green-900',
                    iconBg: 'bg-green-500 text-white',
                    title: 'Thành công!',
                    icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                },
                error: {
                    bg: 'bg-red-100 border border-red-200 text-red-900',
                    iconBg: 'bg-red-500 text-white',
                    title: 'Lỗi!',
                    icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14"></path><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
                },
                warning: {
                    bg: 'bg-amber-100 border border-amber-200 text-amber-900',
                    iconBg: 'bg-amber-500 text-white',
                    title: 'Cảnh báo!',
                    icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 3h.01M10.29 4.21l-6.6 11.45A1 1 0 004.53 18h14.94a1 1 0 00.86-1.5l-6.6-11.45a1 1 0 00-1.74 0z"/></svg>'
                },
                info: {
                    bg: 'bg-sky-100 border border-sky-200 text-sky-900',
                    iconBg: 'bg-sky-500 text-white',
                    title: 'Thông tin',
                    icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01" /><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
                }
            };

            var cfg = config[type] || config.info;

            var html = `
            <div id="${alertId}" class="${cfg.bg} px-3 py-2 rounded-lg shadow-md flex items-center gap-2 max-w-md transition-all duration-300 translate-x-full bg-opacity-95 border border-white/60">
                <div class="w-7 h-7 rounded-full ${cfg.iconBg} flex items-center justify-center flex-shrink-0">
                    ${cfg.icon}
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-sm mb-0.5">${cfg.title}</div>
                    <div class="text-sm leading-snug">${message}</div>
                </div>
                <button type="button" class="ml-2 text-current/70 hover:text-current" aria-label="Đóng thông báo"
                        onclick="(function(){ var el = document.getElementById('${alertId}'); if(el){ el.classList.add('translate-x-full'); setTimeout(function(){ el.remove(); }, 250); } })()">
                    &#10005;
                </button>
            </div>`;

            container.insertAdjacentHTML('beforeend', html);

            setTimeout(function () {
                var el = document.getElementById(alertId);
                if (el) el.classList.remove('translate-x-full');
            }, 10);

            setTimeout(function () {
                var el = document.getElementById(alertId);
                if (el) {
                    el.classList.add('translate-x-full');
                    setTimeout(function () { el.remove(); }, 250);
                }
            }, 4000);
        }

        // Modal Helper Functions
        function openModal(modalId) {
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // --- 1. Avatar Preview Logic ---
        document.getElementById('avatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Client-side validation
                if (!file.type.startsWith('image/')) {
                    showAlert('error', 'Vui lòng chọn file ảnh (JPG, PNG, GIF)');
                    this.value = '';
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    showAlert('error', 'Kích thước ảnh không được vượt quá 2MB');
                    this.value = '';
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- 2. Profile Form Submit (With Custom Confirmation Modal) ---
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            openModal('confirmSaveProfileModal');
        });

        // Cancel Save Profile
        document.getElementById('cancelSaveProfileBtn').addEventListener('click', function() {
            closeModal('confirmSaveProfileModal');
        });

        // Confirm Save Profile
        document.getElementById('confirmSaveProfileBtn').addEventListener('click', function() {
            closeModal('confirmSaveProfileModal');
            
            const formData = new FormData(document.getElementById('profileForm'));

            fetch('@Url.Action("UpdateProfile", "Account", new { area = "User_65133141" })', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showAlert('error', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', 'Không thể kết nối đến máy chủ. Vui lòng thử lại sau.');
            });
        });

        // --- 3. Password Form Submit (With Custom Confirmation Modal) ---
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (newPass !== confirmPass) {
                showAlert('warning', 'Mật khẩu mới và xác nhận mật khẩu không trùng khớp');
                return;
            }

            openModal('confirmChangePasswordModal');
        });

        // Cancel Change Password
        document.getElementById('cancelChangePasswordBtn').addEventListener('click', function() {
            closeModal('confirmChangePasswordModal');
        });

        // Confirm Change Password
        document.getElementById('confirmChangePasswordBtn').addEventListener('click', function() {
            closeModal('confirmChangePasswordModal');

            const formData = new FormData(document.getElementById('passwordForm'));

            fetch('@Url.Action("ChangePassword", "Account", new { area = "User_65133141" })', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    document.getElementById('passwordForm').reset();
                } else {
                    showAlert('error', data.message);
                }
            })
            .catch(error => {
                showAlert('error', 'Không thể kết nối đến máy chủ.');
            });
        });

        // Close modals on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal('confirmSaveProfileModal');
                closeModal('confirmChangePasswordModal');
            }
        });

        // Close modals on backdrop click
        document.getElementById('confirmSaveProfileModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal('confirmSaveProfileModal');
            }
        });

        document.getElementById('confirmChangePasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal('confirmChangePasswordModal');
            }
        });
    </script>
}
