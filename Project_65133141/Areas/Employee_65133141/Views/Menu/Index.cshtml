@model IEnumerable<Project_65133141.Models.MonAn>
@{
    ViewBag.Title = "Th·ª±c ƒë∆°n nh√† h√†ng";
    Layout = "~/Areas/Employee_65133141/Views/Shared/_Layout.cshtml";

    var categories = ViewBag.Categories as List<Project_65133141.Models.DanhMuc>;
    long? selectedCategoryId = ViewBag.SelectedCategoryId as long?;
    
    // Pagination variables
    var currentPage = ViewBag.CurrentPage ?? 1;
    var pageSize = ViewBag.PageSize ?? 12;
    var totalPages = ViewBag.TotalPages ?? 1;
}

<style>
    /* --- CSS CHO ICON PH√ÇN LO·∫†I (APP STYLE) - Responsive --- */
    .category-scroll-container {
        display: flex;
        gap: 1rem;
        padding: 0.75rem 0.5rem;
        overflow-x: auto;
        scrollbar-width: none;
        -webkit-overflow-scrolling: touch;
    }

        .category-scroll-container::-webkit-scrollbar {
            display: none;
        }

    .category-pill {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        min-width: 70px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none !important;
        flex-shrink: 0;
    }

    @@media (min-width: 640px) {
        .category-pill {
            min-width: 80px;
            gap: 0.75rem;
        }
        .category-scroll-container {
            gap: 1.5rem;
            padding: 1rem 0.5rem;
        }
    }

    .category-pill-icon {
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        background: #f8fafc;
        border-radius: 20px;
        transition: all 0.3s ease;
    }

    @@media (min-width: 640px) {
        .category-pill-icon {
            width: 68px;
            height: 68px;
            font-size: 1.8rem;
            border-radius: 24px;
        }
    }

    .category-pill span {
        font-size: 10px;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    @@media (min-width: 640px) {
        .category-pill span {
            font-size: 12px;
        }
    }

    /* Tr·∫°ng th√°i khi ƒëang ch·ªçn (Active) - S·ª≠ d·ª•ng m√†u cam m·ªõi */
    .category-pill-active .category-pill-icon {
        background: #f59e0b; /* Amber-500 */
        color: white;
        box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.4); /* Amber shadow */
        transform: translateY(-5px);
    }

    .category-pill-active span {
        color: #d97706; /* Amber-600 text */
    }

    /* SVG Icon Color */
    .category-pill-active .category-pill-icon svg path {
        fill: white;
    }

    .category-pill:not(.category-pill-active) .category-pill-icon svg path {
        fill: #64748b; /* M√†u x√°m khi kh√¥ng ch·ªçn */
    }

    /* Hover nh·∫π */
    .category-pill:not(.category-pill-active):hover .category-pill-icon {
        background: #f1f5f9;
        transform: translateY(-3px);
    }

    /* --- CSS CHO CARD S·∫¢N PH·∫®M - Responsive --- */
    .product-card {
        border-radius: 1.25rem;
        transition: all 0.3s ease;
        border: 1px solid rgba(0,0,0,0.04);
        background: #fff;
        padding-bottom: 0.5rem;
    }

    @@media (min-width: 640px) {
        .product-card {
            border-radius: 1.75rem;
        }
    }

    @@media (hover: hover) {
        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }
    }

    @@media (max-width: 639px) {
        .product-card:active {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<div class="container mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-8">
    <!-- Header Section - Responsive -->
    <div class="flex flex-col gap-4 sm:gap-6 mb-6 sm:mb-8 md:mb-10">
        <!-- Title and Actions Row -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <!-- Title Section -->
            <div>
                <h1 class="text-2xl sm:text-3xl font-black text-gray-900 tracking-tight">Th·ª±c ƒë∆°n nh√† h√†ng</h1>
                <p class="text-gray-500 text-sm sm:text-base font-medium mt-1">Danh s√°ch m√≥n ƒÉn hi·ªán c√≥</p>
            </div>
            
            <!-- Actions Group: Search Only (No Create Button) -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full md:w-auto">
                <!-- Search Box (Red Focus style) -->
                <div class="relative flex-1 sm:flex-initial w-full sm:w-64">
                     <input type="text" 
                           id="productSearchInput" 
                           placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." 
                           autocomplete="off"
                           class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-all duration-200 text-gray-700 placeholder-gray-400">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    
                    <!-- Autocomplete Suggestions Dropdown -->
                    <div id="searchSuggestions" 
                         class="absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden z-50 hidden">
                        <!-- Suggestions will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (categories != null && categories.Any())
    {
        <!-- Category Filter Pills - Responsive padding -->
        <div class="category-scroll-container mb-6 sm:mb-8 md:mb-12 justify-start sm:justify-center">
            <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = (long?)null })"
               class="category-pill @(selectedCategoryId == null ? "category-pill-active" : "")">
                <div class="category-pill-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
                    </svg>
                </div>
                <span>T·∫•t c·∫£</span>
            </a>

            @foreach (var cat in categories)
            {
                var isActive = selectedCategoryId.HasValue && selectedCategoryId.Value == cat.DanhMucID;
                string icon = "üçΩÔ∏è"; // Default icon
                var upperName = (cat.TenDanhMuc ?? "").ToUpperInvariant();

                // Icon mapping
                if (upperName.Contains("SASHIMI")) { icon = "ü•¢"; }  
                else if (upperName.Contains("SUSHI") || upperName.Contains("SHUSHI")) { icon = "üç£"; } 
                else if (upperName.Contains("C∆†M") || upperName.Contains("M√å")) { icon = "üçú"; } 
                else if (upperName.Contains("TEISHOKU")) { icon = "üç±"; } 
                else if (upperName.Contains("U·ªêNG") || upperName.Contains("N∆Ø·ªöC")) { icon = "ü•§"; } 
                else if (upperName.Contains("TR√ÅNG MI·ªÜNG")) { icon = "üç∞"; } 
                
                <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = cat.DanhMucID })"
                   class="category-pill @(isActive ? "category-pill-active" : "")">
                    <div class="category-pill-icon">@icon</div>
                    <span>@cat.TenDanhMuc</span>
                </a>
            }
        </div>
    }


    <!-- Product Grid - Responsive -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 md:gap-8 lg:gap-10">
        @if (Model != null && Model.Any())
        {
            foreach (var item in Model)
            {
            var hasDiscount = item.GiaGiam.HasValue && item.GiaGiam.Value > 0 && item.GiaGiam.Value < item.GiaGoc;
            decimal currentPrice = hasDiscount ? item.GiaGiam.Value : item.Gia;
            var safeName = System.Web.HttpUtility.JavaScriptStringEncode(item.TenMon ?? "m√≥n ƒÉn n√†y");
            
            // Check label status
            var isStopped = item.TrangThai == "Ng·ª´ng ph·ª•c v·ª•" || item.TrangThai == "H·∫øt m√≥n";

            <div class="product-card flex flex-col overflow-hidden @(isStopped ? "opacity-75" : "") cursor-pointer group" 
                 id="product-card-@item.MonAnID" 
                 onclick="openProductDetailsModal(@item.MonAnID)">
                <div class="relative h-48 sm:h-52 md:h-56 bg-gray-50 overflow-hidden">

                    <img src="@Url.Content(string.IsNullOrEmpty(item.HinhAnh) ? "~/Images/default.jpg" : "~/Images/Products/" + item.HinhAnh)"
                         class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 @(isStopped ? "grayscale" : "")" alt="@item.TenMon" />

                    @if (hasDiscount && !isStopped)
                    {
                        var discountPercent = (int)Math.Round(((double)(item.GiaGoc - item.GiaGiam.Value) / (double)item.GiaGoc) * 100);
                        <div class="absolute top-3 right-3 z-10">
                            <span class="bg-amber-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-sm">
                                -@discountPercent%
                            </span>
                        </div>
                    }
                    
                    @* LABEL CHO M√ìN NG·ª™NG PH·ª§C V·ª§ (User requested) *@
                    @if (isStopped)
                    {
                        <div class="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center z-20">
                            <span class="bg-red-600 text-white text-sm font-bold px-4 py-2 rounded-lg uppercase shadow-lg transform -rotate-12 border-2 border-white">
                                NG·ª™NG PH·ª§C V·ª§
                            </span>
                        </div>
                    }
                </div>

                <div class="px-3 sm:px-4 pt-3 pb-3 flex-1 flex flex-col">
                    <h3 class="text-sm sm:text-base font-bold text-gray-800 leading-snug line-clamp-2 mb-2 group-hover:text-amber-600 transition-colors">
                        @item.TenMon
                    </h3>

                    <div class="flex items-baseline gap-2 mt-auto">
                        <span class="text-lg sm:text-xl md:text-[20px] font-black @(isStopped ? "text-gray-500" : "text-amber-600") leading-tight">
                            @currentPrice.ToString("N0")ƒë
                        </span>
                        @if(hasDiscount && !isStopped) {
                            <span class="text-xs sm:text-sm text-gray-400 line-through font-semibold">
                                @item.GiaGoc.ToString("N0")ƒë
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    }
    </div>
    
    @* Pagination - Responsive *@
    @if (totalPages > 1)
    {
        <div class="mt-6 sm:mt-8 px-4 sm:px-6 py-4 bg-white rounded-xl shadow-md overflow-x-auto">
            <div class="flex items-center justify-center gap-1 sm:gap-2 min-w-max">
                @Html.Raw(RenderPagination())
            </div>
            <div class="text-center mt-3 text-xs sm:text-sm text-gray-600">Trang @currentPage / @totalPages</div>
        </div>
    }
</div>

<!-- Product Details Modal (Inlined & Modified for Employee) -->
<div id="productDetailsModal" class="auth-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div class="auth-modal-container auth-modal-large" style="background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 0; position: relative;">
        
        <button type="button" class="auth-close-btn" onclick="closeProductDetailsModal()" style="position: absolute; top: 15px; right: 15px; background: white; border-radius: 50%; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">&times;</button>
        
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Large Image -->
            <div class="w-full md:w-1/2 bg-gray-100 flex items-center justify-center p-6" style="min-height: 400px;">
                <img id="detailProductImage" src="" alt="Product Image" class="w-full h-auto rounded-xl shadow-lg transform transition-transform hover:scale-105 duration-300 object-cover" style="max-height: 350px;">
            </div>

            <!-- Right: Details -->
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-between">
                <div>
                   <!-- Header -> Title & Badges -->
                   <div class="flex items-start justify-between mb-4">
                       <div>
                           <h2 class="text-2xl font-bold text-gray-900 mb-2 leading-tight" id="detailProductName">Sushi C√° H·ªìi</h2>
                            <div class="flex gap-2">
                                <span id="detailProductStatus" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold uppercase tracking-wide">HO·∫†T ƒê·ªòNG</span>
                                <span id="detailProductFeaturedBadge" class="hidden px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold uppercase tracking-wide">N·ªîI B·∫¨T</span>
                            </div>
                       </div>
                   </div>

                   <!-- Price Section -->
                   <div class="mb-8">
                       <div class="flex items-baseline gap-3">
                           <span class="text-4xl font-extrabold text-red-600" id="detailProductPriceDisplay">300.000ƒë</span>
                       </div>
                       <div class="flex items-center gap-4 mt-2" id="detailDiscountContainer">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-400 font-bold uppercase tracking-wider">Gi√° g·ªëc</span>
                                <span class="line-through text-gray-500 font-medium" id="detailProductOriginalPrice">500.000ƒë</span>
                            </div>
                            <span class="px-3 py-1 bg-rose-100 text-rose-600 text-sm font-bold rounded-lg" id="detailDiscountBadge">Gi·∫£m 40%</span>
                       </div>
                   </div>

                   <!-- Details Grid -->
                   <div class="grid grid-cols-2 gap-y-6 gap-x-4 mb-8">
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Danh m·ª•c</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailProductCategory">TR√ÅNG MI·ªÜNG</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">ƒê∆°n v·ªã t√≠nh</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailProductUnit">Ph·∫ßn</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Ng√†y t·∫°o</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailProductCreatedDate">21/12/2025</span>
                       </div>
                       <!-- Hidden ID for employee, not important -->
                   </div>
                </div>

                <!-- Footer Buttons -->
                <div class="flex items-center gap-3 mt-auto justify-end">
                    <button type="button" onclick="closeProductDetailsModal()" class="px-6 py-2.5 bg-gray-50 border border-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-100 transition-all active:scale-95 cursor-pointer">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- PRODUCT SEARCH with AUTOCOMPLETE FUNCTIONALITY ---
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('productSearchInput');
        const suggestionsBox = document.getElementById('searchSuggestions');
        if (!searchInput || !suggestionsBox) return;

        let allProducts = [];
        
        // Build product list from DOM

        function buildProductList() {
            const productCards = document.querySelectorAll('[id^="product-card-"]');
            allProducts = [];
            
            productCards.forEach(function (card) {
                const nameEl = card.querySelector('h3');
                const imgEl = card.querySelector('img');
                if (nameEl) {
                    allProducts.push({
                        id: card.id,
                        name: nameEl.textContent.trim(),
                        image: imgEl ? imgEl.src : '',
                        card: card
                    });
                }
            });
        }
        
        buildProductList();

        // Show autocomplete suggestions
        function showSuggestions(searchTerm) {
            if (!searchTerm || searchTerm.length < 1) {
                suggestionsBox.classList.add('hidden');
                return;
            }

            const matches = allProducts.filter(function (product) {
                return product.name.toLowerCase().includes(searchTerm.toLowerCase());
            }).slice(0, 6); // Limit to 6 suggestions

            if (matches.length === 0) {
                suggestionsBox.classList.add('hidden');
                return;
            }

            // Build suggestions HTML
            let html = '';
            matches.forEach(function (product) {
                const highlightedName = highlightMatch(product.name, searchTerm);
                html += `
                    <div class="suggestion-item px-3 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex items-center gap-3 transition-colors"
                         data-product-id="${product.id}">
                        <div class="w-10 h-10 rounded-lg overflow-hidden border border-gray-200 flex-shrink-0 bg-white">
                             <img src="${product.image}" alt="" class="w-full h-full object-cover">
                        </div>
                        <span class="text-sm font-medium text-gray-700 flex-1">${highlightedName}</span>
                    </div>
                `;
            });

            suggestionsBox.innerHTML = html;
            suggestionsBox.classList.remove('hidden');

            // Add click handlers to suggestions
            const suggestionItems = suggestionsBox.querySelectorAll('.suggestion-item');
            suggestionItems.forEach(function (item) {
                item.addEventListener('click', function () {
                    const productId = this.getAttribute('data-product-id');
                    searchInput.value = this.textContent.trim();
                    performSearch(searchInput.value);
                    suggestionsBox.classList.add('hidden');
                });
            });
        }

        // Highlight matching text
        function highlightMatch(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<strong class="font-semibold text-gray-900">$1</strong>');
        }

        // Perform actual search (Client-side filtering for current page)
        function performSearch(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            const productCards = document.querySelectorAll('[id^="product-card-"]');

            productCards.forEach(function (card) {
                const productName = card.querySelector('h3');
                if (!productName) return;

                const nameText = productName.textContent.toLowerCase();

                if (term === '' || nameText.includes(term)) {
                    card.style.display = '';
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                } else {
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.95)';
                    setTimeout(function () {
                        if (card.style.opacity === '0') {
                            card.style.display = 'none';
                        }
                    }, 200);
                }
            });
        }

        // Input event - show suggestions
        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.trim();
            showSuggestions(searchTerm);
        });

        // Enter key to search
        searchInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                performSearch(searchInput.value);
                suggestionsBox.classList.add('hidden');
            } else if (e.key === 'Escape') {
                searchInput.value = '';
                performSearch('');
                suggestionsBox.classList.add('hidden');
                searchInput.blur();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function (e) {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });
    });

    // --- MODAL LOGIC (Copied & Cleaned for Employee) ---
    function openProductDetailsModal(productId) {
        const modal = document.getElementById('productDetailsModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Reset and Load
        document.getElementById('detailProductName').textContent = 'ƒêang t·∫£i...';
        
        // Use Employee Area URL
        fetch(`/Employee_65133141/Menu/GetProductDetails/${productId}`)
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    populateNewProductDetails(data.data);
                } else {
                    alert(data.message);
                    closeProductDetailsModal();
                }
            })
            .catch(err => {
                console.error(err);
                alert('L·ªói k·∫øt n·ªëi');
            });
    }

    function populateNewProductDetails(p) {
        document.getElementById('detailProductName').textContent = p.TenMon;
        document.getElementById('detailProductCategory').textContent = p.TenDanhMuc || 'Kh√¥ng x√°c ƒë·ªãnh';
        document.getElementById('detailProductUnit').textContent = p.DonViTinh || 'Ph·∫ßn';
        
        // Date Formatting
        let dateStr = p.NgayTao; 
        if(dateStr) {
             const d = new Date(dateStr);
             if(!isNaN(d.getTime())) dateStr = d.toLocaleDateString('vi-VN');
        }
        document.getElementById('detailProductCreatedDate').textContent = dateStr || '-';

        // Status Logic
        const statusEl = document.getElementById('detailProductStatus');
        const statusText = p.TrangThai;
        
        statusEl.textContent = statusText;
        let statusClasses = 'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ';
        
        if (statusText === 'Ho·∫°t ƒë·ªông' || statusText === 'ƒêang ph·ª•c v·ª•') {
            statusEl.className = statusClasses + 'bg-green-100 text-green-700';
        } else if (statusText === 'T·∫°m h·∫øt') {
            statusEl.className = statusClasses + 'bg-gray-100 text-gray-600';
        } else {
            // Ng·ª´ng ph·ª•c v·ª•
            statusEl.className = statusClasses + 'bg-red-100 text-red-700';
        }

        // Image
        const imgPath = p.HinhAnh ? `/Images/Products/${p.HinhAnh}` : '/Images/default.jpg';
        document.getElementById('detailProductImage').src = imgPath;

        // Price Logic
        const priceDisplay = document.getElementById('detailProductPriceDisplay');
        const originalPriceDisplay = document.getElementById('detailProductOriginalPrice');
        const discountContainer = document.getElementById('detailDiscountContainer');
        const discountBadge = document.getElementById('detailDiscountBadge');

        const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        if (p.GiaGiam && p.GiaGiam > 0 && p.GiaGiam < p.GiaGoc) {
             priceDisplay.textContent = formatter.format(p.GiaGiam);
             originalPriceDisplay.textContent = formatter.format(p.GiaGoc);
             const percent = Math.round(((p.GiaGoc - p.GiaGiam) / p.GiaGoc) * 100);
             discountBadge.textContent = `Gi·∫£m ${percent}%`;
             
             discountContainer.classList.remove('hidden');
             discountContainer.classList.add('flex');
             priceDisplay.classList.add('text-red-600');
             priceDisplay.classList.remove('text-gray-900');
        } else {
             priceDisplay.textContent = formatter.format(p.GiaGoc);
             discountContainer.classList.add('hidden');
             discountContainer.classList.remove('flex');
             priceDisplay.classList.add('text-gray-900');
             priceDisplay.classList.remove('text-red-600');
        }
    }

    function closeProductDetailsModal() {
        document.getElementById('productDetailsModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // Close on ESC
    document.addEventListener('keydown', e => {
        if(e.key === 'Escape') {
             if(document.getElementById('productDetailsModal').style.display === 'flex') closeProductDetailsModal();
        }
    });

    document.addEventListener('click', e => {
        const m = document.getElementById('productDetailsModal');
        if(e.target === m) closeProductDetailsModal();
    });
</script>

@helper RenderPagination()
{
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    long? categoryId = ViewBag.SelectedCategoryId as long?;

    if (totalPages <= 1) { return; }

    <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = categoryId, page = 1 })"
       class="w-9 h-9 rounded-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center @(currentPage == 1 ? "opacity-50 pointer-events-none" : "")">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
    </a>

    <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = categoryId, page = currentPage - 1 })"
       class="w-9 h-9 rounded-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center @(currentPage == 1 ? "opacity-50 pointer-events-none" : "")">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
    </a>

    int startPage = Math.Max(1, currentPage - 2);
    int endPage = Math.Min(totalPages, currentPage + 2);

    if (startPage > 1)
    {
        <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = categoryId, page = 1 })"
           class="w-9 h-9 rounded-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center text-sm font-medium">1</a>
        if (startPage > 2)
        {
            <span class="px-2 text-gray-500">...</span>
        }
    }

    for (int i = startPage; i <= endPage; i++)
    {
        <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = categoryId, page = i })"
           class="w-9 h-9 rounded-full flex items-center justify-center text-sm font-medium @(i == currentPage ? "bg-amber-600 text-white" : "border border-gray-300 hover:bg-gray-50")">@i</a>
    }

    if (endPage < totalPages)
    {
        if (endPage < totalPages - 1)
        {
            <span class="px-2 text-gray-500">...</span>
        }
        <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = categoryId, page = totalPages })"
           class="w-9 h-9 rounded-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center text-sm font-medium">@totalPages</a>
    }

    <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = categoryId, page = currentPage + 1 })"
       class="w-9 h-9 rounded-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center @(currentPage == totalPages ? "opacity-50 pointer-events-none" : "")">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
    </a>

    <a href="@Url.Action("Index", "Menu", new { area = "Employee_65133141", categoryId = categoryId, page = totalPages })"
       class="w-9 h-9 rounded-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center @(currentPage == totalPages ? "opacity-50 pointer-events-none" : "")">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
    </a>
}
