@model IEnumerable<Project_65133141.Models.DatBan>

@{
    ViewBag.Title = "Quản lý đặt bàn";
    Layout = "~/Areas/Employee_65133141/Views/Shared/_Layout.cshtml";

    var searchString = ViewBag.SearchString as string;
    var statusFilter = ViewBag.StatusFilter as string;
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var totalItems = ViewBag.TotalItems ?? 0;
    var statuses = ViewBag.Statuses as List<string> ?? new List<string>();
}

<!-- Alert Container (Fixed Top Right) -->
<div id="alertContainer" class="fixed top-20 right-4 z-[10000] space-y-2 max-w-md"></div>

<div class="container mx-auto px-4 py-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Quản lý đặt bàn</h1>
    </div>

    <!-- Stats & Actions -->
    <div class="mb-6 flex items-center justify-between">
        <div class="text-gray-600">
            <p>Tổng số: <span class="font-semibold text-gray-900">@totalItems</span> đặt bàn</p>
        </div>
        <button type="button" onclick="openCreateDatBanModal()" 
                class="px-4 py-2 bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 text-white rounded-lg font-medium flex items-center gap-2 transition-all shadow-md hover:shadow-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Đặt bàn mới
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="mb-6 flex flex-wrap items-end gap-3 justify-end">
        @using (Html.BeginForm("Index", "DatBan", new { area = "Employee_65133141" }, FormMethod.Get, new { @class = "flex flex-wrap items-end gap-3" }))
        {
            <div class="relative">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                </div>
                <select name="statusFilter" onchange="this.form.submit()" 
                        class="pl-10 pr-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-teal-400 focus:ring-2 focus:ring-teal-200 transition-all text-sm font-medium text-gray-700 appearance-none bg-white cursor-pointer">
                    <option value="all" @(string.IsNullOrEmpty(statusFilter) || statusFilter == "all" ? "selected" : "")>Tất cả trạng thái</option>
                    @foreach (var status in statuses)
                    {
                        <option value="@status" @(statusFilter == status ? "selected" : "")>@status</option>
                    }
                </select>
            </div>

            <div class="relative">
                <input type="text" name="searchString" value="@searchString"
                       placeholder="Tìm theo tên, SĐT, bàn..."
                       class="w-64 pl-10 pr-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-teal-400 focus:ring-2 focus:ring-teal-200 transition-all text-sm font-medium text-gray-700 placeholder-gray-400"
                       onchange="this.form.submit()" />
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        }
    </div>

    <!-- Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SĐT</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bàn</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số người</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                @if (Model != null && Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#@item.DatBanID</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@(item.HoTenKhach ?? "N/A")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@(item.SDTKhach ?? "N/A")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @if (item.BanAn != null)
                                {
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        @item.BanAn.TenBan
                                    </span>
                                }
                                else
                                {
                                    <span class="text-gray-400">Chưa chọn</span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @item.ThoiGianDen.ToString("dd/MM/yyyy HH:mm")
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@(item.SoNguoi?.ToString() ?? "N/A")</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @{
                                    var statusClass = "bg-gray-100 text-gray-800";
                                    if (item.TrangThai == "Đã xác nhận") { statusClass = "bg-green-100 text-green-800"; }
                                    else if (item.TrangThai == "Đang phục vụ") { statusClass = "bg-blue-100 text-blue-800"; }
                                    else if (item.TrangThai == "Hoàn thành") { statusClass = "bg-purple-100 text-purple-800"; }
                                    else if (item.TrangThai == "Đã hủy") { statusClass = "bg-red-100 text-red-800"; }
                                }
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @statusClass">
                                    @(item.TrangThai ?? "Chờ xác nhận")
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center gap-2">
                                    <button type="button" onclick="openDatBanDetailsModal(@item.DatBanID)"
                                            class="text-blue-600 hover:text-blue-900" title="Xem chi tiết">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                    <button type="button" onclick="openEditDatBanModal(@item.DatBanID)"
                                            class="text-blue-600 hover:text-blue-900" title="Sửa">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">Không có đặt bàn nào</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container mt-8">
        <div class="pagination-buttons">
            @if (currentPage > 1)
            {
                <a href="@Url.Action("Index", "DatBan", new { area = "Employee_65133141", page = 1, searchString = searchString, statusFilter = statusFilter })" 
                   class="pagination-btn" title="Trang đầu">«</a>
                <a href="@Url.Action("Index", "DatBan", new { area = "Employee_65133141", page = currentPage - 1, searchString = searchString, statusFilter = statusFilter })" 
                   class="pagination-btn" title="Trang trước">‹</a>
            }
            else
            {
                <span class="pagination-btn disabled">«</span>
                <span class="pagination-btn disabled">‹</span>
            }

            @{
                int maxPages = 5;
                int startPage = Math.Max(1, currentPage - (maxPages / 2));
                int endPage = Math.Min(totalPages, startPage + maxPages - 1);
                
                if (endPage - startPage < maxPages - 1)
                {
                    startPage = Math.Max(1, endPage - maxPages + 1);
                }
            }

            @for (int i = startPage; i <= endPage; i++)
            {
                <a href="@Url.Action("Index", "DatBan", new { area = "Employee_65133141", page = i, searchString = searchString, statusFilter = statusFilter })" 
                   class="pagination-btn @(i == currentPage ? "active" : "")">@i</a>
            }

            @if (currentPage < totalPages)
            {
                <a href="@Url.Action("Index", "DatBan", new { area = "Employee_65133141", page = currentPage + 1, searchString = searchString, statusFilter = statusFilter })" 
                   class="pagination-btn" title="Trang sau">›</a>
                <a href="@Url.Action("Index", "DatBan", new { area = "Employee_65133141", page = totalPages, searchString = searchString, statusFilter = statusFilter })" 
                   class="pagination-btn" title="Trang cuối">»</a>
            }
            else
            {
                <span class="pagination-btn disabled">›</span>
                <span class="pagination-btn disabled">»</span>
            }
        </div>
        <div class="pagination-info">Trang @currentPage / @totalPages</div>
    </div>
</div>

<!-- =========================================================================================
     MODAL: CHI TIẾT ĐẶT BÀN (DatBan Details)
     Style: Split Layout (Info Card + Details), Teal Theme
     ========================================================================================= -->
<div id="datBanDetailsModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 800px; padding: 0;">
        <button type="button" class="auth-close-btn" onclick="closeDatBanDetailsModal()" style="position: absolute; top: 15px; right: 15px; background: white; border-radius: 50%; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; color: #6b7280; z-index: 10;">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Info Card (Teal Gradient) -->
            <div class="w-full md:w-1/2 bg-gradient-to-br from-teal-50 to-emerald-50 flex items-center justify-center p-6" style="min-height: 400px;">
                <div class="w-full max-w-sm">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="text-center mb-4">
                            <!-- Icon -->
                            <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-10 h-10 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900" id="detailDatBanId">#000000</h3>
                            <p class="text-sm text-gray-500 mt-1">Mã đặt bàn</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Trạng thái</span>
                                <span id="detailDatBanStatus" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase">-</span>
                            </div>
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Số người</span>
                                <span class="text-sm font-semibold text-gray-800" id="detailDatBanSoNguoi">-</span>
                            </div>
                            <div>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1">Thời gian đến</span>
                                <span class="text-sm font-semibold text-gray-800" id="detailDatBanThoiGian">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Details -->
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-between">
                <div>
                   <!-- Header -->
                   <div class="flex items-start justify-between mb-4">
                       <div>
                           <h2 class="text-2xl font-bold text-gray-900 mb-2 leading-tight" id="detailDatBanKhachHang">-</h2>
                           <div class="flex gap-2">
                               <span id="detailDatBanStatusBadge" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-bold uppercase tracking-wide">-</span>
                           </div>
                       </div>
                   </div>

                   <!-- Details Grid -->
                   <div class="grid grid-cols-1 gap-y-6 mb-8">
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Số điện thoại</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailDatBanSDT">-</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Bàn</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailDatBanBan">-</span>
                       </div>
                       <div>
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Ngày tạo</span>
                           <span class="block text-sm font-semibold text-gray-800" id="detailDatBanNgayTao">-</span>
                       </div>
                       <div id="detailDatBanGhiChuContainer" class="hidden">
                           <span class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Ghi chú</span>
                           <p class="text-sm text-gray-600 leading-relaxed" id="detailDatBanGhiChu">-</p>
                       </div>
                   </div>
                </div>

                <!-- Footer Buttons -->
                <div class="flex items-center gap-3 mt-auto">
                    <button type="button" onclick="openEditFromDetails()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 text-white rounded-xl font-bold text-sm transition-all shadow-md hover:shadow-lg transform active:scale-95 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        Sửa đặt bàn
                    </button>
                    <button type="button" onclick="closeDatBanDetailsModal()" class="px-6 py-2.5 bg-gray-50 border border-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-100 transition-all active:scale-95">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- =========================================================================================
     MODAL: CẬP NHẬT ĐẶT BÀN (Edit DatBan)
     Style: Auth Form Modal, Teal Theme
     ========================================================================================= -->
<div id="editDatBanModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 800px; position: relative;">
        <button type="button" class="auth-close-btn" onclick="closeEditDatBanModal()" style="position: absolute; top: 15px; right: 15px; background: white; border-radius: 50%; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 20; color: #6b7280; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer;">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div class="auth-modal-header">
            <div class="auth-logo" style="background: #ecfdf5; color: #0d9488;">
                <svg class="w-full h-full p-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            <h2 class="auth-modal-title">Cập nhật đặt bàn</h2>
            <p class="auth-modal-subtitle">Chỉnh sửa thông tin đặt bàn của khách hàng</p>
        </div>

        <div class="auth-modal-body">
            @using (Html.BeginForm("Edit", "DatBan", new { area = "Employee_65133141" }, FormMethod.Post, new { id = "editDatBanForm" }))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" name="DatBanID" id="editDatBanID" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Column 1 -->
                    <div class="space-y-4">
                         <div class="auth-form-group">
                            <label class="auth-form-label">Họ tên khách hàng <span class="auth-required">*</span></label>
                            <div class="auth-input-wrapper">
                                <input type="text" name="HoTenKhach" id="editHoTenKhach" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" required />
                            </div>
                        </div>

                         <div class="auth-form-group">
                            <label class="auth-form-label">Bàn ăn</label>
                            <div class="auth-input-wrapper">
                                <select name="BanID" id="editBanID" class="auth-form-control focus:border-teal-500 focus:ring-teal-200">
                                    <option value="">-- Chọn bàn --</option>
                                    <!-- Populated via JS -->
                                </select>
                            </div>
                        </div>

                        <div class="auth-form-group">
                            <label class="auth-form-label">Thời gian đến <span class="auth-required">*</span></label>
                            <div class="auth-input-wrapper">
                                <input type="datetime-local" name="ThoiGianDen" id="editThoiGianDen" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" required />
                            </div>
                        </div>
                    </div>

                    <!-- Column 2 -->
                    <div class="space-y-4">
                         <div class="auth-form-group">
                            <label class="auth-form-label">Số điện thoại <span class="auth-required">*</span></label>
                            <div class="auth-input-wrapper">
                                <input type="tel" name="SDTKhach" id="editSDTKhach" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" required />
                            </div>
                        </div>

                         <div class="auth-form-group">
                            <label class="auth-form-label">Số người</label>
                            <div class="auth-input-wrapper">
                                <input type="number" name="SoNguoi" id="editSoNguoi" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" min="1" />
                            </div>
                        </div>

                        <div class="auth-form-group">
                            <label class="auth-form-label">Trạng thái <span class="auth-required">*</span></label>
                            <div class="auth-input-wrapper">
                                <select name="TrangThai" id="editTrangThai" class="auth-form-control focus:border-teal-500 focus:ring-teal-200">
                                    <option value="Chờ xác nhận">Chờ xác nhận</option>
                                    <option value="Đã xác nhận">Đã xác nhận</option>
                                    <option value="Đang phục vụ">Đang phục vụ</option>
                                    <option value="Hoàn thành">Hoàn thành</option>
                                    <option value="Đã hủy">Đã hủy</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="auth-form-group mt-4">
                    <label class="auth-form-label">Ghi chú</label>
                    <div class="auth-input-wrapper">
                        <textarea name="GhiChu" id="editGhiChu" rows="3" class="auth-form-control focus:border-teal-500 focus:ring-teal-200"></textarea>
                    </div>
                </div>

                <div class="auth-btn-group mt-6">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeEditDatBanModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 shadow-teal-500/30">Lưu thay đổi</button>
                </div>
            }
</div>
    </div>
</div>

<!-- =========================================================================================
     MODAL: TẠO ĐẶT BÀN MỚI (Create Offline Reservation)
     Style: Auth Form Modal, Teal Theme
     ========================================================================================= -->
<div id="createDatBanModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large" style="max-width: 800px; position: relative;">
        <button type="button" class="auth-close-btn" onclick="closeCreateDatBanModal()" style="position: absolute; top: 15px; right: 15px; background: white; border-radius: 50%; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 20; color: #6b7280; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer;">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div class="auth-modal-header">
            <div class="auth-logo" style="background: #ecfdf5; color: #0d9488;">
                <svg class="w-full h-full p-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            </div>
            <h2 class="auth-modal-title">Đặt bàn offline</h2>
            <p class="auth-modal-subtitle">Tạo đặt bàn cho khách hàng walk-in hoặc qua điện thoại</p>
        </div>

        <div class="auth-modal-body">
            <form id="createDatBanForm" method="post" action="@Url.Action("Create", "DatBan", new { area = "Employee_65133141" })">
                @Html.AntiForgeryToken()

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Column 1 -->
                    <div class="space-y-4">
                         <div class="auth-form-group">
                            <label class="auth-form-label">Họ tên khách hàng <span class="auth-required">*</span></label>
                            <div class="auth-input-wrapper">
                                <input type="text" name="customerName" id="createCustomerName" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" required />
                            </div>
                        </div>

                         <div class="auth-form-group">
                            <label class="auth-form-label">Email</label>
                            <div class="auth-input-wrapper">
                                <input type="email" name="customerEmail" id="createCustomerEmail" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" />
                            </div>
                        </div>

                        <div class="auth-form-group">
                            <label class="auth-form-label">Thời gian đến <span class="auth-required">*</span></label>
                            <div class="auth-input-wrapper">
                                <input type="datetime-local" name="ThoiGianDen" id="createThoiGianDen" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" required />
                            </div>
                        </div>
                    </div>

                    <!-- Column 2 -->
                    <div class="space-y-4">
                         <div class="auth-form-group">
                            <label class="auth-form-label">Số điện thoại <span class="auth-required">*</span></label>
                            <div class="auth-input-wrapper">
                                <input type="tel" name="customerPhone" id="createCustomerPhone" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" pattern="[0-9]{10}" required />
                                <small class="text-gray-500 text-xs mt-1 block">10 chữ số</small>
                            </div>
                        </div>

                         <div class="auth-form-group">
                            <label class="auth-form-label">Số người</label>
                            <div class="auth-input-wrapper">
                                <input type="number" name="datBan.SoNguoi" id="createSoNguoi" class="auth-form-control focus:border-teal-500 focus:ring-teal-200" min="1" value="2" />
                            </div>
                        </div>

                        <div class="auth-form-group">
                            <label class="auth-form-label">Bàn ăn</label>
                            <div class="auth-input-wrapper">
                                <select name="datBan.BanID" id="createBanID" class="auth-form-control focus:border-teal-500 focus:ring-teal-200">
                                    <option value="">-- Chọn bàn --</option>
                                    <!-- Populated via JS -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="auth-form-group mt-4">
                    <label class="auth-form-label">Ghi chú</label>
                    <div class="auth-input-wrapper">
                        <textarea name="datBan.GhiChu" id="createGhiChu" rows="3" class="auth-form-control focus:border-teal-500 focus:ring-teal-200"></textarea>
                    </div>
                </div>

                <div class="auth-btn-group mt-6">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeCreateDatBanModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 shadow-teal-500/30">Đặt bàn</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // ==========================================================
    // ALERT SYSTEM (Matched with Admin)
    // ==========================================================
    function showAlert(type, message) {
        var container = document.getElementById('alertContainer');
        if (!container) return;

        var alertId = 'alert-' + Date.now();

        var config = {
            success: {
                bg: 'bg-green-100 border border-green-200 text-green-900',
                iconBg: 'bg-green-500 text-white',
                title: 'Thành công!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
            },
            error: {
                bg: 'bg-red-100 border border-red-200 text-red-900',
                iconBg: 'bg-red-500 text-white',
                title: 'Lỗi!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14"></path><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
            },
            warning: {
                bg: 'bg-amber-100 border border-amber-200 text-amber-900',
                iconBg: 'bg-amber-500 text-white',
                title: 'Cảnh báo!',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 3h.01M10.29 4.21l-6.6 11.45A1 1 0 004.53 18h14.94a1 1 0 00.86-1.5l-6.6-11.45a1 1 0 00-1.74 0z"/></svg>'
            },
            info: {
                bg: 'bg-sky-100 border border-sky-200 text-sky-900',
                iconBg: 'bg-sky-500 text-white',
                title: 'Thông tin',
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01" /><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"></circle></svg>'
            }
        };

        var cfg = config[type] || config.info;

        var html = `
        <div id="${alertId}" class="${cfg.bg} px-3 py-2 rounded-lg shadow-md flex items-center gap-2 max-w-md transition-all duration-300 translate-x-full bg-opacity-95 border border-white/60">
            <div class="w-7 h-7 rounded-full ${cfg.iconBg} flex items-center justify-center flex-shrink-0">
                ${cfg.icon}
            </div>
            <div class="flex-1">
                <div class="font-semibold text-sm mb-0.5">${cfg.title}</div>
                <div class="text-sm leading-snug">${message}</div>
            </div>
            <button type="button" class="ml-2 text-current/70 hover:text-current" aria-label="Đóng thông báo"
                    onclick="(function(){ var el = document.getElementById('${alertId}'); if(el){ el.classList.add('translate-x-full'); setTimeout(function(){ el.remove(); }, 250); } })()">
                &#10005;
            </button>
        </div>`;

        container.insertAdjacentHTML('beforeend', html);

        setTimeout(function () {
            var el = document.getElementById(alertId);
            if (el) el.classList.remove('translate-x-full');
        }, 10);

        setTimeout(function () {
            var el = document.getElementById(alertId);
            if (el) {
                el.classList.add('translate-x-full');
                setTimeout(function () { el.remove(); }, 250);
            }
        }, 4000);
    }
    
    // Global variable to store current ID for switching between modals
    var currentDetailDatBanId = 0;

    // ==========================================================
    // CREATE MODAL LOGIC
    // ==========================================================
    function openCreateDatBanModal() {
        var modal = document.getElementById('createDatBanModal');
        if (!modal) return;

        // Reset form
        document.getElementById('createDatBanForm').reset();
        
        // Set default arrival time (now + 1 hour)
        var now = new Date();
        now.setHours(now.getHours() + 1);
        var datetime = now.toISOString().slice(0, 16);
        document.getElementById('createThoiGianDen').value = datetime;

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Load available tables for current time
        loadAvailableTablesForCreate(datetime);
    }

    function closeCreateDatBanModal() {
        var modal = document.getElementById('createDatBanModal');
        if(modal) modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function loadAvailableTablesForCreate(datetime) {
        var select = document.getElementById('createBanID');
        select.innerHTML = '<option value="">Đang tải...</option>';

        // Convert datetime-local format to proper URL-friendly format
        var dateObj = new Date(datetime);
        var formattedDate = dateObj.getFullYear() + '-' + 
                           String(dateObj.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(dateObj.getDate()).padStart(2, '0') + ' ' +
                           String(dateObj.getHours()).padStart(2, '0') + ':' +
                           String(dateObj.getMinutes()).padStart(2, '0') + ':00';

        var url = '@Url.Action("GetAvailableTables", "DatBan", new { area = "Employee_65133141" })';
        url += '?arrivalTime=' + encodeURIComponent(formattedDate);

        fetch(url)
            .then(res => {
                if (!res.ok) {
                    throw new Error('HTTP ' + res.status);
                }
                return res.json();
            })
            .then(tables => {
                select.innerHTML = '<option value="">-- Chọn bàn --</option>';
                if (tables && Array.isArray(tables)) {
                    if (tables.length === 0) {
                        select.innerHTML += '<option value="" disabled>Không có bàn trống</option>';
                    }
                    tables.forEach(t => {
                        var option = document.createElement('option');
                        option.value = t.BanID;
                        option.text = `${t.TenBan} (${t.SucChua} ghế) - ${t.ViTri || 'N/A'}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">-- Không có dữ liệu --</option>';
                }
            })
            .catch(err => {
                console.error('Error loading tables:', err);
                select.innerHTML = '<option value="">-- Lỗi: ' + err.message + ' --</option>';
                showAlert('error', 'Không thể tải danh sách bàn. Vui lòng thử lại.');
            });
    }

    // Update available tables when arrival time changes
    document.addEventListener('DOMContentLoaded', function() {
        var timeInput = document.getElementById('createThoiGianDen');
        if (timeInput) {
            timeInput.addEventListener('change', function() {
                loadAvailableTablesForCreate(this.value);
            });
        }
    });

    // Handle Create Form Submit
    document.getElementById('createDatBanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var form = this;
        var formData = new FormData(form);
        var btn = form.querySelector('button[type="submit"]');
        var originalText = btn.textContent;
        
        btn.disabled = true;
        btn.textContent = 'Đang xử lý...';

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(res => res.text())
        .then(html => {
            // Check if response is redirect (success) or form with errors
            if (html.indexOf('ErrorMessage') > -1 || html.indexOf('Lỗi') > -1) {
                // Has errors - reload to show TempData error
                window.location.reload();
            } else {
                // Success
                closeCreateDatBanModal();
                showAlert('success', 'Đặt bàn thành công!');
                setTimeout(() => window.location.reload(), 1000);
            }
        })
        .catch(err => {
            console.error(err);
            showAlert('error', 'Có lỗi xảy ra khi đặt bàn.');
            btn.disabled = false;
            btn.textContent = originalText;
        });
    });

    // ==========================================================
    // DETAILS MODAL LOGIC
    // ==========================================================
    function openDatBanDetailsModal(id) {
        currentDetailDatBanId = id; // Store ID
        var modal = document.getElementById('datBanDetailsModal');
        if (!modal) return;

        // Reset text
        document.getElementById('detailDatBanKhachHang').textContent = 'Đang tải...';
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Fetch Data
        fetch('@Url.Action("GetDatBanDetails", "DatBan", new { area = "Employee_65133141" })/' + id)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    populateDatBanDetails(data.data);
                } else {
                    showAlert('error', data.message);
                    closeDatBanDetailsModal();
                }
            })
            .catch(err => {
                console.error(err);
                showAlert('error', 'Có lỗi xảy ra khi tải thông tin.');
                closeDatBanDetailsModal();
            });
    }

    function populateDatBanDetails(d) {
        document.getElementById('detailDatBanId').textContent = '#' + d.DatBanID.toString().padStart(6, '0');
        document.getElementById('detailDatBanKhachHang').textContent = d.HoTenKhach || 'N/A';
        document.getElementById('detailDatBanSDT').textContent = d.SDTKhach || 'N/A';
        document.getElementById('detailDatBanSoNguoi').textContent = (d.SoNguoi || 0) + ' người';
        
        // Date Format
        let timeStr = '-';
        if (d.ThoiGianDen) {
            // Try to parse JSON date format /Date(123456)/ or ISO string
            let date;
            if (typeof d.ThoiGianDen === 'string' && d.ThoiGianDen.indexOf('/Date') >= 0) {
                 date = new Date(parseInt(d.ThoiGianDen.replace(/\/Date\((-?\d+)\)\//, '$1')));
            } else {
                 date = new Date(d.ThoiGianDen);
            }

            if(!isNaN(date.getTime())) {
                timeStr = date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
            }
        }
        document.getElementById('detailDatBanThoiGian').textContent = timeStr;

        let createdStr = '-';
        if (d.NgayTao) {
             let date;
            if (typeof d.NgayTao === 'string' && d.NgayTao.indexOf('/Date') >= 0) {
                 date = new Date(parseInt(d.NgayTao.replace(/\/Date\((-?\d+)\)\//, '$1')));
            } else {
                 date = new Date(d.NgayTao);
            }

            if(!isNaN(date.getTime())) {
                createdStr = date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
            }
        }
        document.getElementById('detailDatBanNgayTao').textContent = createdStr;

        // Info
        document.getElementById('detailDatBanBan').textContent = d.BanAn || 'Chưa chọn';
        
        // Status
        var statusEl = document.getElementById('detailDatBanStatus');
        var statusBadge = document.getElementById('detailDatBanStatusBadge');
        var status = d.TrangThai || 'Chờ xác nhận';
        
        statusEl.textContent = status;
        statusBadge.textContent = status;
        
        // Colors
        let cls = 'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ';
        if (status === 'Đã xác nhận') cls += 'bg-green-100 text-green-700';
        else if (status === 'Đang phục vụ') cls += 'bg-blue-100 text-blue-700';
        else if (status === 'Hoàn thành') cls += 'bg-purple-100 text-purple-700';
        else if (status === 'Đã hủy') cls += 'bg-red-100 text-red-700';
        else cls += 'bg-gray-100 text-gray-700';
        
        statusEl.className = cls;
        statusBadge.className = cls;

        // Notes
        var noteContainer = document.getElementById('detailDatBanGhiChuContainer');
        if (d.GhiChu) {
            document.getElementById('detailDatBanGhiChu').textContent = d.GhiChu;
            noteContainer.classList.remove('hidden');
        } else {
            noteContainer.classList.add('hidden');
        }
    }

    function closeDatBanDetailsModal() {
        var modal = document.getElementById('datBanDetailsModal');
        if(modal) modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function openEditFromDetails() {
        closeDatBanDetailsModal();
        // Allow time for close animation or just small delay for UX
        setTimeout(() => {
            openEditDatBanModal(currentDetailDatBanId);
        }, 100);
    }

    // ==========================================================
    // EDIT MODAL LOGIC (Using GetReservation endpoint)
    // ==========================================================
    function openEditDatBanModal(id) {
        var modal = document.getElementById('editDatBanModal');
        if (!modal) return;

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Fetch Data AND Tables using GetReservation endpoint
        fetch('@Url.Action("GetReservation", "DatBan", new { area = "Employee_65133141" })/' + id)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    var d = data.data;
                    document.getElementById('editDatBanID').value = d.DatBanID;
                    document.getElementById('editHoTenKhach').value = d.HoTenKhach;
                    document.getElementById('editSDTKhach').value = d.SDTKhach;
                    document.getElementById('editSoNguoi').value = d.SoNguoi;
                    document.getElementById('editGhiChu').value = d.GhiChu;
                    document.getElementById('editTrangThai').value = d.TrangThai;

                    // Date
                    if (d.ThoiGianDen) {
                         document.getElementById('editThoiGianDen').value = d.ThoiGianDen;
                    }

                    // Populate Tables
                    var select = document.getElementById('editBanID');
                    select.innerHTML = '<option value="">-- Chọn bàn --</option>';
                    if (data.tables && Array.isArray(data.tables)) {
                        data.tables.forEach(t => {
                            var option = document.createElement('option');
                            option.value = t.Value;
                            option.text = t.Text;
                            if (t.Value === d.BanID) option.selected = true;
                            select.appendChild(option);
                        });
                    }
                } else {
                    showAlert('error', data.message);
                    closeEditDatBanModal();
                }
            })
            .catch(err => {
                console.error(err);
                showAlert('error', 'Có lỗi xảy ra khi tải dữ liệu.');
                closeEditDatBanModal();
            });
    }

    function closeEditDatBanModal() {
        var modal = document.getElementById('editDatBanModal');
        if(modal) modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Handle Form Submit
    document.getElementById('editDatBanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var form = this;
        var formData = new FormData(form);
        var btn = form.querySelector('button[type="submit"]');
        var originalText = btn.textContent;
        
        btn.disabled = true;
        btn.textContent = 'Đang lưu...';

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Success
                closeEditDatBanModal();
                showAlert('success', 'Cập nhật thành công!');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('error', data.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        })
        .catch(err => {
            console.error(err);
            showAlert('error', 'Có lỗi xảy ra khi lưu dữ liệu.');
            btn.disabled = false;
            btn.textContent = originalText;
        });
    });

    // Close on Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeDatBanDetailsModal();
            closeEditDatBanModal();
        }
    });

    // Handle TempData Alerts on Load
    document.addEventListener('DOMContentLoaded', function() {
        var successMsg = '@Html.Raw(TempData["SuccessMessage"] ?? "")';
        var errorMsg = '@Html.Raw(TempData["ErrorMessage"] ?? "")';

        if (successMsg) showAlert('success', successMsg);
        if (errorMsg) showAlert('error', errorMsg);
    });
</script>

<style>
    /* Pagination Styles */
    .pagination-container {
        margin-top: 3rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
    }
    .pagination-buttons {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }
    .pagination-btn {
        width: 40px; height: 40px;
        display: flex; align-items: center; justify-content: center;
        border: 1px solid #e5e7eb; background: white; border-radius: 50%;
        cursor: pointer; transition: all 0.3s ease;
        font-weight: 500; color: #9ca3af; text-decoration: none; font-size: 18px;
    }
    .pagination-btn:hover:not(.active):not(.disabled) {
        border-color: #14b8a6; color: #14b8a6; transform: scale(1.05);
    }
    .pagination-btn.active {
        width: 44px; height: 44px;
        background: #14b8a6; border: 1px solid #14b8a6; border-radius: 50%;
        color: white; font-size: 16px; font-weight: 600;
        box-shadow: 0 4px 10px rgba(20, 184, 166, 0.2);
    }
    .pagination-btn.disabled {
        opacity: 1; color: #9ca3af; border-color: #e5e7eb;
        cursor: not-allowed; background: #f9fafb;
    }
    .pagination-info {
        color: #5b9bd5; font-size: 14px; font-weight: 400;
    }
    
    /* Auth Modal Styles Global overrides/Additions */
    .auth-modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center;
        z-index: 9999; backdrop-filter: blur(4px);
    }
    .auth-modal-container {
        background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        width: 90%; max-height: 90vh; overflow-y: auto; animation: authSlideIn 0.3s ease-out;
    }
    .auth-modal-header { padding: 24px 32px; text-align: center; border-bottom: 1px solid #f3f4f6; }
    .auth-logo { width: 48px; height: 48px; margin: 0 auto 16px; background: #fff7ed; color: #ea580c; border-radius: 12px; }
    .auth-modal-title { font-size: 24px; font-weight: 800; color: #1f2937; margin-bottom: 8px; }
    .auth-modal-subtitle { color: #6b7280; font-size: 14px; }
    .auth-modal-body { padding: 32px; }
    .auth-form-group { margin-bottom: 20px; }
    .auth-form-label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    .auth-required { color: #dc2626; margin-left: 2px; }
    .auth-input-wrapper { position: relative; }
    .auth-form-control { width: 100%; padding: 10px 16px; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s; }
    .auth-form-control:focus { outline: none; border-color: #0d9488; box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1); }
    .auth-btn-group { display: flex; gap: 12px; justify-content: flex-end; }
    .auth-btn { padding: 10px 24px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .auth-btn-cancel { background: white; border: 1.5px solid #e5e7eb; color: #374151; }
    .auth-btn-cancel:hover { background: #f9fafb; border-color: #d1d5db; }
    .auth-btn-submit { background: linear-gradient(135deg, #0d9488 0%, #059669 100%); border: none; color: white; box-shadow: 0 4px 6px -1px rgba(13, 148, 136, 0.3); }
    .auth-btn-submit:hover { transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(13, 148, 136, 0.4); }
    @@keyframes authSlideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
