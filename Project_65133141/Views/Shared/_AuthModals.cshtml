<!-- Login and Register Modals -->
@{
    var loginModel = ViewBag.LoginForm as Project_65133141.Models.Form.LoginForm ?? new Project_65133141.Models.Form.LoginForm();
    var registerModel = ViewBag.RegisterForm as Project_65133141.Models.Form.RegisterForm ?? new Project_65133141.Models.Form.RegisterForm();
}

<!-- Toast Notification Container -->
<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;"></div>

<style>
    .toast-notification {
        min-width: 320px;
        max-width: 420px;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: toastSlideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .toast-success {
        background-color: rgb(240, 253, 244); /* bg-green-50 */
        border-color: rgb(34, 197, 94); /* green-500 */
        color: rgb(22, 101, 52); /* text-green-800 */
    }
    .toast-error {
        background-color: rgb(254, 242, 242); /* bg-red-50 */
        border-color: rgb(239, 68, 68); /* red-500 */
        color: rgb(153, 27, 27); /* text-red-800 */
    }
    .toast-info {
        background-color: rgb(239, 246, 255); /* bg-blue-50 */
        border-color: rgb(59, 130, 246); /* blue-500 */
        color: rgb(30, 64, 175); /* text-blue-800 */
    }
    .toast-warning {
        background-color: rgb(254, 252, 232); /* bg-yellow-50 */
        border-color: rgb(245, 158, 11); /* yellow-500 */
        color: rgb(133, 77, 14); /* text-yellow-800 */
    }
    .toast-icon-circle {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .toast-success .toast-icon-circle {
        background-color: rgb(220, 252, 231); /* bg-green-100 */
    }
    .toast-error .toast-icon-circle {
        background-color: rgb(254, 226, 226); /* bg-red-100 */
    }
    .toast-info .toast-icon-circle {
        background-color: rgb(219, 234, 254); /* bg-blue-100 */
    }
    .toast-warning .toast-icon-circle {
        background-color: rgb(254, 243, 199); /* bg-amber-100 */
    }
    .toast-icon {
        width: 16px;
        height: 16px;
    }
    .toast-success .toast-icon { color: rgb(22, 163, 74); } /* green-600 */
    .toast-error .toast-icon { color: rgb(220, 38, 38); } /* red-600 */
    .toast-info .toast-icon { color: rgb(37, 99, 235); } /* blue-600 */
    .toast-warning .toast-icon { color: rgb(245, 158, 11); } /* amber-500 */
    
    .toast-content {
        flex: 1;
    }
    .toast-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
    }
    .toast-message {
        font-size: 13px;
        opacity: 0.9;
    }
    .toast-close {
        background: none;
        border: none;
        padding: 6px;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.15s;
        margin-left: auto;
        opacity: 0.7;
    }
    .toast-close:hover {
        background-color: rgba(0, 0, 0, 0.08);
        opacity: 1;
    }
    .toast-close svg {
        width: 18px;
        height: 18px;
    }
    @@keyframes toastSlideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @@keyframes toastSlideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
</style>

<script>
    function showToast(type, title, message, duration = 5000) {
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
            document.body.appendChild(container);
        }
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        const icons = {
            success: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
            error: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/></svg>',
            info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2" fill="none"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01"/></svg>',
            warning: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 3h.01M10.29 4.21l-6.6 11.45A1 1 0 004.53 18h14.94a1 1 0 00.86-1.5l-6.6-11.45a1 1 0 00-1.74 0z"/></svg>'
        };
        
        toast.innerHTML = `
            <div class="toast-icon-circle">
                ${icons[type] || icons.info}
            </div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                ${message ? `<div class="toast-message">${message}</div>` : ''}
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto remove
        setTimeout(() => {
            toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
</script>

<!-- Login Modal -->
<div id="loginModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container">
        <button type="button" class="auth-close-btn" onclick="closeLoginModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <img src="@Url.Content("~/Images/logoNhaHang.png")" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
            </div>
            <h2 class="auth-modal-title">Chào mừng trở lại</h2>
            <p class="auth-modal-subtitle">Đăng nhập vào tài khoản của bạn</p>
        </div>

        <div class="auth-modal-body">
            @using (Html.BeginForm("Login", "Account", new { area = "" }, FormMethod.Post, new { @class = "login-form", id = "loginFormModal", novalidate = "novalidate" }))
            {
                @Html.AntiForgeryToken()



                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Email/Tên đăng nhập <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                        <input type="email" name="Email" class="auth-form-control" placeholder="email@example.com" autocomplete="username" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Email" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Mật khẩu <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <input type="password" name="Password" class="auth-form-control" placeholder="••••••••" autocomplete="current-password" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Password" data-valmsg-replace="true"></span>
                </div>

                <!-- Forgot Password Link -->
                <div class="auth-forgot-password">
                    <a href="javascript:void(0)" onclick="showForgotPassword()">Quên mật khẩu?</a>
                </div>

                <!-- CAPTCHA -->
                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Mã xác nhận <span class="auth-required">*</span>
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="flex: 1;">
                            <div class="auth-input-wrapper">
                                <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                <input type="text" name="CaptchaCode" id="loginCaptchaCode" class="auth-form-control" placeholder="Nhập mã xác nhận" autocomplete="off" maxlength="5" style="text-transform: uppercase;" />
                            </div>
                        </div>
                        <button type="button" class="auth-btn-refresh" onclick="refreshLoginCaptcha()" title="Làm mới mã">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                        <div style="flex-shrink: 0;">
                            <img id="loginCaptchaImage" src="@Url.Action("Generate", "Captcha", new { area = "" })" alt="CAPTCHA" style="height: 50px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                    </div>
                    <span class="auth-error-message" data-valmsg-for="CaptchaCode" data-valmsg-replace="true"></span>
                </div>

                <button type="submit" class="auth-btn-submit" id="loginSubmitBtn">Đăng nhập</button>

                <div class="auth-register-link">
                    Chưa có tài khoản? <a href="javascript:void(0)" onclick="switchToRegister()">Tạo tài khoản mới</a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Forgot Password Modal - 2 Step Email Verification -->
<div id="forgotPasswordModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container">
        <button type="button" class="auth-close-btn" onclick="closeForgotPasswordModal()">&times;</button>

        <div class="auth-modal-header">
            <div class="auth-logo">
                <img src="@Url.Content("~/Images/logoNhaHang.png")" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
            </div>
            <h2 class="auth-modal-title">Quên mật khẩu</h2>
            <p class="auth-modal-subtitle" id="forgotPasswordSubtitle">Nhập email để nhận mã xác nhận</p>
        </div>

        <div class="auth-modal-body">
            <!-- Step indicator -->
            <div class="flex justify-center gap-2 mb-6">
                <div id="step1Indicator" class="w-8 h-8 rounded-full bg-red-600 text-white flex items-center justify-center text-sm font-bold">1</div>
                <div class="w-8 h-1 bg-gray-300 self-center rounded" id="stepConnector"></div>
                <div id="step2Indicator" class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-bold">2</div>
            </div>
            



            <!-- Step 1: Enter Email -->
            <div id="forgotPasswordStep1">
                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Email đã đăng ký <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                        <input type="email" id="forgotPasswordEmail" class="auth-form-control" placeholder="email@example.com" autocomplete="email" />
                    </div>
                </div>
                
                <button type="button" id="sendOtpBtn" class="auth-btn-submit" onclick="sendOtpEmail()">
                    <span id="sendOtpBtnText">Gửi mã xác nhận</span>
                    <svg id="sendOtpSpinner" class="hidden w-5 h-5 animate-spin ml-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Step 2: Enter OTP and New Password -->
            <div id="forgotPasswordStep2" style="display: none;">
                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Mã xác nhận (đã gửi đến email) <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <input type="text" id="forgotPasswordOtp" class="auth-form-control" placeholder="Nhập mã 6 chữ số" maxlength="6" style="letter-spacing: 8px; font-size: 18px; text-align: center;" />
                    </div>
                    <div class="text-center mt-2">
                        <span class="text-sm text-gray-500">Không nhận được mã? </span>
                        <button type="button" id="resendOtpBtn" class="text-sm text-red-600 hover:text-red-700 font-medium" onclick="resendOtp()">Gửi lại</button>
                        <span id="resendCountdown" class="text-sm text-gray-400 hidden"></span>
                    </div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Mật khẩu mới <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <input type="password" id="forgotPasswordNewPass" class="auth-form-control" placeholder="Nhập mật khẩu mới" autocomplete="new-password" />
                    </div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Xác nhận mật khẩu mới <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <input type="password" id="forgotPasswordConfirmPass" class="auth-form-control" placeholder="Nhập lại mật khẩu mới" autocomplete="new-password" />
                    </div>
                </div>
                
                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="backToStep1()">Quay lại</button>
                    <button type="button" class="auth-btn auth-btn-submit" id="resetPasswordBtn" onclick="resetPassword()">Đặt lại mật khẩu</button>
                </div>
            </div>

            <div class="auth-login-link">
                Nhớ mật khẩu? <a href="javascript:void(0)" onclick="backToLoginFromForgot()">Quay lại đăng nhập</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Forgot Password with Email OTP
    var forgotPasswordEmail = '';
    var resendTimer = null;
    
    function sendOtpEmail() {
        const email = document.getElementById('forgotPasswordEmail').value.trim();
        if (!email || !email.includes('@@')) {
            showForgotPasswordError('Vui lòng nhập email hợp lệ');
            return;
        }
        
        forgotPasswordEmail = email;
        const btn = document.getElementById('sendOtpBtn');
        const btnText = document.getElementById('sendOtpBtnText');
        const spinner = document.getElementById('sendOtpSpinner');
        
        btn.disabled = true;
        btnText.textContent = 'Đang gửi...';
        spinner.classList.remove('hidden');
        
        fetch('@Url.Action("SendPasswordResetOtp", "Account")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(res => res.json())
        .then(data => {
            btn.disabled = false;
            btnText.textContent = 'Gửi mã xác nhận';
            spinner.classList.add('hidden');
            
            if (data.success) {
                showForgotPasswordSuccess('Mã xác nhận đã được gửi đến email của bạn!');
                goToStep2();
                startResendCountdown();
            } else {
                showForgotPasswordError(data.message || 'Không tìm thấy email trong hệ thống');
            }
        })
        .catch(err => {
            btn.disabled = false;
            btnText.textContent = 'Gửi mã xác nhận';
            spinner.classList.add('hidden');
            showForgotPasswordError('Lỗi kết nối: ' + (err.message || 'Vui lòng kiểm tra mạng'));
        });
    }
    
    function goToStep2() {
        document.getElementById('forgotPasswordStep1').style.display = 'none';
        document.getElementById('forgotPasswordStep2').style.display = 'block';
        document.getElementById('step1Indicator').classList.remove('bg-red-600', 'text-white');
        document.getElementById('step1Indicator').classList.add('bg-green-500', 'text-white');
        document.getElementById('step2Indicator').classList.remove('bg-gray-300', 'text-gray-600');
        document.getElementById('step2Indicator').classList.add('bg-red-600', 'text-white');
        document.getElementById('stepConnector').classList.add('bg-green-500');
        document.getElementById('forgotPasswordSubtitle').textContent = 'Nhập mã OTP và mật khẩu mới';
    }
    
    function backToStep1() {
        document.getElementById('forgotPasswordStep1').style.display = 'block';
        document.getElementById('forgotPasswordStep2').style.display = 'none';
        document.getElementById('step1Indicator').classList.add('bg-red-600', 'text-white');
        document.getElementById('step1Indicator').classList.remove('bg-green-500');
        document.getElementById('step2Indicator').classList.add('bg-gray-300', 'text-gray-600');
        document.getElementById('step2Indicator').classList.remove('bg-red-600', 'text-white');
        document.getElementById('stepConnector').classList.remove('bg-green-500');
        document.getElementById('forgotPasswordSubtitle').textContent = 'Nhập email để nhận mã xác nhận';
        hideForgotPasswordMessages();
    }
    
    function startResendCountdown() {
        let seconds = 60;
        document.getElementById('resendOtpBtn').classList.add('hidden');
        document.getElementById('resendCountdown').classList.remove('hidden');
        
        resendTimer = setInterval(() => {
            seconds--;
            document.getElementById('resendCountdown').textContent = `(${seconds}s)`;
            if (seconds <= 0) {
                clearInterval(resendTimer);
                document.getElementById('resendOtpBtn').classList.remove('hidden');
                document.getElementById('resendCountdown').classList.add('hidden');
            }
        }, 1000);
    }
    
    function resendOtp() {
        sendOtpEmail();
    }
    
    function resetPassword() {
        const otp = document.getElementById('forgotPasswordOtp').value.trim();
        const newPass = document.getElementById('forgotPasswordNewPass').value;
        const confirmPass = document.getElementById('forgotPasswordConfirmPass').value;
        
        if (!otp || otp.length < 6) {
            showForgotPasswordError('Vui lòng nhập mã xác nhận 6 chữ số');
            return;
        }
        if (!newPass || newPass.length < 6) {
            showForgotPasswordError('Mật khẩu mới phải có ít nhất 6 ký tự');
            return;
        }
        if (newPass !== confirmPass) {
            showForgotPasswordError('Mật khẩu xác nhận không khớp');
            return;
        }
        
        const btn = document.getElementById('resetPasswordBtn');
        btn.disabled = true;
        btn.dataset.originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Đang xử lý...';
        
        fetch('@Url.Action("ResetPasswordWithOtp", "Account")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: forgotPasswordEmail, 
                otp: otp, 
                newPassword: newPass 
            })
        })
        .then(res => res.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = 'Đặt lại mật khẩu';
            
            if (data.success) {
                showForgotPasswordSuccess('Mật khẩu đã được đặt lại thành công! Đang chuyển về đăng nhập...');
                setTimeout(() => {
                    closeForgotPasswordModal();
                    openLoginModal();
                }, 2000);
            } else {
                showForgotPasswordError(data.message || 'Mã xác nhận không đúng hoặc đã hết hạn');
            }
        })
        .catch(err => {
            btn.disabled = false;
            // Restore button text
            btn.innerHTML = btn.dataset.originalHtml || 'Đặt lại mật khẩu';
            showForgotPasswordError('Lỗi kết nối: ' + (err.message || 'Vui lòng kiểm tra mạng'));
        });
    }
    
    function showForgotPasswordError(msg) {
        showToast('error', 'Lỗi', msg);
        const successMsg = document.getElementById('forgotPasswordGeneralSuccess');
        if (successMsg) successMsg.style.display = 'none';
    }
    
    function showForgotPasswordSuccess(msg) {
        const successEl = document.getElementById('forgotPasswordGeneralSuccess');
        if (successEl) {
            successEl.style.display = 'block';
            successEl.textContent = msg;
        }
        showToast('success', 'Thành công', msg);
    }
    
    function hideForgotPasswordMessages() {
        const errorEl = document.getElementById('forgotPasswordGeneralError');
        const successEl = document.getElementById('forgotPasswordGeneralSuccess');
        if (errorEl) errorEl.style.display = 'none';
        if (successEl) successEl.style.display = 'none';
    }
    
    function showForgotPassword() {
        closeLoginModal();
        document.getElementById('forgotPasswordModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        // Reset to step 1
        backToStep1();
        document.getElementById('forgotPasswordEmail').value = '';
        document.getElementById('forgotPasswordOtp').value = '';
        document.getElementById('forgotPasswordNewPass').value = '';
        document.getElementById('forgotPasswordConfirmPass').value = '';
    }
    
    function closeForgotPasswordModal() {
        document.getElementById('forgotPasswordModal').style.display = 'none';
        document.body.style.overflow = '';
        if (resendTimer) clearInterval(resendTimer);
    }
    
    function backToLoginFromForgot() {
        closeForgotPasswordModal();
        openLoginModal();
    }
</script>


<!-- Register Modal -->
<div id="registerModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large">
        <button type="button" class="auth-close-btn" onclick="closeRegisterModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <img src="@Url.Content("~/Images/logoNhaHang.png")" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
            </div>
            <h2 class="auth-modal-title">Đăng ký</h2>
            <p class="auth-modal-subtitle">Tạo tài khoản mới của bạn</p>
        </div>

        <div class="auth-modal-body">
            @{
                var defaultUserRoleForRegister = ViewBag.DefaultUserRoleId as long?;
            }
            @using (Html.BeginForm("Register", "Account", new { area = "" }, FormMethod.Post, new { @class = "register-form", id = "registerFormModal" }))
            {
                @Html.AntiForgeryToken()

                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Họ tên <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <input type="text" name="FullName" class="auth-form-control" placeholder="Nguyễn Văn A" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="FullName" data-valmsg-replace="true"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Số điện thoại <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <input type="tel" name="PhoneNumber" id="registerPhoneNumber" class="auth-form-control" placeholder="0123456789" autocomplete="tel" pattern="[0-9]*" inputmode="numeric" maxlength="10" minlength="10" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="PhoneNumber" data-valmsg-replace="true"></span>
                    </div>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Email <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                        <input type="email" name="Email" class="auth-form-control" placeholder="email@example.com" autocomplete="username" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Email" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Địa chỉ
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <input type="text" name="Address" class="auth-form-control" placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành phố" autocomplete="street-address" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Address" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <input type="password" name="Password" id="registerPasswordModal" class="auth-form-control auth-password-input" placeholder="Vui lòng nhập mật khẩu" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="Password" data-valmsg-replace="true"></span>
                        
                        <!-- Password Strength Indicator -->
                        <div class="auth-password-strength-container" style="margin-top: 10px; display: none;">
                            <div class="auth-password-strength-bar">
                                <div class="auth-password-strength-fill" id="passwordStrengthFillModal"></div>
                            </div>
                            <div class="auth-password-strength-text">
                                <span id="passwordStrengthTextModal">Yếu</span>
                                <span style="float: right;">Mạnh</span>
                            </div>
                            <div class="auth-password-requirements" id="passwordRequirementsModal">
                                <div class="auth-requirement-item" id="req-length-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 8 ký tự</span>
                                </div>
                                <div class="auth-requirement-item" id="req-upper-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 chữ in hoa</span>
                                </div>
                                <div class="auth-requirement-item" id="req-lower-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 chữ thường</span>
                                </div>
                                <div class="auth-requirement-item" id="req-number-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 chữ số</span>
                                </div>
                                <div class="auth-requirement-item" id="req-special-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 ký tự đặc biệt</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Xác nhận mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <input type="password" name="ConfirmPassword" class="auth-form-control" placeholder="Nhập lại mật khẩu" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="ConfirmPassword" data-valmsg-replace="true"></span>
                    </div>
                </div>

                @* Hidden field for default user role - automatically set to customer/user role *@
                @Html.Raw(defaultUserRoleForRegister.HasValue ? "<input type=\"hidden\" name=\"RoleId\" value=\"" + defaultUserRoleForRegister.Value + "\" />" : "")

                <!-- CAPTCHA -->
                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Mã xác nhận <span class="auth-required">*</span>
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="flex: 1;">
                            <div class="auth-input-wrapper">
                                <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                <input type="text" name="CaptchaCode" id="registerCaptchaCode" class="auth-form-control" placeholder="Nhập mã xác nhận" autocomplete="off" maxlength="5" style="text-transform: uppercase;" />
                            </div>
                        </div>
                        <button type="button" class="auth-btn-refresh" onclick="refreshRegisterCaptcha()" title="Làm mới mã">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                        <div style="flex-shrink: 0;">
                            <img id="registerCaptchaImage" src="@Url.Action("Generate", "Captcha", new { area = "" })" alt="CAPTCHA" style="height: 50px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                    </div>
                    <span class="auth-error-message" data-valmsg-for="CaptchaCode" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeRegisterModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit" id="registerSubmitBtn">Đăng ký</button>
                </div>

                <div class="auth-login-link">
                    Đã có tài khoản? <a href="javascript:void(0)" onclick="switchToLogin()">Đăng nhập ngay</a>
                </div>
            }
        </div>
    </div>
    </div>

<style>
    /* Auth Modal Styles */
    .auth-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .auth-modal-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: hidden;
        /* Ẩn thanh scrollbar */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    /* Ẩn scrollbar cho Webkit browsers (Chrome, Safari, Edge) */
    .auth-modal-container::-webkit-scrollbar {
        display: none;
        width: 0;
        height: 0;
    }

    .auth-modal-large {
        max-width: 500px;
    }

    .auth-modal-header {
        text-align: center;
        padding: 30px 30px 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .auth-logo {
        width: 60px;
        height: 60px;
        margin: 0 auto 15px;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .auth-modal-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .auth-modal-subtitle {
        font-size: 14px;
        color: #888;
    }

    .auth-modal-body {
        padding: 30px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
        width: 100%;
    }

    .auth-form-group {
        margin-bottom: 20px;
        width: 100%;
    }

    .auth-form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-required {
        color: #e74c3c;
    }

    .auth-input-wrapper {
        position: relative;
        width: 100%;
    }

    .auth-input-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        width: 20px;
        height: 20px;
    }

    .auth-form-control {
        width: 100% !important;
        max-width: 100%;
        padding: 12px 15px 12px 45px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
        border-color: #ddd;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-sizing: border-box;
    }

    select.auth-form-control {
        padding-left: 45px;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-color: white;
    }
    
    .auth-form-control:hover {
        border-color: #bbb;
    }

    .auth-form-control:focus {
        outline: none;
        border-color: #dc2626;
        background: white;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12);
    }

    .auth-error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    /* Chỉ hiển thị validation message khi có lỗi thực sự */
    .field-validation-error,
    .auth-error-message.field-validation-error {
        display: block !important;
    }

    /* Ẩn validation messages mặc định khi chưa submit */
    .auth-form-control:not(:invalid):not(.input-validation-error) ~ .auth-error-message:empty,
    .auth-error-message:empty {
        display: none !important;
    }

    .auth-forgot-password {
        text-align: left;
        margin-top: -10px;
        margin-bottom: 20px;
    }

    .auth-forgot-password a {
        color: #dc2626;
        font-size: 13px;
        text-decoration: none;
        transition: color 0.3s;
    }

    .auth-forgot-password a:hover {
        color: #b91c1c;
        text-decoration: underline;
    }

    .auth-btn-submit {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.35);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-btn-submit:hover {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 6px 20px rgba(220, 38, 38, 0.45);
    }

    .auth-btn-submit:active {
        transform: scale(0.98);
    }

    .auth-register-link, .auth-login-link {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #666;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-register-link a, .auth-login-link a {
        color: #dc2626;
        font-weight: 600;
        text-decoration: none;
        transition: color 0.3s;
    }

    .auth-register-link a:hover, .auth-login-link a:hover {
        color: #b91c1c;
    }

    .auth-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s;
        z-index: 10;
    }

    .auth-close-btn:hover {
        background: rgba(220, 38, 38, 0.12);
        color: #dc2626;
        transform: scale(1.1);
    }

    .auth-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 25px;
    }

    .auth-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-btn-cancel {
        background: #f0f0f0;
        color: #666;
        border: 1px solid #ddd;
    }

    .auth-btn-cancel:hover {
        background: #e0e0e0;
    }

    /* Password Strength Styles */
    .auth-password-strength-container {
        margin-top: 10px;
    }

    .auth-password-strength-bar {
        width: 100%;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .auth-password-strength-fill {
        height: 100%;
        background: linear-gradient(to right, #ff4444, #ffaa00, #88ff00);
        width: 0%;
        transition: width 0.3s ease, background 0.3s ease;
    }

    .auth-password-strength-text {
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
    }

    .auth-password-requirements {
        background: #fafafa;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e0e0e0;
    }

    .auth-requirement-item {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 13px;
        color: #666;
        transition: color 0.3s ease;
    }

    .auth-requirement-item:last-child {
        margin-bottom: 0;
    }

    .auth-req-icon {
        margin-right: 10px;
        font-size: 16px;
        width: 16px;
        height: 16px;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .auth-requirement-item.valid {
        color: #22c55e;
    }

    .auth-requirement-item.valid .auth-req-icon {
        display: inline-flex;
        color: #22c55e;
    }

    .auth-requirement-item.valid .auth-req-icon::before {
        content: "✓";
        font-size: 16px;
        font-weight: bold;
    }

    .auth-requirement-item.invalid {
        color: #999;
    }

    .auth-requirement-item.invalid .auth-req-icon {
        display: none;
    }

    @@media (max-width: 600px) {
        .auth-form-row {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Spinner Animation */
    @@keyframes rotate {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    /* Disabled state for submit button */
    .auth-btn-submit:disabled,
    .auth-btn:disabled {
        cursor: not-allowed;
        opacity: 0.7 !important;
    }

    .auth-btn-refresh {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 50px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        color: #666;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .auth-btn-refresh:hover {
        background: #f9f9f9;
        color: #dc2626;
        border-color: #dc2626;
    }

    .auth-btn-refresh svg {
        width: 20px;
        height: 20px;
    }
</style>

<script>
    // Modal functions
    function openLoginModal() {
        const modal = document.getElementById('loginModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Clear all validation messages when opening modal
        const loginForm = document.getElementById('loginFormModal');
        if (loginForm) {
            const errorMessages = loginForm.querySelectorAll('.auth-error-message');
            errorMessages.forEach(msg => {
                msg.textContent = '';
                msg.style.display = 'none';
            });
            const inputs = loginForm.querySelectorAll('.auth-form-control');
            inputs.forEach(input => {
                input.classList.remove('input-validation-error', 'field-validation-error');
            });
        }

        if (freshForgotForm) {
            console.log('Attaching submit handler to forgot password form');

            freshForgotForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const generalError = document.getElementById('forgotPasswordGeneralError');
                const generalSuccess = document.getElementById('forgotPasswordGeneralSuccess');
                if (generalError) { generalError.textContent = ''; generalError.style.display = 'none'; }
                if (generalSuccess) { generalSuccess.textContent = ''; generalSuccess.style.display = 'none'; }

                const submitBtn = document.getElementById('forgotPasswordSubmitBtn');
                if (submitBtn && submitBtn.disabled) {
                    return false;
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Đang xử lý...';
                    submitBtn.style.opacity = '0.7';
                }

                const formData = new FormData(freshForgotForm);

                fetch(freshForgotForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success) {
                            if (generalSuccess) {
                                generalSuccess.textContent = data.message || 'Đặt lại mật khẩu thành công. Vui lòng đăng nhập lại.';
                                generalSuccess.style.display = 'block';
                            }

                            // Tự động quay lại login sau một chút
                            setTimeout(() => {
                                closeForgotPasswordModal();
                                openLoginModal();
                            }, 2000);
                        } else {
                            const message = data && data.errorMessage ? data.errorMessage : 'Có lỗi xảy ra. Vui lòng thử lại.';
                            if (generalError) {
                                generalError.textContent = message;
                                generalError.style.display = 'block';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Forgot password error:', error);
                        if (generalError) {
                            generalError.textContent = 'Có lỗi xảy ra. Vui lòng thử lại.';
                            generalError.style.display = 'block';
                        }
                    })
                    .finally(() => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Đặt lại mật khẩu';
                            submitBtn.style.opacity = '1';
                        }
                        refreshForgotPasswordCaptcha();
                    });
            });
        }
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function openRegisterModal() {
        const modal = document.getElementById('registerModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Clear all validation messages when opening modal
        const registerForm = document.getElementById('registerFormModal');
        if (registerForm) {
            const errorMessages = registerForm.querySelectorAll('.auth-error-message');
            errorMessages.forEach(msg => {
                msg.textContent = '';
                msg.style.display = 'none';
            });
            const inputs = registerForm.querySelectorAll('.auth-form-control');
            inputs.forEach(input => {
                input.classList.remove('input-validation-error', 'field-validation-error');
            });
        }
        
        // Setup phone number validation
        setTimeout(function() {
            setupPhoneNumberValidation();
            setupStrictInputMasking();
            if (typeof initPasswordStrengthCheckerModal === 'function') {
                initPasswordStrengthCheckerModal();
            }
        }, 100);
    }

    function closeRegisterModal() {
        document.getElementById('registerModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function switchToRegister() {
        closeLoginModal();
        setTimeout(() => {
            openRegisterModal();
        }, 300);
    }

    function switchToLogin() {
        closeRegisterModal();
        setTimeout(() => {
            openLoginModal();
        }, 300);
    }

    function showForgotPassword() {
        closeLoginModal();
        setTimeout(() => {
            openForgotPasswordModal();
        }, 300);
    }

    function openForgotPasswordModal() {
        const modal = document.getElementById('forgotPasswordModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        refreshForgotPasswordCaptcha();
    }

    function closeForgotPasswordModal() {
        document.getElementById('forgotPasswordModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function refreshForgotPasswordCaptcha() {
        const img = document.getElementById('forgotPasswordCaptchaImage');
        if (img) {
            img.src = '@Url.Action("Generate", "Captcha", new { area = "" })?t=' + new Date().getTime();
            document.getElementById('forgotPasswordCaptchaCode').value = '';
        }
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const forgotModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        
        if (e.target === loginModal) {
            closeLoginModal();
        }
        if (e.target === registerModal) {
            closeRegisterModal();
        }
        if (e.target === forgotModal) {
            closeForgotPasswordModal();
        }
        if (e.target === forgotPasswordModal) {
            closeForgotPasswordModal();
        }
    });

    // Close modals on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLoginModal();
            closeRegisterModal();
            closeForgotPasswordModal();
        }
    });

    // Auto-open auth modals based on URL hash (e.g. #openLoginModal, #openRegisterModal)
    (function () {
        function handleAuthHash() {
            if (!window.location || !window.location.hash) return;

            var hash = window.location.hash.toLowerCase();
            if (hash === '#openloginmodal') {
                openLoginModal();
            } else if (hash === '#openregistermodal') {
                openRegisterModal();
            }

            // Clean hash so it doesn't keep reopening on refresh/back
            if (history && history.replaceState) {
                history.replaceState(null, document.title, window.location.pathname + window.location.search);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', handleAuthHash);
        } else {
            handleAuthHash();
        }
    })();

    // Password Strength Checker for Modal
    function initPasswordStrengthCheckerModal() {
        const passwordInput = document.getElementById('registerPasswordModal');
        if (!passwordInput) return;

        const strengthContainer = document.querySelector('.auth-password-strength-container');
        const strengthFill = document.getElementById('passwordStrengthFillModal');
        const strengthText = document.getElementById('passwordStrengthTextModal');
        const requirements = {
            length: document.getElementById('req-length-modal'),
            upper: document.getElementById('req-upper-modal'),
            lower: document.getElementById('req-lower-modal'),
            number: document.getElementById('req-number-modal'),
            special: document.getElementById('req-special-modal')
        };

        // Use a flag to prevent multiple event listeners on the same element
        if (passwordInput.dataset.hasStrengthListener === "true") {
             // Listener already attached, just trigger it once to update UI
             passwordInput.dispatchEvent(new Event('input'));
             return;
        }

        // Attach new listener
        passwordInput.addEventListener('input', checkPasswordStrength);
        passwordInput.addEventListener('focus', checkPasswordStrength); // Show on focus
        passwordInput.addEventListener('blur', function() {
             if (this.value.length === 0 && strengthContainer) {
                 strengthContainer.style.display = 'none';
             }
        });
        passwordInput.dataset.hasStrengthListener = "true";

        // Initial check
        checkPasswordStrength.call(passwordInput);

        function checkPasswordStrength() {
            const password = this.value;
            
            // Clear error message when typing
            const errorMsg = this.closest('.auth-form-group').querySelector('.auth-error-message');
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }

            // Show if not empty OR if focused (to show requirements immediately)
            if ((password.length > 0 || document.activeElement === this) && strengthContainer) {
                strengthContainer.style.display = 'block';
            } else {
                if (strengthContainer) strengthContainer.style.display = 'none';
                return;
            }

            // Check requirements
            const checks = {
                length: password.length >= 8,
                upper: /[A-Z]/.test(password),
                lower: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!\x40#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };

            // Update requirement indicators
            Object.keys(requirements).forEach(key => {
                if (requirements[key]) {
                    if (checks[key]) {
                        requirements[key].classList.remove('invalid');
                        requirements[key].classList.add('valid');
                    } else {
                        requirements[key].classList.remove('valid');
                        requirements[key].classList.add('invalid');
                    }
                }
            });

            // Calculate strength
            const validCount = Object.values(checks).filter(v => v).length;
            const strength = (validCount / 5) * 100;

            if (strengthFill) {
                strengthFill.style.width = strength + '%';
            }

            // Update strength text and color
            if (strengthText) {
                if (strength < 40) {
                    strengthText.textContent = 'Yếu';
                    if (strengthFill) strengthFill.style.background = '#ff4444';
                } else if (strength < 80) {
                    strengthText.textContent = 'Trung bình';
                    if (strengthFill) strengthFill.style.background = '#ffaa00';
                } else {
                    strengthText.textContent = 'Mạnh';
                    if (strengthFill) strengthFill.style.background = '#88ff00';
                }
            }
        }
    }

    // Disable client-side validation for modals
    // Wait for jQuery to be loaded
    function initJQueryValidation() {
        if (typeof jQuery !== 'undefined' && jQuery.validator) {
            jQuery.validator.setDefaults({
                ignore: ".ignore-validation"
            });
        } else {
            // Retry after a short delay if jQuery is not yet loaded
            setTimeout(initJQueryValidation, 100);
        }
    }
    
    // Start checking for jQuery
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initJQueryValidation);
    } else {
        initJQueryValidation();
    }

    // Function to initialize form handlers
    var formHandlerRetryCount = 0;
    var maxFormHandlerRetries = 50; // Max 5 seconds (50 * 100ms)
    
    function initializeFormHandlers() {
        console.log('Initializing form handlers');
        const loginForm = document.getElementById('loginFormModal');
        const registerForm = document.getElementById('registerFormModal');
        
        console.log('Login form found:', loginForm);
        console.log('Register form found:', registerForm);
        
        // Only check login and register forms - forgot password doesn't have a form element
        if (!loginForm || !registerForm) {
            formHandlerRetryCount++;
            if (formHandlerRetryCount < maxFormHandlerRetries) {
                console.warn('Forms not found, retrying... (' + formHandlerRetryCount + '/' + maxFormHandlerRetries + ')');
                setTimeout(initializeFormHandlers, 100);
            } else {
                console.error('Forms not found after ' + maxFormHandlerRetries + ' retries, stopping.');
            }
            return;
        }
        
        // Disable HTML5 validation
        if (loginForm) {
            loginForm.setAttribute('novalidate', 'novalidate');
            console.log('Login form validation disabled');
        }
        if (registerForm) {
            registerForm.setAttribute('novalidate', 'novalidate');
            console.log('Register form validation disabled');
        }

        // Remove existing listeners to avoid duplicates
        const newLoginForm = loginForm.cloneNode(true);
        loginForm.parentNode.replaceChild(newLoginForm, loginForm);
        const newRegisterForm = registerForm.cloneNode(true);
        registerForm.parentNode.replaceChild(newRegisterForm, registerForm);
        // forgotPasswordForm doesn't exist as a form element, skip cloning
        
        // Fix: Remove 'data-has-strength-listener' from cloned password input so it can be re-initialized
        const clonedPasswordInput = newRegisterForm.querySelector('#registerPasswordModal');
        if (clonedPasswordInput) {
            delete clonedPasswordInput.dataset.hasStrengthListener;
        }
        
        // Get fresh references
        const freshLoginForm = document.getElementById('loginFormModal');
        const freshRegisterForm = document.getElementById('registerFormModal');

        if (freshLoginForm) {
            console.log('Attaching submit handler to login form');
            freshLoginForm.addEventListener('submit', function(e) {
                console.log('Login form submit event triggered');
                e.preventDefault();
                console.log('Login form default prevented');
                
                // Get submit button and prevent double submission
                const submitBtn = document.getElementById('loginSubmitBtn');
                if (submitBtn.disabled) {
                    console.log('Form already submitting, ignoring duplicate submit');
                    return false;
                }
                
                // Disable button and show loading state
                // Disable button and show loading state
                submitBtn.disabled = true;
                submitBtn.dataset.originalHtml = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Đang đăng nhập...';
                submitBtn.style.opacity = '0.9';
                
                const formData = new FormData(this);
                console.log('Login form data collected');
                
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                const tokenValue = token ? token.value : formData.get('__RequestVerificationToken');
                
                console.log('Login - Token found:', !!token);
                console.log('Login - Form action:', this.action);
                console.log('Login - Form data keys:', Array.from(formData.keys()));
                
                // Log all form data values (except password)
                formData.forEach((value, key) => {
                    if (key !== 'Password' && key !== '__RequestVerificationToken') {
                        console.log(`Login - ${key}:`, value);
                    }
                });
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    console.log('Login response status:', response.status);
                    console.log('Login response redirected:', response.redirected);
                    console.log('Login response URL:', response.url);
                    
                    // Check content type first
                    const contentType = response.headers.get("content-type");
                    console.log('Login response content-type:', contentType);
                    
                    // If it's JSON, parse it (both success and error cases)
                    if (contentType && contentType.includes("application/json")) {
                        return response.json();
                    }
                    
                    // If response is HTML (non-JSON), it means server didn't detect AJAX properly
                    // Show a generic error and don't redirect
                    console.error('Server returned HTML instead of JSON, AJAX not detected');
                    showToast('error', 'Lỗi hệ thống', 'Vui lòng thử lại sau');
                    return null;
                })
                .then(data => {
                    console.log('Login final data:', data);
                    if (data === null) return; // Already redirected or HTML response
                    
                    if (data && data.success && data.redirectUrl) {
                        // Success: redirect to the URL
                        console.log('Redirecting to:', data.redirectUrl);
                        window.location.href = data.redirectUrl;
                    } else if (data && data.errors) {
                        // Handle JSON validation errors from server
                        console.log('Validation errors:', data.errors);
                        console.log('Validation errors details:', JSON.stringify(data.errors));
                        
                        // Clear previous errors
                        const errorMessages = freshLoginForm.querySelectorAll('.auth-error-message');
                        errorMessages.forEach(msg => {
                            msg.textContent = '';
                            msg.style.display = 'none';
                        });

                        // Refresh Captcha on error
                        if (typeof refreshLoginCaptcha === 'function') {
                            refreshLoginCaptcha();
                        }
                        
                        // Display new errors
                        Object.keys(data.errors).forEach(key => {
                            console.log('Processing error for key:', key, 'value:', data.errors[key]);
                            
                            // Handle general error message (empty key)
                            if (key === '' || key === 'general') {
                                const errorMessage = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                showToast('error', 'Đăng nhập thất bại', errorMessage);
                                return;
                            }
                            
                            const fieldName = key.split('.').pop(); // Get field name after '.'
                            console.log('Looking for field:', fieldName);
                            const input = freshLoginForm.querySelector(`[name="${fieldName}"]`);
                            console.log('Found input:', input);
                            
                            if (input) {
                                // Try multiple ways to find the error container
                                let errorContainer = null;
                                
                                // Method 1: Next sibling after parent (input-wrapper)
                                const wrapper = input.parentElement;
                                if (wrapper && wrapper.classList.contains('auth-input-wrapper')) {
                                    errorContainer = wrapper.nextElementSibling;
                                }
                                
                                // Method 2: Look in parent form-group
                                if (!errorContainer || !errorContainer.classList.contains('auth-error-message')) {
                                    const formGroup = input.closest('.auth-form-group');
                                    if (formGroup) {
                                        errorContainer = formGroup.querySelector('.auth-error-message');
                                    }
                                }
                                
                                console.log('Found error container:', errorContainer);
                                
                                if (errorContainer && errorContainer.classList.contains('auth-error-message')) {
                                    const errorMessage = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                    errorContainer.textContent = errorMessage;
                                    errorContainer.style.display = 'block';
                                    console.log('Set error message:', errorMessage);
                                } else {
                                    console.warn('Could not find error container for field:', fieldName);
                                }
                            } else {
                                console.warn('Could not find input for field:', fieldName);
                            }
                        });
                    } else if (typeof data === 'string') {
                        // Error: update modal content (HTML response)
                        console.log('Updating login form with HTML errors');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = data;
                        const newForm = tempDiv.querySelector('form');
                        if (newForm) {
                            freshLoginForm.innerHTML = newForm.innerHTML;
                            // Re-initialize form handlers after updating form
                            setTimeout(initializeFormHandlers, 100);
                        }
                    } else {
                        console.error('Unexpected login response:', data);
                        showToast('error', 'Lỗi', 'Đã xảy ra lỗi. Vui lòng thử lại.');
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    showToast('error', 'Lỗi kết nối', 'Không thể kết nối đến máy chủ. Vui lòng thử lại.');
                })
                .finally(() => {
                    // Re-enable button after request completes
                    const submitBtn = document.getElementById('loginSubmitBtn');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Đăng nhập';
                        submitBtn.style.opacity = '1';
                    }
                });
            });
        }

        if (freshRegisterForm) {
            console.log('Attaching submit handler to register form');
            // Clear validation messages when form is opened
            function clearValidationMessages() {
                const errorMessages = freshRegisterForm.querySelectorAll('.auth-error-message');
                errorMessages.forEach(msg => {
                    msg.textContent = '';
                    msg.style.display = 'none';
                });
                const inputs = freshRegisterForm.querySelectorAll('.auth-form-control');
                inputs.forEach(input => {
                    input.classList.remove('input-validation-error');
                });
            }

            // Clear messages when modal opens
            const registerModal = document.getElementById('registerModal');
            if (registerModal) {
                const observer = new MutationObserver(function(mutations) {
                    if (registerModal.style.display === 'flex') {
                        clearValidationMessages();
                    }
                });
                observer.observe(registerModal, { attributes: true, attributeFilter: ['style'] });
            }

            freshRegisterForm.addEventListener('submit', function(e) {
                console.log('Register form submit event triggered');
                e.preventDefault();
                console.log('Register form default prevented');
                
                // Clear previous validation messages
                clearValidationMessages();

                // Client-side Validation
                let isValid = true;
                const errors = {};

                // 1. Name Validation (Letters only - Vietnamese supported)
                const nameInput = freshRegisterForm.querySelector('input[name="FullName"]');
                if (nameInput) {
                    // Regex: Allow letters, spaces, Vietnamese characters. No numbers or special symbols.
                    const nameRegex = /^[a-zA-Z\sÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ]+$/;
                    if (!nameRegex.test(nameInput.value.trim())) {
                        isValid = false;
                        errors['FullName'] = 'Họ tên chỉ được phép chứa chữ cái, không được chứa số hoặc ký tự đặc biệt.';
                    }
                }

                // 2. Phone Validation (Exactly 10 digits)
                const phoneInput = freshRegisterForm.querySelector('input[name="PhoneNumber"]');
                if (phoneInput) {
                    const phoneRegex = /^\d{10}$/;
                    if (!phoneRegex.test(phoneInput.value.trim())) {
                        isValid = false;
                        errors['PhoneNumber'] = 'Số điện thoại phải bao gồm đúng 10 chữ số.';
                    }
                }

                // 3. Email Validation
                const emailInput = freshRegisterForm.querySelector('input[name="Email"]');
                if (emailInput) {
                    // Basic format check
                    const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                    // Check for invalid chars (like ! # $ % ^ & * ( ) due to strict requirement "only allow  _ - .")
                    // Note: Technically email local part allows many special chars, but user requested strict "Email only allow specific special chars".
                    // Allowed characters: letter, numbers, at-sign, underscore, dash, dot.
                    const strictEmailCharRegex = /^[a-zA-Z0-9\x40._-]+$/;

                    if (!emailRegex.test(emailInput.value.trim())) {
                        isValid = false;
                        errors['Email'] = 'Địa chỉ email không đúng định dạng.';
                    } else if (!strictEmailCharRegex.test(emailInput.value.trim())) {
                        isValid = false;
                        errors['Email'] = 'Email chứa ký tự không hợp lệ. Chỉ cho phép chữ, số và \x40 _ - .';
                    }
                }

                // 4. Address Validation (Letters, Numbers, and , . / -)
                const addressInput = freshRegisterForm.querySelector('input[name="Address"]');
                if (addressInput && addressInput.value.trim() !== '') {
                    // Allowed: a-z A-Z 0-9 space Vietnamese , . / -
                    const addressRegex = /^[a-zA-Z0-9\sÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ,.\/\-]+$/;
                    if (!addressRegex.test(addressInput.value.trim())) {
                        isValid = false;
                        errors['Address'] = 'Địa chỉ chứa ký tự không hợp lệ. Chỉ cho phép chữ, số và , . / -';
                    }
                }

                if (!isValid) {
                    console.log('Client-side validation failed:', errors);
                    Object.keys(errors).forEach(key => {
                        const input = freshRegisterForm.querySelector(`input[name="${key}"]`);
                        if (input) {
                            let errorContainer = input.parentElement.parentElement.querySelector('.auth-error-message');
                            if (!errorContainer) {
                                errorContainer = input.closest('.auth-form-group').querySelector('.auth-error-message');
                            }
                            if (errorContainer) {
                                errorContainer.textContent = errors[key];
                                errorContainer.style.display = 'block';
                            }
                        }
                    });
                    
                    // Re-enable button
                     const submitBtn = document.getElementById('registerSubmitBtn');
                     if (submitBtn) {
                         submitBtn.disabled = false;
                         submitBtn.innerHTML = 'Đăng ký';
                         submitBtn.style.opacity = '1';
                     }
                    return; // Stop submission
                }
                
                const formData = new FormData(freshRegisterForm);
                console.log('Register form data collected');
                
                // Get anti-forgery token
                const token = freshRegisterForm.querySelector('input[name="__RequestVerificationToken"]');
                const tokenValue = token ? token.value : formData.get('__RequestVerificationToken');
                
                console.log('Register - Token found:', !!token);
                console.log('Register - Form action:', freshRegisterForm.action);
                
                // Log all form data values (except password)
                formData.forEach((value, key) => {
                    if (key !== 'Password' && key !== 'ConfirmPassword' && key !== '__RequestVerificationToken') {
                        console.log(`Register - ${key}:`, value);
                    }
                });
                
                fetch(freshRegisterForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    console.log('Register response status:', response.status);
                    console.log('Register response redirected:', response.redirected);
                    console.log('Register response URL:', response.url);
                    
                    if (response.redirected) {
                        console.log('Redirecting to:', response.url);
                        window.location.href = response.url;
                        return;
                    }
                    // Check if response is JSON (success case)
                    const contentType = response.headers.get("content-type");
                    console.log('Register response content-type:', contentType);
                    
                    if (contentType && contentType.includes("application/json")) {
                        return response.json().then(json => {
                            console.log('Register JSON response:', json);
                            return json;
                        });
                    }
                    // Otherwise return text for error handling
                    return response.text().then(text => {
                        console.log('Register text response:', text.substring(0, 200));
                        return text;
                    });
                })
                .then(data => {
                    console.log('Register final data:', data);
                    if (data && data.success && data.redirectUrl) {
                        // Success: redirect to the URL
                        console.log('Redirecting to:', data.redirectUrl);
                        window.location.href = data.redirectUrl;
                    } else if (data && data.errors) {
                        // Handle JSON validation errors from server
                        console.log('Validation errors:', data.errors);
                        
                        // Clear previous errors
                        const errorMessages = freshRegisterForm.querySelectorAll('.auth-error-message');
                        errorMessages.forEach(msg => {
                            msg.textContent = '';
                            msg.style.display = 'none';
                        });
                        
                        // Check if Captcha error exists and refresh if so
                        if (data.errors['CaptchaCode'] || data.errors['captcha']) {
                            console.log('Captcha error detected, refreshing...');
                            if (typeof refreshRegisterCaptcha === 'function') {
                                refreshRegisterCaptcha();
                            }
                        } else {
                            // Even if not captcha error, it's good practice to refresh captcha on fail to prevent reuse token issues
                             if (typeof refreshRegisterCaptcha === 'function') {
                                refreshRegisterCaptcha();
                            }
                        }

                        // Display new errors
                        Object.keys(data.errors).forEach(key => {
                            const fieldName = key.split('.').pop(); // Get field name after '.'
                            const input = freshRegisterForm.querySelector(`[name="${fieldName}"]`);
                            if (input) {
                                // Find the error message container for this input
                                let errorContainer = input.parentElement.parentElement.querySelector('.auth-error-message');
                                if (!errorContainer) {
                                    errorContainer = input.closest('.auth-form-group').querySelector('.auth-error-message');
                                }
                                if (errorContainer) {
                                    errorContainer.textContent = data.errors[key][0]; // Show first error
                                    errorContainer.style.display = 'block';
                                }
                            }
                        });
                        
                        // Re-initialize password strength checker if password field was touched
                        setTimeout(function() {
                            if (typeof initPasswordStrengthCheckerModal === 'function') {
                                initPasswordStrengthCheckerModal();
                            }
                        }, 100);
                    } else if (typeof data === 'string') {
                        // Error: update modal content (HTML response)
                        console.log('Updating register form with HTML errors');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = data;
                        const newForm = tempDiv.querySelector('form');
                        if (newForm) {
                            // Preserve current form values before replacing
                            const currentData = new FormData(freshRegisterForm);
                            
                            freshRegisterForm.innerHTML = newForm.innerHTML;
                            
                            // Restore form values
                            currentData.forEach((value, key) => {
                                const input = freshRegisterForm.querySelector(`[name="${key}"]`);
                                if (input && input.type !== 'hidden') {
                                    input.value = value;
                                }
                            });
                            
                            // Show only validation messages that have content
                            const errorMessages = freshRegisterForm.querySelectorAll('.auth-error-message');
                            errorMessages.forEach(msg => {
                                if (msg.textContent.trim()) {
                                    msg.style.display = 'block';
                                } else {
                                    msg.style.display = 'none';
                                }
                            });
                            
                            // Re-initialize form handlers after updating form
                            setTimeout(initializeFormHandlers, 100);
                            
                            // Re-initialize password strength checker
                            setTimeout(function() {
                                if (typeof initPasswordStrengthCheckerModal === 'function') {
                                    initPasswordStrengthCheckerModal();
                                }
                            }, 100);
                        }
                    } else {
                        console.error('Unexpected response:', data);
                        alert('Có lỗi xảy ra khi đăng ký. Vui lòng thử lại.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi đăng ký: ' + error.message);
                });
            });
        }
    }
    
    // Phone number validation - chỉ cho phép nhập số
    function setupPhoneNumberValidation() {
        const phoneInput = document.getElementById('registerPhoneNumber');
        if (!phoneInput) return;

        // Chỉ cho phép nhập số
        phoneInput.addEventListener('input', function(e) {
            // Loại bỏ tất cả ký tự không phải số
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Ngăn chặn paste ký tự không phải số
        phoneInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const numbersOnly = paste.replace(/[^0-9]/g, '');
            this.value = numbersOnly;
        });

        // Ngăn chặn nhập ký tự không phải số từ bàn phím
        phoneInput.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
                return false;
            }
        });
    }

    // Strict Input Masking - Ngăn chặn nhập ký tự đặc biệt ngay khi gõ
    function setupStrictInputMasking() {
        const registerForm = document.getElementById('registerFormModal');
        if (!registerForm) return;

        // Helper to handle IME (Vietnamese Input) correctly
        function attachMask(input, invalidRegex) {
            let isComposing = false;

            input.addEventListener('compositionstart', function() {
                isComposing = true;
            });

            input.addEventListener('compositionend', function() {
                isComposing = false;
                // Run mask immediately after composition ends
                const val = this.value;
                const sanitized = val.replace(invalidRegex, '');
                if (val !== sanitized) this.value = sanitized;
            });

            input.addEventListener('input', function() {
                if (isComposing) return; // Skip masking while typing a composite character
                
                const val = this.value;
                const sanitized = val.replace(invalidRegex, '');
                if (val !== sanitized) this.value = sanitized;
            });

            input.addEventListener('paste', function() {
                setTimeout(() => {
                    const val = this.value;
                    const sanitized = val.replace(invalidRegex, '');
                    if (val !== sanitized) this.value = sanitized;
                }, 0);
            });
        }

        // 1. Name Masking (Letters + Space only)
        const nameInput = registerForm.querySelector('input[name="FullName"]');
        if (nameInput) {
            // Regex matches anything that is NOT a letter (EN+VN) or space
            attachMask(nameInput, /[^a-zA-Z\sÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ]/g);
        }

        // 2. Email Masking
        const emailInput = registerForm.querySelector('input[name="Email"]');
        if (emailInput) {
             attachMask(emailInput, /[^a-zA-Z0-9\x40._-]/g);
        }

        // 3. Address Masking (Letters, Numbers, Space, comma, dot, slash, dash)
        const addressInput = registerForm.querySelector('input[name="Address"]');
        if (addressInput) {
             // Allow letters (EN+VN), numbers, space, , . / -
             attachMask(addressInput, /[^a-zA-Z0-9\sÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵýỷỹ,.\/\-]/g);
        }
    }

    // Initialize form handlers when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initializeFormHandlers();
            setupPhoneNumberValidation();
            setupStrictInputMasking();
        });
    } else {
        initializeFormHandlers();
        setupPhoneNumberValidation();
        setupStrictInputMasking();
        
        // Ensure strength checker is initialized
        if (typeof initPasswordStrengthCheckerModal === 'function') {
            initPasswordStrengthCheckerModal();
        }
    }

    // Check login before ordering
    function checkLoginAndOrder(itemName, price) {
        var isAuthenticated = '@User.Identity.IsAuthenticated' === 'True';
        var userRole = '@(Session["UserRole"] as string ?? "")';
        
        if (isAuthenticated && userRole !== '') {
            // User is logged in, redirect to user area
            window.location.href = '@Url.Action("Index", "Home", new { area = "User_65133141" })';
        } else {
            // User is not logged in, show login modal
            alert('Vui lòng đăng nhập để đặt món!');
            openLoginModal();
        }
    }

    // Refresh CAPTCHA for login form
    function refreshLoginCaptcha() {
        var captchaImage = document.getElementById('loginCaptchaImage');
        var captchaInput = document.getElementById('loginCaptchaCode');
        if (captchaImage) {
            // Add timestamp to force refresh
            captchaImage.src = '@Url.Action("Generate", "Captcha", new { area = "" })?t=' + new Date().getTime();
        }
        if (captchaInput) {
            captchaInput.value = '';
        }
    }

    // Refresh CAPTCHA for register form
    function refreshRegisterCaptcha() {
        var captchaImage = document.getElementById('registerCaptchaImage');
        var captchaInput = document.getElementById('registerCaptchaCode');
        if (captchaImage) {
            // Add timestamp to force refresh
            captchaImage.src = '@Url.Action("Generate", "Captcha", new { area = "" })?t=' + new Date().getTime();
        }
        if (captchaInput) {
            captchaInput.value = '';
        }
    }

    // Refresh CAPTCHA when opening modals
    var originalOpenLoginModal = typeof openLoginModal !== 'undefined' ? openLoginModal : null;
    if (originalOpenLoginModal) {
        window.openLoginModal = function() {
            originalOpenLoginModal();
            setTimeout(refreshLoginCaptcha, 100);
        };
    }

    var originalOpenRegisterModal = typeof openRegisterModal !== 'undefined' ? openRegisterModal : null;
    if (originalOpenRegisterModal) {
        window.openRegisterModal = function() {
            originalOpenRegisterModal();
            setTimeout(refreshRegisterCaptcha, 100);
        };
    }
</script>

@section scripts {
    <script>
        // Ensure jQuery is loaded before running jQuery-dependent code
        (function() {
            function waitForJQuery(callback) {
                if (typeof jQuery !== 'undefined') {
                    callback();
                } else {
                    setTimeout(function() {
                        waitForJQuery(callback);
                    }, 50);
                }
            }
            
            waitForJQuery(function() {
                // Disable jQuery Validate for modal forms
                if (jQuery.validator) {
                    jQuery.validator.setDefaults({
                        ignore: ".ignore-validation"
                    });
                }
            });
            
            // Auto-open modal based on URL hash
            function checkHashAndOpenModal() {
                const hash = window.location.hash;
                if (hash === '#openLoginModal') {
                    openLoginModal();
                    // Remove hash from URL after opening
                    history.replaceState(null, null, ' ');
                } else if (hash === '#openRegisterModal') {
                    openRegisterModal();
                    // Remove hash from URL after opening
                    history.replaceState(null, null, ' ');
                }
            }
            
            // Check on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkHashAndOpenModal);
            } else {
                checkHashAndOpenModal();
            }
        })();
    </script>
}
