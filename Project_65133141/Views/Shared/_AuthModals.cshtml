<!-- Login and Register Modals -->
@{
    var loginModel = ViewBag.LoginForm as Project_65133141.Models.Form.LoginForm ?? new Project_65133141.Models.Form.LoginForm();
    var registerModel = ViewBag.RegisterForm as Project_65133141.Models.Form.RegisterForm ?? new Project_65133141.Models.Form.RegisterForm();
}

<!-- Login Modal -->
<div id="loginModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container">
        <button type="button" class="auth-close-btn" onclick="closeLoginModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <img src="@Url.Content("~/Images/logoNhaHang.png")" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
            </div>
            <h2 class="auth-modal-title">Chào mừng trở lại</h2>
            <p class="auth-modal-subtitle">Đăng nhập vào tài khoản của bạn</p>
        </div>

        <div class="auth-modal-body">
            @using (Html.BeginForm("Login", "Account", FormMethod.Post, new { @class = "login-form", id = "loginFormModal", novalidate = "novalidate" }))
            {
                @Html.AntiForgeryToken()

                <!-- General Error Message -->
                <div id="loginGeneralError" class="auth-error-message" style="display: none; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Email/Tên đăng nhập <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                        <input type="email" name="Email" class="auth-form-control" placeholder="email@example.com" autocomplete="username" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Email" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Mật khẩu <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <input type="password" name="Password" class="auth-form-control" placeholder="••••••••" autocomplete="current-password" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Password" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-forgot-password">
                    <a href="javascript:void(0)" onclick="showForgotPassword()">Quên mật khẩu?</a>
                </div>

                <button type="submit" class="auth-btn-submit" id="loginSubmitBtn">Đăng nhập</button>

                <div class="auth-register-link">
                    Chưa có tài khoản? <a href="javascript:void(0)" onclick="switchToRegister()">Tạo tài khoản mới</a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Register Modal -->
<div id="registerModal" class="auth-modal-overlay" style="display: none;">
    <div class="auth-modal-container auth-modal-large">
        <button type="button" class="auth-close-btn" onclick="closeRegisterModal()">&times;</button>
        
        <div class="auth-modal-header">
            <div class="auth-logo">
                <img src="@Url.Content("~/Images/logoNhaHang.png")" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
            </div>
            <h2 class="auth-modal-title">Đăng ký</h2>
            <p class="auth-modal-subtitle">Tạo tài khoản mới của bạn</p>
        </div>

        <div class="auth-modal-body">
            @{
                var defaultUserRoleForRegister = ViewBag.DefaultUserRoleId as long?;
            }
            @using (Html.BeginForm("Register", "Account", FormMethod.Post, new { @class = "register-form", id = "registerFormModal" }))
            {
                @Html.AntiForgeryToken()

                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Họ tên <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <input type="text" name="FullName" class="auth-form-control" placeholder="Nguyễn Văn A" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="FullName" data-valmsg-replace="true"></span>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Số điện thoại <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <input type="tel" name="PhoneNumber" class="auth-form-control" placeholder="0123456789" autocomplete="tel" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="PhoneNumber" data-valmsg-replace="true"></span>
                    </div>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Email <span class="auth-required">*</span>
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                        <input type="email" name="Email" class="auth-form-control" placeholder="email@example.com" autocomplete="username" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Email" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-form-group">
                    <label class="auth-form-label">
                        Địa chỉ
                    </label>
                    <div class="auth-input-wrapper">
                        <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <input type="text" name="Address" class="auth-form-control" placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành phố" autocomplete="street-address" />
                    </div>
                    <span class="auth-error-message" data-valmsg-for="Address" data-valmsg-replace="true"></span>
                </div>

                <div class="auth-form-row">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <input type="password" name="Password" id="registerPasswordModal" class="auth-form-control auth-password-input" placeholder="Vui lòng nhập mật khẩu" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="Password" data-valmsg-replace="true"></span>
                        
                        <!-- Password Strength Indicator -->
                        <div class="auth-password-strength-container" style="margin-top: 10px; display: none;">
                            <div class="auth-password-strength-bar">
                                <div class="auth-password-strength-fill" id="passwordStrengthFillModal"></div>
                            </div>
                            <div class="auth-password-strength-text">
                                <span id="passwordStrengthTextModal">Yếu</span>
                                <span style="float: right;">Mạnh</span>
                            </div>
                            <div class="auth-password-requirements" id="passwordRequirementsModal">
                                <div class="auth-requirement-item" id="req-length-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 8 ký tự</span>
                                </div>
                                <div class="auth-requirement-item" id="req-upper-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 chữ in hoa</span>
                                </div>
                                <div class="auth-requirement-item" id="req-lower-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 chữ thường</span>
                                </div>
                                <div class="auth-requirement-item" id="req-number-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 chữ số</span>
                                </div>
                                <div class="auth-requirement-item" id="req-special-modal">
                                    <span class="auth-req-icon"></span>
                                    <span>Ít nhất 1 ký tự đặc biệt</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Xác nhận mật khẩu <span class="auth-required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <svg class="auth-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <input type="password" name="ConfirmPassword" class="auth-form-control" placeholder="Nhập lại mật khẩu" autocomplete="new-password" />
                        </div>
                        <span class="auth-error-message" data-valmsg-for="ConfirmPassword" data-valmsg-replace="true"></span>
                    </div>
                </div>

                @* Hidden field for default user role - automatically set to customer/user role *@
                @Html.Raw(defaultUserRoleForRegister.HasValue ? "<input type=\"hidden\" name=\"RoleId\" value=\"" + defaultUserRoleForRegister.Value + "\" />" : "")

                <div class="auth-btn-group">
                    <button type="button" class="auth-btn auth-btn-cancel" onclick="closeRegisterModal()">Hủy</button>
                    <button type="submit" class="auth-btn auth-btn-submit" id="registerSubmitBtn">Đăng ký</button>
                </div>

                <div class="auth-login-link">
                    Đã có tài khoản? <a href="javascript:void(0)" onclick="switchToLogin()">Đăng nhập ngay</a>
                </div>
            }
        </div>
    </div>
    </div>

<style>
    /* Auth Modal Styles */
    .auth-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .auth-modal-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        position: relative;
        animation: authSlideIn 0.3s ease-out;
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-width: thin;
        scrollbar-color: rgba(128, 128, 128, 0.3) transparent;
    }

    /* Custom Scrollbar for Webkit browsers (Chrome, Safari, Edge) */
    .auth-modal-container::-webkit-scrollbar {
        width: 6px;
    }

    .auth-modal-container::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 10px;
    }

    .auth-modal-container::-webkit-scrollbar-thumb {
        background: rgba(128, 128, 128, 0.3);
        border-radius: 10px;
        transition: background 0.3s ease;
    }

    .auth-modal-container::-webkit-scrollbar-thumb:hover {
        background: rgba(128, 128, 128, 0.5);
    }

    .auth-modal-large {
        max-width: 500px;
    }

    @@keyframes authSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .auth-modal-header {
        text-align: center;
        padding: 30px 30px 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .auth-logo {
        width: 60px;
        height: 60px;
        margin: 0 auto 15px;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .auth-modal-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .auth-modal-subtitle {
        font-size: 14px;
        color: #888;
    }

    .auth-modal-body {
        padding: 30px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
        width: 100%;
    }

    .auth-form-group {
        margin-bottom: 20px;
        width: 100%;
    }

    .auth-form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-required {
        color: #e74c3c;
    }

    .auth-input-wrapper {
        position: relative;
        width: 100%;
    }

    .auth-input-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        width: 20px;
        height: 20px;
    }

    .auth-form-control {
        width: 100% !important;
        max-width: 100%;
        padding: 12px 15px 12px 45px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
        border-color: #ddd;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-sizing: border-box;
    }

    select.auth-form-control {
        padding-left: 45px;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-color: white;
    }
    
    .auth-form-control:hover {
        border-color: #bbb;
    }

    .auth-form-control:focus {
        outline: none;
        border-color: #dc2626;
        background: white;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .auth-error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    /* Chỉ hiển thị validation message khi có lỗi thực sự */
    .field-validation-error,
    .auth-error-message.field-validation-error {
        display: block !important;
    }

    /* Ẩn validation messages mặc định khi chưa submit */
    .auth-form-control:not(:invalid):not(.input-validation-error) ~ .auth-error-message:empty,
    .auth-error-message:empty {
        display: none !important;
    }

    .auth-forgot-password {
        text-align: left;
        margin-top: -10px;
        margin-bottom: 20px;
    }

    .auth-forgot-password a {
        color: #dc2626;
        font-size: 13px;
        text-decoration: none;
        transition: color 0.3s;
    }

    .auth-forgot-password a:hover {
        color: #b91c1c;
        text-decoration: underline;
    }

    .auth-btn-submit {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-btn-submit:hover {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
    }

    .auth-btn-submit:active {
        transform: scale(0.98);
    }

    .auth-register-link, .auth-login-link {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #666;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-register-link a, .auth-login-link a {
        color: #dc2626;
        font-weight: 600;
        text-decoration: none;
        transition: color 0.3s;
    }

    .auth-register-link a:hover, .auth-login-link a:hover {
        color: #b91c1c;
    }

    .auth-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s;
        z-index: 10;
    }

    .auth-close-btn:hover {
        background: rgba(220, 38, 38, 0.1);
        color: #dc2626;
        transform: scale(1.1);
    }

    .auth-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 25px;
    }

    .auth-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .auth-btn-cancel {
        background: #f0f0f0;
        color: #666;
        border: 1px solid #ddd;
    }

    .auth-btn-cancel:hover {
        background: #e0e0e0;
    }

    /* Password Strength Styles */
    .auth-password-strength-container {
        margin-top: 10px;
    }

    .auth-password-strength-bar {
        width: 100%;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .auth-password-strength-fill {
        height: 100%;
        background: linear-gradient(to right, #ff4444, #ffaa00, #88ff00);
        width: 0%;
        transition: width 0.3s ease, background 0.3s ease;
    }

    .auth-password-strength-text {
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
    }

    .auth-password-requirements {
        background: #fafafa;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e0e0e0;
    }

    .auth-requirement-item {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 13px;
        color: #666;
        transition: color 0.3s ease;
    }

    .auth-requirement-item:last-child {
        margin-bottom: 0;
    }

    .auth-req-icon {
        margin-right: 10px;
        font-size: 16px;
        width: 16px;
        height: 16px;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .auth-requirement-item.valid {
        color: #22c55e;
    }

    .auth-requirement-item.valid .auth-req-icon {
        display: inline-flex;
        color: #22c55e;
    }

    .auth-requirement-item.valid .auth-req-icon::before {
        content: "✓";
        font-size: 16px;
        font-weight: bold;
    }

    .auth-requirement-item.invalid {
        color: #999;
    }

    .auth-requirement-item.invalid .auth-req-icon {
        display: none;
    }

    @@media (max-width: 600px) {
        .auth-form-row {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Spinner Animation */
    @@keyframes rotate {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    /* Disabled state for submit button */
    .auth-btn-submit:disabled,
    .auth-btn:disabled {
        cursor: not-allowed;
        opacity: 0.7 !important;
    }
</style>

<script>
    // Modal functions
    function openLoginModal() {
        const modal = document.getElementById('loginModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Clear all validation messages when opening modal
        const loginForm = document.getElementById('loginFormModal');
        if (loginForm) {
            const errorMessages = loginForm.querySelectorAll('.auth-error-message');
            errorMessages.forEach(msg => {
                msg.textContent = '';
                msg.style.display = 'none';
            });
            const inputs = loginForm.querySelectorAll('.auth-form-control');
            inputs.forEach(input => {
                input.classList.remove('input-validation-error', 'field-validation-error');
            });
        }
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function openRegisterModal() {
        const modal = document.getElementById('registerModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Clear all validation messages when opening modal
        const registerForm = document.getElementById('registerFormModal');
        if (registerForm) {
            const errorMessages = registerForm.querySelectorAll('.auth-error-message');
            errorMessages.forEach(msg => {
                msg.textContent = '';
                msg.style.display = 'none';
            });
            const inputs = registerForm.querySelectorAll('.auth-form-control');
            inputs.forEach(input => {
                input.classList.remove('input-validation-error', 'field-validation-error');
            });
        }
        
        setTimeout(function() {
            if (typeof initPasswordStrengthCheckerModal === 'function') {
                initPasswordStrengthCheckerModal();
            }
        }, 100);
    }

    function closeRegisterModal() {
        document.getElementById('registerModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function switchToRegister() {
        closeLoginModal();
        setTimeout(() => {
            openRegisterModal();
        }, 300);
    }

    function switchToLogin() {
        closeRegisterModal();
        setTimeout(() => {
            openLoginModal();
        }, 300);
    }

    function showForgotPassword() {
        alert('Tính năng quên mật khẩu đang được phát triển');
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        
        if (e.target === loginModal) {
            closeLoginModal();
        }
        if (e.target === registerModal) {
            closeRegisterModal();
        }
    });

    // Close modals on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLoginModal();
            closeRegisterModal();
        }
    });

    // Password Strength Checker for Modal
    function initPasswordStrengthCheckerModal() {
        const passwordInput = document.getElementById('registerPasswordModal');
        if (!passwordInput) return;

        const strengthContainer = document.querySelector('.auth-password-strength-container');
        const strengthFill = document.getElementById('passwordStrengthFillModal');
        const strengthText = document.getElementById('passwordStrengthTextModal');
        const requirements = {
            length: document.getElementById('req-length-modal'),
            upper: document.getElementById('req-upper-modal'),
            lower: document.getElementById('req-lower-modal'),
            number: document.getElementById('req-number-modal'),
            special: document.getElementById('req-special-modal')
        };

        // Remove existing listener if any
        const newPasswordInput = passwordInput.cloneNode(true);
        passwordInput.parentNode.replaceChild(newPasswordInput, passwordInput);

        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            
            if (password.length > 0 && strengthContainer) {
                strengthContainer.style.display = 'block';
            } else {
                if (strengthContainer) strengthContainer.style.display = 'none';
                return;
            }

            // Check requirements
            const checks = {
                length: password.length >= 8,
                upper: /[A-Z]/.test(password),
                lower: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[\x40\x24!%*#?&]/.test(password)
            };

            // Update requirement indicators
            Object.keys(requirements).forEach(key => {
                if (requirements[key]) {
                    if (checks[key]) {
                        requirements[key].classList.remove('invalid');
                        requirements[key].classList.add('valid');
                    } else {
                        requirements[key].classList.remove('valid');
                        requirements[key].classList.add('invalid');
                    }
                }
            });

            // Calculate strength
            const validCount = Object.values(checks).filter(v => v).length;
            const strength = (validCount / 5) * 100;

            if (strengthFill) {
                strengthFill.style.width = strength + '%';
            }

            // Update strength text and color
            if (strengthText) {
                if (strength < 40) {
                    strengthText.textContent = 'Yếu';
                    if (strengthFill) strengthFill.style.background = '#ff4444';
                } else if (strength < 80) {
                    strengthText.textContent = 'Trung bình';
                    if (strengthFill) strengthFill.style.background = '#ffaa00';
                } else {
                    strengthText.textContent = 'Mạnh';
                    if (strengthFill) strengthFill.style.background = '#88ff00';
                }
            }
        });
    }

    // Disable client-side validation for modals
    // Wait for jQuery to be loaded
    function initJQueryValidation() {
        if (typeof jQuery !== 'undefined' && jQuery.validator) {
            jQuery.validator.setDefaults({
                ignore: ".ignore-validation"
            });
        } else {
            // Retry after a short delay if jQuery is not yet loaded
            setTimeout(initJQueryValidation, 100);
        }
    }
    
    // Start checking for jQuery
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initJQueryValidation);
    } else {
        initJQueryValidation();
    }

    // Function to initialize form handlers
    function initializeFormHandlers() {
        console.log('Initializing form handlers');
        const loginForm = document.getElementById('loginFormModal');
        const registerForm = document.getElementById('registerFormModal');
        
        console.log('Login form found:', loginForm);
        console.log('Register form found:', registerForm);
        
        if (!loginForm || !registerForm) {
            console.warn('Forms not found, retrying...');
            setTimeout(initializeFormHandlers, 100);
            return;
        }
        
        // Disable HTML5 validation
        if (loginForm) {
            loginForm.setAttribute('novalidate', 'novalidate');
            console.log('Login form validation disabled');
        }
        if (registerForm) {
            registerForm.setAttribute('novalidate', 'novalidate');
            console.log('Register form validation disabled');
        }

        // Remove existing listeners to avoid duplicates
        const newLoginForm = loginForm.cloneNode(true);
        loginForm.parentNode.replaceChild(newLoginForm, loginForm);
        const newRegisterForm = registerForm.cloneNode(true);
        registerForm.parentNode.replaceChild(newRegisterForm, registerForm);
        
        // Get fresh references
        const freshLoginForm = document.getElementById('loginFormModal');
        const freshRegisterForm = document.getElementById('registerFormModal');

        if (freshLoginForm) {
            console.log('Attaching submit handler to login form');
            freshLoginForm.addEventListener('submit', function(e) {
                console.log('Login form submit event triggered');
                e.preventDefault();
                console.log('Login form default prevented');
                
                // Get submit button and prevent double submission
                const submitBtn = document.getElementById('loginSubmitBtn');
                if (submitBtn.disabled) {
                    console.log('Form already submitting, ignoring duplicate submit');
                    return false;
                }
                
                // Disable button and show loading state
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Đang xử lý...';
                submitBtn.style.opacity = '0.7';
                
                const formData = new FormData(this);
                console.log('Login form data collected');
                
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                const tokenValue = token ? token.value : formData.get('__RequestVerificationToken');
                
                console.log('Login - Token found:', !!token);
                console.log('Login - Form action:', this.action);
                console.log('Login - Form data keys:', Array.from(formData.keys()));
                
                // Log all form data values (except password)
                formData.forEach((value, key) => {
                    if (key !== 'Password' && key !== '__RequestVerificationToken') {
                        console.log(`Login - ${key}:`, value);
                    }
                });
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    console.log('Login response status:', response.status);
                    console.log('Login response redirected:', response.redirected);
                    console.log('Login response URL:', response.url);
                    
                    if (response.redirected) {
                        console.log('Redirecting to:', response.url);
                        window.location.href = response.url;
                        return;
                    }
                    // Check if response is JSON (success case)
                    const contentType = response.headers.get("content-type");
                    console.log('Login response content-type:', contentType);
                    
                    if (contentType && contentType.includes("application/json")) {
                        return response.json().then(json => {
                            console.log('Login JSON response:', json);
                            return json;
                        });
                    }
                    // Otherwise return text for error handling
                    return response.text().then(text => {
                        console.log('Login text response:', text.substring(0, 200));
                        return text;
                    });
                })
                .then(data => {
                    console.log('Login final data:', data);
                    if (data && data.success && data.redirectUrl) {
                        // Success: redirect to the URL
                        console.log('Redirecting to:', data.redirectUrl);
                        window.location.href = data.redirectUrl;
                    } else if (data && data.errors) {
                        // Handle JSON validation errors from server
                        console.log('Validation errors:', data.errors);
                        console.log('Validation errors details:', JSON.stringify(data.errors));
                        
                        // Clear previous errors
                        const errorMessages = freshLoginForm.querySelectorAll('.auth-error-message');
                        errorMessages.forEach(msg => {
                            msg.textContent = '';
                            msg.style.display = 'none';
                        });
                        
                        // Display new errors
                        Object.keys(data.errors).forEach(key => {
                            console.log('Processing error for key:', key, 'value:', data.errors[key]);
                            
                            // Handle general error message (empty key)
                            if (key === '' || key === 'general') {
                                const generalError = document.getElementById('loginGeneralError');
                                if (generalError) {
                                    const errorMessage = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                    generalError.textContent = errorMessage;
                                    generalError.style.display = 'block';
                                }
                                return;
                            }
                            
                            const fieldName = key.split('.').pop(); // Get field name after '.'
                            console.log('Looking for field:', fieldName);
                            const input = freshLoginForm.querySelector(`[name="${fieldName}"]`);
                            console.log('Found input:', input);
                            
                            if (input) {
                                // Try multiple ways to find the error container
                                let errorContainer = null;
                                
                                // Method 1: Next sibling after parent (input-wrapper)
                                const wrapper = input.parentElement;
                                if (wrapper && wrapper.classList.contains('auth-input-wrapper')) {
                                    errorContainer = wrapper.nextElementSibling;
                                }
                                
                                // Method 2: Look in parent form-group
                                if (!errorContainer || !errorContainer.classList.contains('auth-error-message')) {
                                    const formGroup = input.closest('.auth-form-group');
                                    if (formGroup) {
                                        errorContainer = formGroup.querySelector('.auth-error-message');
                                    }
                                }
                                
                                console.log('Found error container:', errorContainer);
                                
                                if (errorContainer && errorContainer.classList.contains('auth-error-message')) {
                                    const errorMessage = Array.isArray(data.errors[key]) ? data.errors[key][0] : data.errors[key];
                                    errorContainer.textContent = errorMessage;
                                    errorContainer.style.display = 'block';
                                    console.log('Set error message:', errorMessage);
                                } else {
                                    console.warn('Could not find error container for field:', fieldName);
                                }
                            } else {
                                console.warn('Could not find input for field:', fieldName);
                            }
                        });
                    } else if (typeof data === 'string') {
                        // Error: update modal content (HTML response)
                        console.log('Updating login form with HTML errors');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = data;
                        const newForm = tempDiv.querySelector('form');
                        if (newForm) {
                            freshLoginForm.innerHTML = newForm.innerHTML;
                            // Re-initialize form handlers after updating form
                            setTimeout(initializeFormHandlers, 100);
                        }
                    } else {
                        console.error('Unexpected login response:', data);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                })
                .finally(() => {
                    // Re-enable button after request completes
                    const submitBtn = document.getElementById('loginSubmitBtn');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Đăng nhập';
                        submitBtn.style.opacity = '1';
                    }
                });
            });
        }

        if (freshRegisterForm) {
            console.log('Attaching submit handler to register form');
            // Clear validation messages when form is opened
            function clearValidationMessages() {
                const errorMessages = freshRegisterForm.querySelectorAll('.auth-error-message');
                errorMessages.forEach(msg => {
                    msg.textContent = '';
                    msg.style.display = 'none';
                });
                const inputs = freshRegisterForm.querySelectorAll('.auth-form-control');
                inputs.forEach(input => {
                    input.classList.remove('input-validation-error');
                });
            }

            // Clear messages when modal opens
            const registerModal = document.getElementById('registerModal');
            if (registerModal) {
                const observer = new MutationObserver(function(mutations) {
                    if (registerModal.style.display === 'flex') {
                        clearValidationMessages();
                    }
                });
                observer.observe(registerModal, { attributes: true, attributeFilter: ['style'] });
            }

            freshRegisterForm.addEventListener('submit', function(e) {
                console.log('Register form submit event triggered');
                e.preventDefault();
                console.log('Register form default prevented');
                
                // Clear previous validation messages
                clearValidationMessages();
                
                const formData = new FormData(freshRegisterForm);
                console.log('Register form data collected');
                
                // Get anti-forgery token
                const token = freshRegisterForm.querySelector('input[name="__RequestVerificationToken"]');
                const tokenValue = token ? token.value : formData.get('__RequestVerificationToken');
                
                console.log('Register - Token found:', !!token);
                console.log('Register - Form action:', freshRegisterForm.action);
                console.log('Register - Form data keys:', Array.from(formData.keys()));
                
                // Log all form data values (except password)
                formData.forEach((value, key) => {
                    if (key !== 'Password' && key !== 'ConfirmPassword' && key !== '__RequestVerificationToken') {
                        console.log(`Register - ${key}:`, value);
                    }
                });
                
                fetch(freshRegisterForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    console.log('Register response status:', response.status);
                    console.log('Register response redirected:', response.redirected);
                    console.log('Register response URL:', response.url);
                    
                    if (response.redirected) {
                        console.log('Redirecting to:', response.url);
                        window.location.href = response.url;
                        return;
                    }
                    // Check if response is JSON (success case)
                    const contentType = response.headers.get("content-type");
                    console.log('Register response content-type:', contentType);
                    
                    if (contentType && contentType.includes("application/json")) {
                        return response.json().then(json => {
                            console.log('Register JSON response:', json);
                            return json;
                        });
                    }
                    // Otherwise return text for error handling
                    return response.text().then(text => {
                        console.log('Register text response:', text.substring(0, 200));
                        return text;
                    });
                })
                .then(data => {
                    console.log('Register final data:', data);
                    if (data && data.success && data.redirectUrl) {
                        // Success: redirect to the URL
                        console.log('Redirecting to:', data.redirectUrl);
                        window.location.href = data.redirectUrl;
                    } else if (data && data.errors) {
                        // Handle JSON validation errors from server
                        console.log('Validation errors:', data.errors);
                        
                        // Clear previous errors
                        const errorMessages = freshRegisterForm.querySelectorAll('.auth-error-message');
                        errorMessages.forEach(msg => {
                            msg.textContent = '';
                            msg.style.display = 'none';
                        });
                        
                        // Display new errors
                        Object.keys(data.errors).forEach(key => {
                            const fieldName = key.split('.').pop(); // Get field name after '.'
                            const input = freshRegisterForm.querySelector(`[name="${fieldName}"]`);
                            if (input) {
                                // Find the error message container for this input
                                let errorContainer = input.parentElement.parentElement.querySelector('.auth-error-message');
                                if (!errorContainer) {
                                    errorContainer = input.closest('.auth-form-group').querySelector('.auth-error-message');
                                }
                                if (errorContainer) {
                                    errorContainer.textContent = data.errors[key][0]; // Show first error
                                    errorContainer.style.display = 'block';
                                }
                            }
                        });
                        
                        // Re-initialize password strength checker if password field was touched
                        setTimeout(function() {
                            if (typeof initPasswordStrengthCheckerModal === 'function') {
                                initPasswordStrengthCheckerModal();
                            }
                        }, 100);
                    } else if (typeof data === 'string') {
                        // Error: update modal content (HTML response)
                        console.log('Updating register form with HTML errors');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = data;
                        const newForm = tempDiv.querySelector('form');
                        if (newForm) {
                            // Preserve current form values before replacing
                            const currentData = new FormData(freshRegisterForm);
                            
                            freshRegisterForm.innerHTML = newForm.innerHTML;
                            
                            // Restore form values
                            currentData.forEach((value, key) => {
                                const input = freshRegisterForm.querySelector(`[name="${key}"]`);
                                if (input && input.type !== 'hidden') {
                                    input.value = value;
                                }
                            });
                            
                            // Show only validation messages that have content
                            const errorMessages = freshRegisterForm.querySelectorAll('.auth-error-message');
                            errorMessages.forEach(msg => {
                                if (msg.textContent.trim()) {
                                    msg.style.display = 'block';
                                } else {
                                    msg.style.display = 'none';
                                }
                            });
                            
                            // Re-initialize form handlers after updating form
                            setTimeout(initializeFormHandlers, 100);
                            
                            // Re-initialize password strength checker
                            setTimeout(function() {
                                if (typeof initPasswordStrengthCheckerModal === 'function') {
                                    initPasswordStrengthCheckerModal();
                                }
                            }, 100);
                        }
                    } else {
                        console.error('Unexpected response:', data);
                        alert('Có lỗi xảy ra khi đăng ký. Vui lòng thử lại.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi đăng ký: ' + error.message);
                });
            });
        }
    }
    
    // Initialize form handlers when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeFormHandlers);
    } else {
        initializeFormHandlers();
    }

    // Check login before ordering
    function checkLoginAndOrder(itemName, price) {
        var isAuthenticated = @(User.Identity.IsAuthenticated ? "true" : "false");
        var userRole = '@(Session["UserRole"] as string ?? "")';
        
        if (isAuthenticated && userRole !== '') {
            // User is logged in, redirect to user area
            window.location.href = '@Url.Action("Index", "Home", new { area = "User_65133141" })';
        } else {
            // User is not logged in, show login modal
            alert('Vui lòng đăng nhập để đặt món!');
            openLoginModal();
        }
    }
</script>

@section scripts {
    <script>
        // Ensure jQuery is loaded before running jQuery-dependent code
        (function() {
            function waitForJQuery(callback) {
                if (typeof jQuery !== 'undefined') {
                    callback();
                } else {
                    setTimeout(function() {
                        waitForJQuery(callback);
                    }, 50);
                }
            }
            
            waitForJQuery(function() {
                // Disable jQuery Validate for modal forms
                if (jQuery.validator) {
                    jQuery.validator.setDefaults({
                        ignore: ".ignore-validation"
                    });
                }
            });
            
            // Auto-open modal based on URL hash
            function checkHashAndOpenModal() {
                const hash = window.location.hash;
                if (hash === '#openLoginModal') {
                    openLoginModal();
                    // Remove hash from URL after opening
                    history.replaceState(null, null, ' ');
                } else if (hash === '#openRegisterModal') {
                    openRegisterModal();
                    // Remove hash from URL after opening
                    history.replaceState(null, null, ' ');
                }
            }
            
            // Check on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkHashAndOpenModal);
            } else {
                checkHashAndOpenModal();
            }
        })();
    </script>
}
